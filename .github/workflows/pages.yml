name: Deploy to GitHub Pages

on:
  push:
    branches: [main, master, work, 'claude/**']
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create pages directory
        run: |
          # Deploy the VIB3+ visualizations and test pages
          mkdir -p _site/docs/vib3-exports

          # Disable Jekyll processing (required for ES module paths)
          touch _site/.nojekyll

          # Root index (redirects to site/index.html)
          cp index.html _site/

          # Landing page (site/ directory — the main marketing page)
          cp -r site/ _site/site/

          # SDK demo page
          cp -r demo/ _site/demo/ 2>/dev/null || true

          # Legacy v2 landing page
          cp index-v2.html _site/ 2>/dev/null || true

          # Gallery, WebGPU live page, test hub, and all standalone visualizations
          cp docs/.nojekyll _site/docs/ 2>/dev/null || true
          cp docs/index.html _site/docs/
          cp docs/*.html _site/docs/ 2>/dev/null || true

          # 9 shader export visualizations
          cp docs/vib3-exports/*.html _site/docs/vib3-exports/

          # E2E test harness (for manual testing on devices)
          mkdir -p _site/tests
          cp tests/e2e-harness.html _site/tests/ 2>/dev/null || true

          # Agent config docs + CLAUDE.md (for download buttons on landing page)
          cp -r agent-config/ _site/agent-config/ 2>/dev/null || true
          cp CLAUDE.md _site/ 2>/dev/null || true

          # VIB3+ Creative Engine demos
          mkdir -p _site/demos
          cp examples/vib3-create-demos/index.html _site/demos/ 2>/dev/null || true

          # Landing page JS modules (index.html imports ./js/landing/main.js)
          # Landing page JS modules (legacy — index-v2.html imports ./js/landing/main.js)
          mkdir -p _site/js
          cp -r js/landing _site/js/ 2>/dev/null || true

          # Source modules (needed by site/, demo/, WebGPU live page, and test harness)
          # The live page imports ES modules from ../src/ relative to docs/ and site/
          cp -r src/ _site/src/

          # Example pages (layer dynamics demo, standalone demos)
          cp -r examples/ _site/examples/

          # Dogfood landing page (links to samsung-tv + flutter-viz demos)
          cp -r dogfood/ _site/dogfood/ 2>/dev/null || true

          # C++ WASM core (needed by SDK runtime)
          cp -r cpp/ _site/cpp/ 2>/dev/null || true

          echo "=== Deployed files ==="
          find _site -name "*.html" | sort
          echo "Total HTML files: $(find _site -name '*.html' | wc -l)"
          echo ""
          echo "=== Landing Page ==="
          ls -la _site/site/index.html 2>/dev/null && echo "Landing page: OK" || echo "Landing page: MISSING"
          ls -la _site/site/js/ 2>/dev/null && echo "Landing JS: OK" || echo "Landing JS: MISSING"
          ls -la _site/site/styles/ 2>/dev/null && echo "Landing styles: OK" || echo "Landing styles: MISSING"
          echo ""
          echo "=== Demo Page ==="
          ls -la _site/demo/index.html 2>/dev/null && echo "Demo page: OK" || echo "Demo page: MISSING"
          echo ""
          echo "=== WebGPU Live Page ==="
          ls -la _site/docs/webgpu-live.html 2>/dev/null && echo "WebGPU live page: OK" || echo "WebGPU live page: MISSING"
          echo ""
          echo "=== Examples ==="
          ls _site/examples/*.html 2>/dev/null && echo "Examples: OK" || echo "Examples: MISSING"
          echo "Source modules: $(find _site/src -name '*.js' | wc -l) JS files"
          echo ""
          echo "=== Dogfood Demos ==="
          ls -la _site/dogfood/index.html 2>/dev/null && echo "Dogfood landing: OK" || echo "Dogfood landing: MISSING"
          ls -la _site/examples/dogfood/samsung-tv/index.html 2>/dev/null && echo "Samsung TV: OK" || echo "Samsung TV: MISSING"
          ls -la _site/examples/dogfood/flutter-viz/assets/vib3_visualization.html 2>/dev/null && echo "Flutter Viz: OK" || echo "Flutter Viz: MISSING"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Publish link map to job summary
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
        run: |
          cat <<MARKDOWN >> "$GITHUB_STEP_SUMMARY"
          ## ✅ GitHub Pages deployment ready

          Use these links for review and QA:

          - Landing page: ${PAGE_URL}/site/
          - Root index redirect: ${PAGE_URL}/
          - Legacy landing: ${PAGE_URL}/index-v2.html
          - Docs index: ${PAGE_URL}/docs/
          - WebGPU live: ${PAGE_URL}/docs/webgpu-live.html
          - Examples root: ${PAGE_URL}/examples/
          - Codex hub: ${PAGE_URL}/examples/codex/
          - Synesthesia example: ${PAGE_URL}/examples/codex/synesthesia/
          - Narrative Scroll example: ${PAGE_URL}/examples/codex/narrative-scroll/
          - VIB3 demos index: ${PAGE_URL}/demos/
          - Dogfood index: ${PAGE_URL}/dogfood/
          - Samsung TV demo: ${PAGE_URL}/examples/dogfood/samsung-tv/
          - Flutter Viz page: ${PAGE_URL}/examples/dogfood/flutter-viz/assets/vib3_visualization.html
          - Test harness: ${PAGE_URL}/tests/e2e-harness.html
          MARKDOWN
