name: GPU Visual Regression Tests

# Runs visual regression tests on a GPU-enabled self-hosted runner.
# This workflow captures actual WebGL/WebGPU rendered output for comparison.
#
# Requirements for self-hosted runner:
#   - NVIDIA GPU (T4, V100, or similar)
#   - NVIDIA drivers 525+ with Vulkan support
#   - Docker with NVIDIA Container Toolkit (optional, for containerized runs)
#   - Node.js 18+ and pnpm 9+
#
# Setup: scripts/setup-gpu-testing.sh

on:
  push:
    branches: [main, master, 'claude/**']
    paths:
      - 'src/**'
      - 'docs/**'
      - 'tests/visual-regression.spec.js'
      - 'tests/comprehensive-e2e.spec.js'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      update_baselines:
        description: 'Update visual baselines (will overwrite existing)'
        required: false
        type: boolean
        default: false

jobs:
  # ---- Job 1: Standard headless E2E (runs on any runner) ----
  headless-e2e:
    name: Headless E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run comprehensive E2E tests
        run: npx playwright test tests/comprehensive-e2e.spec.js
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: headless-e2e-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # ---- Job 2: GPU visual regression (requires self-hosted GPU runner) ----
  gpu-visual-regression:
    name: GPU Visual Regression
    runs-on: [self-hosted, gpu]  # Requires a self-hosted runner with 'gpu' label
    timeout-minutes: 30
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Verify GPU availability
        run: |
          echo "=== GPU Status ==="
          nvidia-smi || echo "WARNING: nvidia-smi not found"
          echo ""
          echo "=== Vulkan Status ==="
          vulkaninfo --summary 2>/dev/null || echo "WARNING: vulkaninfo not found"
          echo ""
          echo "=== Chrome GPU flags will be applied ==="

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Restore visual baselines
        uses: actions/cache@v4
        with:
          path: tests/visual-baselines
          key: visual-baselines-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            visual-baselines-${{ github.ref_name }}-
            visual-baselines-main-

      - name: Run GPU visual regression tests
        run: npx playwright test tests/visual-regression.spec.js
        env:
          CI: true
          VIB3_GPU: '1'
          TMPDIR: /tmp

      - name: Run comprehensive E2E with GPU
        run: npx playwright test tests/comprehensive-e2e.spec.js
        env:
          CI: true
          VIB3_GPU: '1'
          TMPDIR: /tmp

      - name: Save visual baselines
        if: github.event.inputs.update_baselines == 'true' || github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: tests/visual-baselines
          key: visual-baselines-${{ github.ref_name }}-${{ github.sha }}

      - name: Upload GPU test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gpu-visual-results
          path: |
            test-results/
            test-results/visual/
            tests/visual-baselines/
            playwright-report/
          retention-days: 30

      - name: Upload visual baselines
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-baselines
          path: tests/visual-baselines/
          retention-days: 90

      - name: Comment PR with visual results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'test-results/visual/visual-summary.json';
            let report = {};
            try {
              report = JSON.parse(fs.readFileSync(reportPath, 'utf-8'));
            } catch { report = { error: 'No visual summary found' }; }

            const body = [
              '## üé® Visual Regression Results',
              '',
              `| Metric | Value |`,
              `|--------|-------|`,
              `| GPU Mode | ${report.gpuEnabled ? '‚úÖ Enabled' : '‚ö†Ô∏è Disabled'} |`,
              `| Screenshots | ${report.screenshotsCaptures || 0} |`,
              `| Baselines | ${report.baselinesStored || 0} |`,
              `| Gallery Tests | ${report.galleryVisualizationsTested || 0} |`,
              `| Shader Exports | ${report.shaderExportsTested || 0} |`,
              '',
              'See workflow artifacts for full screenshots and reports.',
            ].join('\n');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
