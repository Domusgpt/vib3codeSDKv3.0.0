<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIB3+ Layer Dynamics Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            min-height: 100vh;
        }
        .header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,255,136,0.2);
            background: rgba(0,0,0,0.9);
        }
        .logo { font-size: 20px; font-weight: bold; color: #00FF88; letter-spacing: 2px; }
        .subtitle { font-size: 11px; color: rgba(255,255,255,0.4); }
        .audio-btn {
            padding: 6px 12px;
            border: 1px solid rgba(0,255,136,0.3);
            border-radius: 4px;
            background: rgba(0,255,136,0.1);
            color: #00FF88;
            font-size: 11px;
            cursor: pointer;
        }
        .audio-btn:hover { background: rgba(0,255,136,0.25); }

        .main { display: flex; gap: 12px; padding: 12px; height: calc(100vh - 50px); }

        /* Canvas stack — the REAL holographic 5-layer WebGL render target */
        .canvas-area {
            flex: 1;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .canvas-area canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100% !important;
            height: 100% !important;
        }
        #holo-background-canvas { z-index: 1; }
        #holo-shadow-canvas { z-index: 2; }
        #holo-content-canvas { z-index: 3; }
        #holo-highlight-canvas { z-index: 4; }
        #holo-accent-canvas { z-index: 5; }

        .layer-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            z-index: 10;
            font-size: 10px;
            color: rgba(255,255,255,0.3);
            pointer-events: none;
        }

        /* Controls panel */
        .controls {
            width: 320px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .panel {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px;
        }
        .panel h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #00FF88;
            margin-bottom: 8px;
        }
        .btn-row { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
        .btn {
            padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
            color: #ccc;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn:hover { background: rgba(0,255,136,0.15); border-color: #00FF88; color: #fff; }
        .btn.active { background: rgba(0,255,136,0.2); border-color: #00FF88; color: #00FF88; }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .slider-row label {
            font-size: 10px;
            width: 70px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
        }
        .slider-row input[type="range"] {
            flex: 1;
            accent-color: #00FF88;
        }
        .slider-row .val {
            font-size: 10px;
            width: 40px;
            text-align: right;
            color: #00FF88;
            font-family: monospace;
        }

        select {
            width: 100%;
            padding: 6px 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            color: #ccc;
            font-size: 11px;
            margin-bottom: 8px;
        }
        select option { background: #1a1a2e; }

        .status-bar {
            font-size: 10px;
            color: rgba(255,255,255,0.3);
            padding: 4px 0;
            border-top: 1px solid rgba(255,255,255,0.05);
            margin-top: 4px;
        }
        .status-bar .highlight { color: #00FF88; }

        #log {
            font-family: monospace;
            font-size: 10px;
            max-height: 120px;
            overflow-y: auto;
            color: rgba(255,255,255,0.4);
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <span class="logo">VIB3+</span>
            <span class="subtitle">Layer Dynamics Demo</span>
        </div>
        <button class="audio-btn" id="audioToggle">Enable Audio</button>
    </div>

    <div class="main">
        <!-- 5-layer WebGL canvas stack — RealHolographicSystem renders here -->
        <div class="canvas-area" id="holographicLayers">
            <canvas id="holo-background-canvas"></canvas>
            <canvas id="holo-shadow-canvas"></canvas>
            <canvas id="holo-content-canvas"></canvas>
            <canvas id="holo-highlight-canvas"></canvas>
            <canvas id="holo-accent-canvas"></canvas>
            <div class="layer-label" id="layerStatus">Initializing...</div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <!-- Geometry selector -->
            <div class="panel">
                <h3>Geometry</h3>
                <div class="btn-row" id="geoBtns">
                    <button class="btn active" data-geo="0">Tetra</button>
                    <button class="btn" data-geo="1">Hyper</button>
                    <button class="btn" data-geo="2">Sphere</button>
                    <button class="btn" data-geo="3">Torus</button>
                    <button class="btn" data-geo="4">Klein</button>
                    <button class="btn" data-geo="5">Fractal</button>
                    <button class="btn" data-geo="6">Wave</button>
                    <button class="btn" data-geo="7">Crystal</button>
                </div>
            </div>

            <!-- Profile selector -->
            <div class="panel">
                <h3>Layer Profile</h3>
                <div class="btn-row" id="profileBtns">
                    <button class="btn active" data-profile="holographic">Holographic</button>
                    <button class="btn" data-profile="symmetry">Symmetry</button>
                    <button class="btn" data-profile="chord">Chord</button>
                    <button class="btn" data-profile="storm">Storm</button>
                    <button class="btn" data-profile="legacy">Legacy</button>
                </div>
                <div class="status-bar">
                    Active: <span class="highlight" id="activeProfile">holographic</span>
                    | Keystone: <span class="highlight" id="activeKeystone">content</span>
                </div>
            </div>

            <!-- Per-layer relationships -->
            <div class="panel">
                <h3>Layer Relationships</h3>
                <div id="layerControls"></div>
            </div>

            <!-- Tune active layer -->
            <div class="panel">
                <h3>Tune Layer</h3>
                <select id="tuneLayer">
                    <option value="background">Background</option>
                    <option value="shadow">Shadow</option>
                    <option value="highlight" selected>Highlight</option>
                    <option value="accent">Accent</option>
                </select>
                <div class="slider-row">
                    <label>Opacity</label>
                    <input type="range" id="tuneOpacity" min="0" max="1" step="0.01" value="0.5">
                    <span class="val" id="tuneOpacityVal">0.50</span>
                </div>
                <div class="slider-row">
                    <label>Gain</label>
                    <input type="range" id="tuneGain" min="0" max="10" step="0.1" value="2.0">
                    <span class="val" id="tuneGainVal">2.0</span>
                </div>
                <div class="slider-row">
                    <label>Hue Shift</label>
                    <input type="range" id="tuneHue" min="0" max="360" step="1" value="137">
                    <span class="val" id="tuneHueVal">137</span>
                </div>
                <div class="slider-row">
                    <label>Speed</label>
                    <input type="range" id="tuneSpeed" min="0.05" max="2" step="0.05" value="0.5">
                    <span class="val" id="tuneSpeedVal">0.50</span>
                </div>
                <div class="slider-row">
                    <label>Lerp Rate</label>
                    <input type="range" id="tuneLerp" min="0.01" max="1" step="0.01" value="0.1">
                    <span class="val" id="tuneLerpVal">0.10</span>
                </div>
            </div>

            <!-- Keystone parameters (drives all layers through the relationship graph) -->
            <div class="panel">
                <h3>Keystone Parameters</h3>
                <div class="slider-row">
                    <label>Hue</label>
                    <input type="range" id="paramHue" min="0" max="360" step="1" value="320">
                    <span class="val" id="paramHueVal">320</span>
                </div>
                <div class="slider-row">
                    <label>Saturation</label>
                    <input type="range" id="paramSaturation" min="0" max="1" step="0.01" value="0.8">
                    <span class="val" id="paramSaturationVal">0.80</span>
                </div>
                <div class="slider-row">
                    <label>Density</label>
                    <input type="range" id="paramDensity" min="0.3" max="4" step="0.1" value="1.0">
                    <span class="val" id="paramDensityVal">1.0</span>
                </div>
                <div class="slider-row">
                    <label>Speed</label>
                    <input type="range" id="paramSpeed" min="0.1" max="3" step="0.1" value="0.5">
                    <span class="val" id="paramSpeedVal">0.50</span>
                </div>
                <div class="slider-row">
                    <label>Chaos</label>
                    <input type="range" id="paramChaos" min="0" max="1" step="0.01" value="0.2">
                    <span class="val" id="paramChaosVal">0.20</span>
                </div>
                <div class="slider-row">
                    <label>Morph</label>
                    <input type="range" id="paramMorph" min="0" max="2" step="0.01" value="0.5">
                    <span class="val" id="paramMorphVal">0.50</span>
                </div>
                <div class="slider-row">
                    <label>Intensity</label>
                    <input type="range" id="paramIntensity" min="0" max="1" step="0.01" value="0.6">
                    <span class="val" id="paramIntensityVal">0.60</span>
                </div>
                <div class="slider-row">
                    <label>Rot4D XW</label>
                    <input type="range" id="paramRot4dXW" min="0" max="6.28" step="0.01" value="0">
                    <span class="val" id="paramRot4dXWVal">0.00</span>
                </div>
                <div class="slider-row">
                    <label>Rot4D YW</label>
                    <input type="range" id="paramRot4dYW" min="0" max="6.28" step="0.01" value="0">
                    <span class="val" id="paramRot4dYWVal">0.00</span>
                </div>
                <div class="slider-row">
                    <label>Rot4D ZW</label>
                    <input type="range" id="paramRot4dZW" min="0" max="6.28" step="0.01" value="0">
                    <span class="val" id="paramRot4dZWVal">0.00</span>
                </div>
            </div>

            <!-- Reactivity modulation -->
            <div class="panel">
                <h3>Reactivity Modulation</h3>
                <div class="btn-row" id="modulationBtns">
                    <button class="btn active" data-mod="none">None</button>
                    <button class="btn" data-mod="audioStorm">Audio Storm</button>
                    <button class="btn" data-mod="audioPulse">Audio Pulse</button>
                    <button class="btn" data-mod="tiltHarmonic">Tilt Harmonic</button>
                    <button class="btn" data-mod="mouseChase">Mouse Chase</button>
                    <button class="btn" data-mod="fullReactive">Full Reactive</button>
                </div>
                <div class="status-bar">
                    Modulation: <span class="highlight" id="activeModulation">none</span>
                </div>
            </div>

            <!-- Log output -->
            <div class="panel">
                <h3>Debug Log</h3>
                <div id="log"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the REAL holographic system and layer dynamics
        import { RealHolographicSystem } from '../src/holograms/RealHolographicSystem.js';
        import { LayerRelationshipGraph, PROFILES, PRESET_REGISTRY, LAYER_ORDER } from '../src/render/LayerRelationshipGraph.js';
        import { LayerPresetManager } from '../src/render/LayerPresetManager.js';
        import { LayerReactivityBridge, MODULATION_PROFILES } from '../src/render/LayerReactivityBridge.js';

        // ====================================================================
        // Debug log
        // ====================================================================
        const logEl = document.getElementById('log');
        function log(msg) {
            const line = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            logEl.textContent = line + logEl.textContent;
            if (logEl.textContent.length > 3000) {
                logEl.textContent = logEl.textContent.slice(0, 3000);
            }
        }

        // ====================================================================
        // Initialize the REAL holographic system (5 WebGL layers)
        // ====================================================================
        const system = new RealHolographicSystem();
        const layerCount = system.visualizers.length;
        document.getElementById('layerStatus').textContent =
            `${layerCount}/5 WebGL layers active`;
        log(`RealHolographicSystem initialized: ${layerCount} WebGL visualizers`);

        // Access the system's layer relationship graph
        const graph = system.layerGraph;
        const presetManager = new LayerPresetManager(graph);
        const reactivityBridge = new LayerReactivityBridge(graph, presetManager);

        log(`Layer graph ready — profile: ${graph.activeProfile}, keystone: ${graph.keystone}`);

        // ====================================================================
        // Mouse tracking on the canvas area (drives holographic mouse reactivity)
        // ====================================================================
        const canvasArea = document.getElementById('holographicLayers');
        canvasArea.addEventListener('mousemove', (e) => {
            const rect = canvasArea.getBoundingClientRect();
            const mx = (e.clientX - rect.left) / rect.width;
            const my = (e.clientY - rect.top) / rect.height;
            system.visualizers.forEach(v => {
                v.mouseX = mx;
                v.mouseY = my;
                v.mouseIntensity = Math.min(1.0, v.mouseIntensity + 0.05);
            });
        });
        canvasArea.addEventListener('mouseleave', () => {
            system.visualizers.forEach(v => { v.mouseIntensity = 0; });
        });
        canvasArea.addEventListener('click', () => {
            system.visualizers.forEach(v => { v.clickIntensity = 1.0; });
        });

        // ====================================================================
        // Geometry buttons
        // ====================================================================
        document.getElementById('geoBtns').addEventListener('click', (e) => {
            const btn = e.target.closest('[data-geo]');
            if (!btn) return;
            const geo = parseInt(btn.dataset.geo);

            system.setVariant(geo);
            log(`Geometry: ${system.getVariantName(geo)} (variant ${geo})`);

            document.querySelectorAll('#geoBtns .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });

        // ====================================================================
        // Profile buttons
        // ====================================================================
        document.getElementById('profileBtns').addEventListener('click', (e) => {
            const btn = e.target.closest('[data-profile]');
            if (!btn) return;
            const profile = btn.dataset.profile;

            system.loadRelationshipProfile(profile);
            log(`Loaded profile: ${profile}`);

            document.querySelectorAll('#profileBtns .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.getElementById('activeProfile').textContent = profile;
            document.getElementById('activeKeystone').textContent = graph.keystone;
            updateLayerControlsUI();
        });

        // ====================================================================
        // Per-layer relationship controls
        // ====================================================================
        function updateLayerControlsUI() {
            const container = document.getElementById('layerControls');
            container.innerHTML = '';
            const config = graph.exportConfig();

            for (const layer of LAYER_ORDER) {
                if (layer === graph.keystone) continue;
                const rel = config.relationships[layer];
                const preset = rel ? rel.preset : 'none';

                const row = document.createElement('div');
                row.style.cssText = 'display:flex;align-items:center;gap:6px;margin-bottom:4px;';
                row.innerHTML = `
                    <span style="font-size:10px;width:70px;color:rgba(255,255,255,0.5)">${layer}</span>
                    <select data-layer="${layer}" style="flex:1;padding:3px 4px;font-size:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:3px;color:#ccc;">
                        ${Object.keys(PRESET_REGISTRY).map(p =>
                            `<option value="${p}" ${p === preset ? 'selected' : ''} style="background:#1a1a2e">${p}</option>`
                        ).join('')}
                    </select>
                `;
                container.appendChild(row);
            }

            container.querySelectorAll('select').forEach(sel => {
                sel.addEventListener('change', () => {
                    const layer = sel.dataset.layer;
                    const preset = sel.value;
                    system.setLayerRelationship(layer, preset);
                    log(`Set ${layer} → ${preset}`);
                    document.getElementById('activeProfile').textContent = graph.activeProfile || 'custom';
                });
            });
        }

        updateLayerControlsUI();

        // ====================================================================
        // Tune sliders — hot-patch layer relationship configs
        // ====================================================================
        const tuneSliders = ['Opacity', 'Gain', 'Hue', 'Speed', 'Lerp'];
        const tuneKeyMap = {
            Opacity: 'opacity', Gain: 'gain', Hue: 'hueAngle', Speed: 'speedRatio', Lerp: 'lerpRate'
        };

        tuneSliders.forEach(name => {
            const slider = document.getElementById('tune' + name);
            const valEl = document.getElementById('tune' + name + 'Val');
            slider.addEventListener('input', () => {
                const val = parseFloat(slider.value);
                valEl.textContent = val.toFixed(name === 'Hue' ? 0 : 2);

                const layer = document.getElementById('tuneLayer').value;
                const key = tuneKeyMap[name];
                presetManager.tune(layer, { [key]: val });
                log(`Tune ${layer}.${key} = ${val}`);
            });
        });

        // ====================================================================
        // Keystone parameter sliders — these drive the REAL system
        // ====================================================================
        const paramMap = {
            paramHue: 'hue',
            paramSaturation: 'saturation',
            paramDensity: 'density',
            paramSpeed: 'speed',
            paramChaos: 'chaos',
            paramMorph: 'morph',
            paramIntensity: 'intensity',
            paramRot4dXW: 'rot4dXW',
            paramRot4dYW: 'rot4dYW',
            paramRot4dZW: 'rot4dZW'
        };

        for (const [id, key] of Object.entries(paramMap)) {
            const slider = document.getElementById(id);
            const valEl = document.getElementById(id + 'Val');
            slider.addEventListener('input', () => {
                const val = parseFloat(slider.value);
                const isAngle = key.startsWith('rot4d');
                valEl.textContent = val.toFixed(key === 'hue' ? 0 : 2);

                // Push parameter directly to the holographic system
                // updateParameters routes through the LayerRelationshipGraph
                system.updateParameters({ [key]: val });
            });
        }

        // ====================================================================
        // Reactivity modulation — simulated input drives layer relationships
        // ====================================================================
        let modulationActive = false;
        let modulationRafId = null;

        function modulationLoop() {
            if (!modulationActive) return;

            const t = performance.now();
            const fakeInput = {
                audio: {
                    bass: 0.3 + 0.3 * Math.sin(t * 0.002),
                    mid: 0.2 + 0.2 * Math.sin(t * 0.003),
                    high: 0.15 + 0.15 * Math.sin(t * 0.005)
                },
                tilt: {
                    alpha: 15 * Math.sin(t * 0.001),
                    beta: 10 * Math.cos(t * 0.0015),
                    gamma: 20 * Math.sin(t * 0.0008)
                },
                mouse: {
                    x: 0.5 + 0.3 * Math.sin(t * 0.0005),
                    y: 0.5 + 0.3 * Math.cos(t * 0.0007)
                }
            };

            reactivityBridge.update(fakeInput);
            modulationRafId = requestAnimationFrame(modulationLoop);
        }

        document.getElementById('modulationBtns').addEventListener('click', (e) => {
            const btn = e.target.closest('[data-mod]');
            if (!btn) return;
            const mod = btn.dataset.mod;

            document.querySelectorAll('#modulationBtns .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (mod === 'none') {
                modulationActive = false;
                if (modulationRafId) cancelAnimationFrame(modulationRafId);
                reactivityBridge.clearModulations();
                reactivityBridge.deactivate();
                log('Modulation disabled');
            } else {
                reactivityBridge.loadModulationProfile(mod);
                reactivityBridge.activate();
                modulationActive = true;
                modulationLoop();
                log(`Modulation: ${mod} (${reactivityBridge.mappings.length} mappings)`);
            }

            document.getElementById('activeModulation').textContent = mod;
        });

        // ====================================================================
        // Audio toggle — enable real microphone input
        // ====================================================================
        let audioActive = false;
        document.getElementById('audioToggle').addEventListener('click', async () => {
            const btn = document.getElementById('audioToggle');
            if (!audioActive) {
                await system.initAudio();
                audioActive = true;
                btn.textContent = 'Disable Audio';
                btn.style.borderColor = '#ff4444';
                btn.style.color = '#ff4444';
                log('Microphone audio enabled');
            } else {
                system.disableAudio();
                audioActive = false;
                btn.textContent = 'Enable Audio';
                btn.style.borderColor = 'rgba(0,255,136,0.3)';
                btn.style.color = '#00FF88';
                log('Audio disabled');
            }
        });

        // ====================================================================
        // Summary
        // ====================================================================
        log(`Profiles: ${Object.keys(PROFILES).join(', ')}`);
        log(`Presets: ${Object.keys(PRESET_REGISTRY).join(', ')}`);
        log(`Modulations: ${Object.keys(MODULATION_PROFILES).join(', ')}`);
        log(`System: RealHolographicSystem with ${layerCount} WebGL visualizers`);
    </script>
</body>
</html>
