/**
 * Boss Battle VFX Pipeline — Generated by /vib3-create skill
 *
 * Demonstrates dynamic game VFX that respond to gameplay events using
 * VIB3+ MCP tools + Three.js ShaderMaterial integration.
 *
 * Usage:
 *   import { BossBattleVFX } from './boss-battle-vfx.js';
 *   const vfx = new BossBattleVFX(engine);  // VIB3Engine instance
 *   vfx.start();
 *   vfx.onDamage(25);       // 25 damage hit
 *   vfx.setHealth(0.5);     // 50% health
 *   vfx.phaseChange(2);     // Enter phase 2
 *   vfx.victory();          // Boss defeated
 */

// ── MCP Tool Call Sequences ──────────────────────────────────────────
// These are the exact MCP tool calls this pipeline would issue in Live Mode.
// In Artifact Mode, use these as the config objects to apply programmatically.

export const BOSS_BATTLE_INIT = {
    tool: 'batch_set_parameters',
    args: {
        system: 'quantum',
        geometry: 21,  // hypertetra + fractal = angular + recursive
        rotation: { XW: 0.5, ZW: 1.8, YW: 0.0 },
        visual: {
            hue: 0,
            chaos: 0.6,
            intensity: 0.8,
            gridDensity: 40,
            speed: 1.2,
            morphFactor: 0.0,
            saturation: 0.85,
            dimension: 3.3
        },
        preset: 'cinematic'
    }
};

export const BOSS_ROTATION_TIMELINE = {
    tool: 'create_timeline',
    args: {
        bpm: null,
        loop: true,
        tracks: [
            {
                parameter: 'rot4dXW',
                keyframes: [
                    { time: 0, value: 0, easing: 'linear' },
                    { time: 10000, value: 6.2831853, easing: 'linear' }
                ]
            },
            {
                parameter: 'rot4dZW',
                keyframes: [
                    { time: 0, value: 0, easing: 'linear' },
                    { time: 15000, value: 6.2831853, easing: 'linear' }
                ]
            }
        ]
    }
};

export const BOSS_AUDIO_CONFIG = [
    {
        tool: 'configure_audio_band',
        args: {
            band: 'bass',
            enabled: true,
            sensitivity: 2.0,
            targets: [
                { param: 'morphFactor', weight: 0.6, mode: 'add' },
                { param: 'chaos', weight: 0.3, mode: 'add' }
            ]
        }
    },
    {
        tool: 'configure_audio_band',
        args: {
            band: 'mid',
            enabled: true,
            sensitivity: 1.5,
            targets: [
                { param: 'rot4dXW', weight: 0.4, mode: 'add' }
            ]
        }
    },
    {
        tool: 'configure_audio_band',
        args: {
            band: 'high',
            enabled: true,
            sensitivity: 1.0,
            targets: [
                { param: 'gridDensity', weight: 0.2, mode: 'multiply' },
                { param: 'intensity', weight: 0.15, mode: 'add' }
            ]
        }
    }
];

// ── Phase Definitions ────────────────────────────────────────────────

export const BOSS_PHASES = {
    phase1: {
        system: 'quantum',
        geometry: 21,           // hypertetra + fractal
        visual: { hue: 0, chaos: 0.6, gridDensity: 40, dimension: 3.3 },
        rotation: { XW: 0.5, ZW: 1.8 },
        description: 'dark aggressive crystalline — angular recursive patterns'
    },
    phase2: {
        system: 'holographic',
        geometry: 13,           // hypersphere + fractal
        visual: { hue: 280, chaos: 0.8, gridDensity: 60, dimension: 3.1 },
        rotation: { XW: 1.2, YW: 0.8, ZW: 2.4 },
        description: 'void ethereal fractured — 5-layer glassmorphic chaos'
    },
    phase3: {
        system: 'quantum',
        geometry: 20,           // hypertetra + klein bottle
        visual: { hue: 15, chaos: 1.0, gridDensity: 80, dimension: 3.0 },
        rotation: { XW: 2.0, YW: 1.5, ZW: 3.0 },
        description: 'enraged non-orientable — maximum distortion Klein surface'
    }
};

// ── Damage Flash Transition ──────────────────────────────────────────

export const DAMAGE_FLASH = {
    tool: 'play_transition',
    args: {
        steps: [
            {
                params: { chaos: 1.0, intensity: 1.0, speed: 3.0 },
                duration: 150,
                easing: 'easeIn'
            },
            {
                params: { chaos: 0.6, intensity: 0.8, speed: 1.2 },
                duration: 350,
                easing: 'easeOut'
            }
        ]
    }
};

// ── Victory Sequence ─────────────────────────────────────────────────

export const VICTORY_SEQUENCE = {
    tool: 'play_transition',
    args: {
        steps: [
            {
                params: {
                    hue: 50, saturation: 1.0, intensity: 1.0,
                    chaos: 0.0, speed: 0.5, gridDensity: 15
                },
                duration: 2000,
                easing: 'easeInOut'
            },
            {
                params: {
                    hue: 50, intensity: 0.0
                },
                duration: 3000,
                easing: 'easeOut'
            }
        ]
    }
};

// ── Runtime Controller Class ─────────────────────────────────────────

export class BossBattleVFX {
    constructor(engine) {
        this.engine = engine;
        this.currentPhase = 1;
        this.health = 1.0;
    }

    /** Initialize the boss battle visual state */
    start() {
        const init = BOSS_BATTLE_INIT.args;
        this.engine.switchSystem(init.system);
        this.engine.setParameter('geometry', init.geometry);
        for (const [plane, value] of Object.entries(init.rotation)) {
            this.engine.setParameter(`rot4d${plane}`, value);
        }
        for (const [param, value] of Object.entries(init.visual)) {
            this.engine.setParameter(param, value);
        }
    }

    /** Map boss health (0-1) to morphFactor (0=healthy → 2=dying) */
    setHealth(healthPercent) {
        this.health = Math.max(0, Math.min(1, healthPercent));
        const morphFactor = (1 - this.health) * 2;
        this.engine.setParameter('morphFactor', morphFactor);
        // Increase chaos as health drops
        const baseChaos = BOSS_PHASES[`phase${this.currentPhase}`]?.visual.chaos ?? 0.6;
        this.engine.setParameter('chaos', baseChaos + (1 - this.health) * 0.4);
    }

    /** Flash on damage hit — chaos spike 0→1→0 over 500ms */
    onDamage(amount) {
        const steps = DAMAGE_FLASH.args.steps;
        if (this.engine.transition) {
            this.engine.transition.play(steps);
        } else {
            // Manual fallback: spike and decay
            this.engine.setParameter('chaos', 1.0);
            this.engine.setParameter('intensity', 1.0);
            setTimeout(() => {
                this.engine.setParameter('chaos', BOSS_PHASES[`phase${this.currentPhase}`]?.visual.chaos ?? 0.6);
                this.engine.setParameter('intensity', 0.8);
            }, 500);
        }
    }

    /** Switch visual phase (1, 2, or 3) */
    phaseChange(phase) {
        const def = BOSS_PHASES[`phase${phase}`];
        if (!def) return;
        this.currentPhase = phase;
        this.engine.switchSystem(def.system);
        this.engine.setParameter('geometry', def.geometry);
        for (const [param, value] of Object.entries(def.visual)) {
            this.engine.setParameter(param, value);
        }
        for (const [plane, value] of Object.entries(def.rotation)) {
            this.engine.setParameter(`rot4d${plane}`, value);
        }
    }

    /** Victory animation — bright flash then fade to black */
    victory() {
        const steps = VICTORY_SEQUENCE.args.steps;
        if (this.engine.transition) {
            this.engine.transition.play(steps);
        } else {
            this.engine.setParameter('hue', 50);
            this.engine.setParameter('intensity', 1.0);
            this.engine.setParameter('chaos', 0.0);
        }
    }
}

// ── Three.js ShaderMaterial Config ───────────────────────────────────
// For embedding boss VFX directly in a Three.js game scene.

export const THREEJS_BOSS_MATERIAL_CONFIG = {
    system: 'quantum',
    transparent: true,
    depthWrite: false,
    depthTest: true,
    width: 1024,
    height: 1024,
    initialParams: {
        geometry: 21,
        hue: 0,
        chaos: 0.6,
        intensity: 0.8,
        gridDensity: 40,
        speed: 1.2,
        morphFactor: 0.0,
        saturation: 0.85,
        dimension: 3.3,
        rot4dXW: 0.5,
        rot4dZW: 1.8,
        mouseIntensity: 0,
        clickIntensity: 0,
        bass: 0, mid: 0, high: 0
    }
};

/**
 * Usage with Three.js:
 *
 *   import { Vib3ThreeJsPackage } from '@vib3/integrations';
 *   import { THREEJS_BOSS_MATERIAL_CONFIG, BossBattleVFX } from './boss-battle-vfx.js';
 *
 *   const config = Vib3ThreeJsPackage.getShaderMaterial(THREEJS_BOSS_MATERIAL_CONFIG);
 *   const material = new THREE.ShaderMaterial(config);
 *   const mesh = new THREE.Mesh(new THREE.PlaneGeometry(4, 4), material);
 *   scene.add(mesh);
 *
 *   // Animation loop
 *   function animate() {
 *       config.update(performance.now());
 *       config.setParameter('morphFactor', (1 - bossHealth) * 2);
 *       renderer.render(scene, camera);
 *   }
 */
