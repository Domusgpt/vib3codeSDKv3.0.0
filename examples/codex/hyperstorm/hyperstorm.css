/* ================================================================
   HYPERSTORM — VIB3+ Premium Codex Entry
   Mobile-First CSS  |  CSSBridge-Driven  |  Gold Standard v3

   Architecture:
     All UI colors derive from VIB3+ CSS custom properties set by
     the premium CSSBridge module (or a JS fallback when premium
     is unavailable). This creates a living UI that breathes with
     the visualization — chaos affects blur, hue shifts dock color,
     intensity modulates glow.

   Container Requirements:
     #vib3-container MUST have:
       1. position: relative or fixed (canvases are position:absolute)
       2. Non-zero width and height (canvases inherit 100%)
       3. overflow: hidden (prevents bleed)
     CanvasManager will auto-fix position:static, but best practice
     is to set it explicitly here. See CLAUDE.md gotchas #17-21.

   [WHY] External CSS, not inline:
     Codex examples are reference implementations. Agents and
     developers copy them verbatim. Inline styles on the container
     div hide the critical positioning requirement where no one
     reads it. This stylesheet documents every layout decision.
   ================================================================ */


/* ── CSS Custom Properties ──
   [WHY] Default values: CSSBridge writes these every frame when active.
   When premium is unavailable, JS fallback (updateCSSVars) writes them.
   Either way, these defaults prevent unstyled flash on first paint.
   Values are 0-1 normalized (hue is 0-1, not 0-360) to match CSSBridge output. */

:root {
    --vib3-hue: 0.55;
    --vib3-intensity: 0.7;
    --vib3-chaos: 0.15;
    --vib3-speed: 0.3;
    --vib3-saturation: 0.7;
    --vib3-grid-density: 0.27;
    --vib3-morph-factor: 0.25;
    --vib3-dimension: 0.33;

    /* [WHY] Safe area insets: env() reads the device notch/home-bar insets.
       Fallback to 0px for devices without notches. Used by dock and HUD. */
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-top: env(safe-area-inset-top, 0px);
}


/* ── Reset ── */

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: #000;
    color: white;
    font-family: -apple-system, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
    overflow: hidden;

    /* [WHY] touch-action:none — we handle ALL gestures in JS (tap, hold, swipe,
       pinch, two-finger). Without this, the browser intercepts pinch-to-zoom,
       pull-to-refresh, and swipe-to-navigate, all of which conflict with our
       gesture system. */
    touch-action: none;

    /* [WHY] Prevent text selection and tap highlight on mobile.
       The entire UI is interactive — accidental selection breaks the experience. */
    -webkit-user-select: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;

    /* [WHY] overscroll-behavior:none kills pull-to-refresh on Chrome Android
       and rubber-band bounce on iOS Safari, both of which interrupt the viz. */
    overscroll-behavior: none;
}


/* ── VIB3+ Canvas Container ──
   [WHY] position:fixed + inset:0 makes the container fill the viewport edge-to-edge,
   including behind the notch on iOS when viewport-fit=cover is set.
   CanvasManager creates 5 position:absolute canvases inside this div.
   Without a positioned parent, those canvases escape the container and render
   relative to <body>, often producing invisible zero-size results.
   See: CLAUDE.md "Rendering Quick Start" and Gotcha #17. */

#vib3-container {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    z-index: 0;
}


/* ── HUD — Compact Top Bar ──
   [WHY] pointer-events:none on the wrapper: the HUD sits over the canvas but
   shouldn't block touch gestures. Only the toggle button gets pointer-events:all. */

#hud {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding-top: var(--safe-top);
    z-index: 30;
    pointer-events: none;

    /* [WHY] backdrop-filter modulated by chaos: higher chaos = more blur = more
       visual instability reflected in the UI chrome itself. Ties the HUD to the
       visualization state — Gold Standard "living UI" principle. */
    backdrop-filter: blur(calc(6px + var(--vib3-chaos) * 8px));
    background: rgba(0, 0, 0, calc(0.5 + var(--vib3-chaos) * 0.15));

    /* [WHY] Border color derived from hue+intensity: subtle at rest, visible
       during intense moments. Creates visual continuity between viz and chrome. */
    border-bottom: 1px solid hsla(
        calc(var(--vib3-hue) * 360), 50%, 50%,
        calc(0.08 + var(--vib3-intensity) * 0.12)
    );
}

.hud-top {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    gap: 10px;
}

/* [WHY] Title color = hue-derived: the word "HYPERSTORM" shifts color with
   the visualization. Text-shadow modulated by chaos for glow during chaos bursts. */
.hud-title {
    font-size: 14px;
    font-weight: 800;
    letter-spacing: 3px;
    color: hsl(calc(var(--vib3-hue) * 360), 80%, calc(60% + var(--vib3-intensity) * 20%));
    text-shadow:
        0 0 calc(var(--vib3-chaos) * 15px) hsla(calc(var(--vib3-hue) * 360), 80%, 50%, calc(var(--vib3-chaos) * 0.7));
}

.hud-system {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 2px;
    padding: 2px 8px;
    border-radius: 4px;
    background: hsla(calc(var(--vib3-hue) * 360), 30%, 25%, 0.4);
    border: 1px solid hsla(calc(var(--vib3-hue) * 360), 40%, 40%, 0.3);
    color: hsl(calc(var(--vib3-hue) * 360), 50%, 70%);
}

/* [WHY] pointer-events:all only on toggle button — rest of HUD is passthrough.
   This is the only interactive element in the HUD. */
.hud-toggle {
    margin-left: auto;
    pointer-events: all;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid hsla(calc(var(--vib3-hue) * 360), 40%, 40%, 0.3);
    background: hsla(calc(var(--vib3-hue) * 360), 20%, 15%, 0.5);
    color: hsl(calc(var(--vib3-hue) * 360), 50%, 70%);
    font-size: 13px;
    font-weight: 700;
    font-style: italic;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
}

/* [WHY] Detail panel hidden by default on mobile — screen real estate is precious.
   Toggled open via JS (adds .open class). Desktop shows it by default (media query below). */
.hud-detail {
    display: none;
    padding: 8px 16px 12px;
    gap: 3px;
    flex-direction: column;
}

.hud-detail.open {
    display: flex;
}

.hud-row {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    font-family: 'SF Mono', 'Fira Code', monospace;
}

.rlabel {
    opacity: 0.35;
    letter-spacing: 1px;
    font-size: 10px;
}

/* [WHY] tabular-nums: prevents value text from jumping around as numbers change.
   Monospace digits = stable layout during real-time parameter updates. */
.rval {
    font-variant-numeric: tabular-nums;
    color: hsl(calc(var(--vib3-hue) * 360), 50%, 70%);
}

/* [WHY] Trigger dots: Gold Standard Mode 2 visual feedback.
   Each dot represents a named trigger (chaos_burst, intensity_flash, etc.).
   Fires = bright glow. At rest = dim circle. The dots give users immediate
   feedback that the event choreography system is active and responding. */
.trigger-dots {
    display: flex;
    gap: 8px;
    padding-top: 6px;
    justify-content: center;
}

.tdot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.12);
    transition: all 0.15s;
}

.tdot.fired {
    background: hsl(calc(var(--vib3-hue) * 360), 90%, 60%);
    box-shadow:
        0 0 6px hsl(calc(var(--vib3-hue) * 360), 80%, 50%),
        0 0 14px hsla(calc(var(--vib3-hue) * 360), 60%, 50%, 0.5);
}


/* ── Touch Dock — Fat Finger Friendly ──
   [WHY] Horizontally scrollable row at the bottom of the screen.
   60px min-width per button: iOS Human Interface Guidelines recommend
   44pt minimum touch targets. We go larger because these are primary controls.
   scroll-snap: buttons snap to center on scroll release. */

#dock {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 30;
    padding: 8px 8px calc(8px + var(--safe-bottom));
    display: flex;
    gap: 6px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x proximity;
    scrollbar-width: none;

    /* [WHY] Same chaos-modulated backdrop as HUD — visual consistency. */
    backdrop-filter: blur(calc(6px + var(--vib3-chaos) * 8px));
    background: rgba(0, 0, 0, calc(0.5 + var(--vib3-chaos) * 0.15));
    border-top: 1px solid hsla(
        calc(var(--vib3-hue) * 360), 50%, 50%,
        calc(0.08 + var(--vib3-intensity) * 0.12)
    );
}

#dock::-webkit-scrollbar { display: none; }

.dock-btn {
    flex: 0 0 auto;
    scroll-snap-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    min-width: 60px;
    height: 56px;
    padding: 6px 10px;
    border-radius: 12px;
    border: 1px solid hsla(calc(var(--vib3-hue) * 360), 35%, 35%, 0.25);
    background: hsla(calc(var(--vib3-hue) * 360), 15%, 12%, 0.5);
    color: hsl(calc(var(--vib3-hue) * 360), 45%, 72%);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.1s, background 0.15s, border-color 0.15s;
}

/* [WHY] :active gives immediate press feedback without waiting for JS.
   scale(0.92) is subtle enough to not feel sluggish but visible enough
   to confirm the tap registered. Critical for perceived responsiveness. */
.dock-btn:active {
    transform: scale(0.92);
    background: hsla(calc(var(--vib3-hue) * 360), 40%, 25%, 0.7);
    border-color: hsla(calc(var(--vib3-hue) * 360), 60%, 50%, 0.5);
}

/* [WHY] Toggle state for fly-through and storm modes.
   Persistent glow tells the user the mode is still active.
   Toggled via JS: btn.classList.toggle('active-toggle', isActive). */
.dock-btn.active-toggle {
    background: hsla(calc(var(--vib3-hue) * 360), 50%, 30%, 0.6);
    border-color: hsla(calc(var(--vib3-hue) * 360), 70%, 55%, 0.6);
    box-shadow: 0 0 10px hsla(calc(var(--vib3-hue) * 360), 60%, 50%, 0.2);
}

.dock-icon {
    font-size: 20px;
    line-height: 1;
}

.dock-label {
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1px;
    opacity: 0.7;
}


/* ── Gesture Hint ──
   [WHY] Educational overlay for first-time users. pointer-events:none so it
   doesn't intercept taps. Fades via CSS transition when JS adds .hidden class. */

#gesture-hint {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 25;
    text-align: center;
    font-size: 11px;
    line-height: 1.6;
    padding: 10px 18px;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.5);
    opacity: 1;
    transition: opacity 2s;
    pointer-events: none;
}

#gesture-hint.hidden {
    opacity: 0;
}


/* ── Error Overlay ──
   [WHY] Visible-to-agents error display. Agents running headless or in CI need
   to see init failures without opening DevTools. Hidden by default; JS shows it
   by setting display:block and writing the error message. Centered, high z-index,
   monospace for stack traces. */

#error-overlay {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 999;
    background: rgba(0, 0, 0, 0.9);
    color: #f44;
    padding: 24px;
    border-radius: 12px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 13px;
    max-width: 90vw;
    white-space: pre-wrap;
}


/* ── Atmospheric Effects ── */

/* [WHY] Breathing vignette: radial gradient darkens edges. Intensity modulates
   the darkness — during intense moments the vignette lifts, during calm it
   deepens. Creates natural focus toward the center of the visualization. */
body::after {
    content: '';
    position: fixed;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    background: radial-gradient(
        ellipse at center,
        transparent 40%,
        rgba(0, 0, 0, calc(0.3 + var(--vib3-intensity) * 0.15)) 100%
    );
}

/* [WHY] CRT-style scanlines: chaos modulates opacity. At chaos=0 they're nearly
   invisible (0.25 opacity). At chaos=1 they're pronounced (0.60 opacity).
   Ties the physical display aesthetic to the mathematical chaos parameter.
   4px period chosen to be visible on 2x displays without being distracting. */
body::before {
    content: '';
    position: fixed;
    inset: 0;
    z-index: 2;
    pointer-events: none;
    background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, calc(0.02 + var(--vib3-chaos) * 0.04)) 2px,
        rgba(0, 0, 0, calc(0.02 + var(--vib3-chaos) * 0.04)) 4px
    );
    opacity: calc(0.25 + var(--vib3-chaos) * 0.35);
}


/* ── Desktop (768px+) ──
   [WHY] Larger dock buttons, auto-expand HUD detail panel, hide gesture hint
   (desktop users have keyboard shortcuts: b/c/p/f/d/s/space/x). */

@media (min-width: 768px) {
    .dock-btn {
        min-width: 72px;
        height: 60px;
        padding: 8px 14px;
    }

    .dock-icon { font-size: 22px; }
    .dock-label { font-size: 9px; }

    #dock {
        justify-content: center;
        padding: 10px 16px calc(10px + var(--safe-bottom));
    }

    .hud-detail {
        display: flex;
    }

    #gesture-hint { display: none; }
}


/* ── Landscape Phone ──
   [WHY] Compact dock for phones in landscape — limited vertical space.
   Buttons shrink to 44px height (minimum iOS touch target). */

@media (max-height: 500px) and (orientation: landscape) {
    #dock {
        padding: 4px 8px calc(4px + var(--safe-bottom));
    }

    .dock-btn {
        min-width: 52px;
        height: 44px;
    }

    .dock-icon { font-size: 16px; }
    .dock-label { font-size: 7px; }
}
