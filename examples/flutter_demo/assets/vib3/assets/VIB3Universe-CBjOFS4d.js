import{P as A,R as M,F as _,Q as P}from"./FacetedSystem-PaU9wK_B.js";class k{constructor(){this.entities=new Map,this.nextEntityId=1,this.time=0,this.lastFrameTime=0,this.paused=!1,this.eventBus=new EventTarget,this.tick=this.tick.bind(this)}start(){this.running||(this.running=!0,this.lastFrameTime=performance.now(),requestAnimationFrame(this.tick),console.log("VIB3Orchestrator: Universe started."))}stop(){this.running=!1,console.log("VIB3Orchestrator: Universe stopped.")}spawn(e,t={}){const i=`vib3_entity_${this.nextEntityId++}`,s={id:i,type:e,config:t,position:t.position||{x:0,y:0,z:0},rotation:t.rotation||{x:0,y:0,z:0,w:0},active:!0,engine:{setParameter:(a,r)=>console.log(`[${i}] set ${a}=${r}`),getParameter:a=>0},update:a=>{}};return this.entities.set(i,s),this.emit("entitySpawned",{id:i,type:e}),console.log(`VIB3Orchestrator: Spawned ${e} (${i})`),i}kill(e){if(this.entities.has(e)){const t=this.entities.get(e);t.destroy&&t.destroy(),this.entities.delete(e),this.emit("entityDespawned",{id:e}),console.log(`VIB3Orchestrator: Killed entity ${e}`)}}tick(e){if(!this.running)return;const t=(e-this.lastFrameTime)/1e3;this.lastFrameTime=e,this.time+=t,this.entities.forEach(i=>{i.active&&i.update&&i.update(this.time,t)}),requestAnimationFrame(this.tick)}emit(e,t){const i=new CustomEvent(e,{detail:t});this.eventBus.dispatchEvent(i)}on(e,t){this.eventBus.addEventListener(e,i=>t(i.detail))}}class T{constructor(e="vib3-universe"){this.containerId=e,this.layers=[],this.activeInstances=new Map,typeof document<"u"&&(this.container=document.getElementById(e),this.container||(this.container=document.createElement("div"),this.container.id=e,this.container.style.position="relative",this.container.style.width="100vw",this.container.style.height="100vh",this.container.style.overflow="hidden",document.body.appendChild(this.container)))}addInstance(e,t,i={}){if(this.activeInstances.has(e)){console.warn(`VIB3Compositor: Instance ${e} already registered.`);return}t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",this.updateLayer(e,i),this.container.appendChild(t),this.activeInstances.set(e,t),this.layers.push(e),console.log(`VIB3Compositor: Added instance ${e}`)}removeInstance(e){if(this.activeInstances.has(e)){const t=this.activeInstances.get(e);t.parentNode&&t.parentNode.removeChild(t),this.activeInstances.delete(e),this.layers=this.layers.filter(i=>i!==e),console.log(`VIB3Compositor: Removed instance ${e}`)}}updateLayer(e,t){const i=this.activeInstances.get(e);i&&(t.zIndex!==void 0&&(i.style.zIndex=t.zIndex),t.blendMode!==void 0&&(i.style.mixBlendMode=t.blendMode),t.opacity!==void 0&&(i.style.opacity=t.opacity),t.visible!==void 0&&(i.style.display=t.visible?"block":"none"),t.maskImage&&(i.style.webkitMaskImage=`url(${t.maskImage})`,i.style.maskImage=`url(${t.maskImage})`))}setLayerOrder(e){e.forEach((t,i)=>{this.updateLayer(t,{zIndex:i})}),this.layers=e}clear(){this.activeInstances.forEach((e,t)=>{e.parentNode&&e.parentNode.removeChild(e)}),this.activeInstances.clear(),this.layers=[]}}let x=0;class C{constructor(e,t=null){if(typeof e!="function")throw new Error("TransitionAnimator requires a parameterUpdateFn callback");this.updateParameter=e,this.getParameter=typeof t=="function"?t:null,this.activeTransitions=new Map,this.sequences=[],this._frameId=null,this._knownValues={},this.easingFunctions=this._buildEasingFunctions()}transition(e,t=1e3,i="easeInOut",s=null,a=null){if(!e||typeof e!="object")return console.warn("TransitionAnimator: params must be an object"),null;const r=`transition_${++x}`,c={};for(const d of Object.keys(e))c[d]=this._getCurrentValue(d);const o={id:r,fromValues:c,toValues:{...e},startTime:performance.now(),duration:Math.max(0,t),easing:this.easingFunctions[i]?i:"easeInOut",onComplete:typeof s=="function"?s:null,onUpdate:typeof a=="function"?a:null,cancelled:!1};return this.activeTransitions.set(r,o),this._ensureAnimating(),r}transitionTo(e,t=1e3,i="easeInOut",s=null){return this.transition(e,t,i,s)}sequence(e,t=null){if(!Array.isArray(e)||e.length===0)return console.warn("TransitionAnimator: sequence requires a non-empty array of steps"),null;const i=`sequence_${++x}`,s={id:i,steps:e.map(a=>({params:{...a.params},duration:a.duration!=null?a.duration:1e3,easing:a.easing||"easeInOut",delay:a.delay||0})),currentIndex:0,onComplete:typeof t=="function"?t:null};return this.sequences.push(s),this._runNextSequenceStep(s),i}cancel(e){const t=this.activeTransitions.get(e);if(t)return t.cancelled=!0,this.activeTransitions.delete(e),!0;const i=this.sequences.findIndex(s=>s.id===e);if(i>=0){this.sequences[i];for(const[s,a]of this.activeTransitions)s.startsWith(e+"_step_")&&(a.cancelled=!0,this.activeTransitions.delete(s));return this.sequences.splice(i,1),!0}return!1}cancelAll(){for(const[,e]of this.activeTransitions)e.cancelled=!0;this.activeTransitions.clear(),this.sequences.length=0,this._frameId!==null&&(cancelAnimationFrame(this._frameId),this._frameId=null)}isAnimating(){return this.activeTransitions.size>0||this.sequences.length>0}getActiveCount(){return this.activeTransitions.size}getEasingNames(){return Object.keys(this.easingFunctions)}dispose(){this.cancelAll(),this._knownValues={}}_ensureAnimating(){this._frameId===null&&(this._frameId=requestAnimationFrame(()=>this._tick()))}_tick(){this._frameId=null;const e=performance.now(),t=[];for(const[i,s]of this.activeTransitions){if(s.cancelled){t.push(i);continue}const a=e-s.startTime,r=s.duration>0?Math.min(a/s.duration,1):1,o=(this.easingFunctions[s.easing]||this.easingFunctions.linear)(r);for(const d of Object.keys(s.toValues)){const b=s.fromValues[d],I=s.toValues[d];let f;d==="hue"?f=this._lerpHue(b,I,o):f=b+(I-b)*o,this.updateParameter(d,f),this._knownValues[d]=f}s.onUpdate&&s.onUpdate(r),r>=1&&t.push(i)}for(const i of t){const s=this.activeTransitions.get(i);this.activeTransitions.delete(i),s&&!s.cancelled&&s.onComplete&&s.onComplete()}this.activeTransitions.size>0&&(this._frameId=requestAnimationFrame(()=>this._tick()))}_runNextSequenceStep(e){if(e.currentIndex>=e.steps.length){const a=this.sequences.indexOf(e);a>=0&&this.sequences.splice(a,1),e.onComplete&&e.onComplete();return}const t=e.steps[e.currentIndex],i=`${e.id}_step_${e.currentIndex}`,s=()=>{const a={};for(const c of Object.keys(t.params))a[c]=this._getCurrentValue(c);const r={id:i,fromValues:a,toValues:{...t.params},startTime:performance.now(),duration:Math.max(0,t.duration),easing:this.easingFunctions[t.easing]?t.easing:"easeInOut",onComplete:()=>{e.currentIndex++,this._runNextSequenceStep(e)},onUpdate:null,cancelled:!1};this.activeTransitions.set(i,r),this._ensureAnimating()};t.delay>0?setTimeout(s,t.delay):s()}_getCurrentValue(e){if(this.getParameter){const t=this.getParameter(e);if(typeof t=="number"&&Number.isFinite(t))return t}if(e in this._knownValues)return this._knownValues[e];for(const[,t]of this.activeTransitions)if(e in t.toValues)return t.toValues[e];return this._getDefaultValue(e)}_getDefaultValue(e){const t={hue:200,saturation:.8,intensity:.5,speed:1,chaos:.2,morphFactor:1,gridDensity:15,dimension:3.5,geometry:0,rot4dXY:0,rot4dXZ:0,rot4dYZ:0,rot4dXW:0,rot4dYW:0,rot4dZW:0};return t[e]!==void 0?t[e]:0}_lerpHue(e,t,i){let s=t-e;s>180&&(s-=360),s<-180&&(s+=360);let a=e+s*i;return a<0&&(a+=360),a>=360&&(a-=360),a}_buildEasingFunctions(){return{linear(e){return e},easeIn(e){return e*e*e},easeOut(e){return 1-Math.pow(1-e,3)},easeInOut(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2},easeInQuad(e){return e*e},easeOutQuad(e){return 1-(1-e)*(1-e)},bounce(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},elastic(e){if(e===0||e===1)return e;const t=2*Math.PI/3;return Math.pow(2,-10*e)*Math.sin((e*10-.75)*t)+1},cubic(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2},backOut(e){return 1+2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2)},backIn(e){return 2.70158*e*e*e-1.70158*e*e},expoOut(e){return e===1?1:1-Math.pow(2,-10*e)},expoIn(e){return e===0?0:Math.pow(2,10*e-10)},sineInOut(e){return-(Math.cos(Math.PI*e)-1)/2}}}}class E{constructor(e,t="neutral"){this.engine=e,this.id=`actor_${Math.random().toString(36).substr(2,9)}`,this.active=!0,this.emotion={valence:0,arousal:0},this.animator=new C((i,s)=>this.engine.setParameter(i,s),i=>this.engine.getParameter(i)),this.profile=typeof t=="string"?this._getProfile(t):t,this.reset()}update(e,t){if(!this.active)return;const i=Math.sin(e*2)*.1;this.engine.getParameter("morphFactor"),this.animator.isAnimating()||this.engine.setParameter("morphFactor",1+i)}emote(e,t=1,i=1e3){const s=this.profile.emotions[e];if(!s){console.warn(`VIB3Actor: Unknown emotion '${e}' for profile '${this.profile.name}'`);return}const a={};for(const[r,c]of Object.entries(s))a[r]=c;a.intensity&&(a.intensity*=t),a.speed&&(a.speed*=t),this.animator.transition(a,i,"easeOut"),this.emotion.lastEmote=e}reset(e=1e3){this.animator.transition(this.profile.base,e,"easeInOut")}_getProfile(e){const t={neutral:{name:"neutral",base:{hue:200,saturation:.5,intensity:.5,chaos:0,speed:1,gridDensity:20},emotions:{joy:{hue:50,saturation:1,intensity:.8,speed:2,chaos:.2},anger:{hue:0,saturation:1,intensity:.9,speed:3,chaos:.8},sadness:{hue:240,saturation:.2,intensity:.3,speed:.2,chaos:0},fear:{hue:280,saturation:.8,intensity:.6,speed:2.5,chaos:.9,gridDensity:50}}},heroic:{name:"heroic",base:{hue:210,saturation:.8,intensity:.7,chaos:.1,speed:1,gridDensity:15},emotions:{joy:{hue:50,saturation:1,intensity:1,speed:1.5,morphFactor:1.2},anger:{hue:20,saturation:1,intensity:1,speed:2.5,chaos:.5},determination:{hue:220,saturation:.9,intensity:.9,speed:1.2,gridDensity:10}}},glitch:{name:"glitch",base:{hue:120,saturation:0,intensity:.4,chaos:.5,speed:2,gridDensity:40},emotions:{panic:{hue:0,saturation:0,intensity:.9,speed:5,chaos:1,rot4dXW:1.5},calm:{hue:120,saturation:.5,intensity:.4,speed:.5,chaos:.2}}}};return t[e]||t.neutral}}class F{constructor(e="vib3-container"){this.containerId=e,this.container=typeof document<"u"?document.getElementById(e):null,this.currentSystem=null,this.createdCanvases=[],this.registeredContexts=new Map}createSystemCanvases(e){this._removeCreatedCanvases();const t=this._getCanvasIdsForSystem(e);if(this.container){const i=this.container.clientWidth||(typeof window<"u"?window.innerWidth:800),s=this.container.clientHeight||(typeof window<"u"?window.innerHeight:600),a=typeof window<"u"?Math.min(window.devicePixelRatio||1,2):1;t.forEach((r,c)=>{const o=document.createElement("canvas");o.id=r,o.className="visualization-canvas",o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.zIndex=String(c+1),o.width=i*a,o.height=s*a,this.container.appendChild(o),this.createdCanvases.push(o)})}return this.currentSystem=e,t}registerContext(e,t){this.registeredContexts.set(e,t)}destroy(){for(const[,e]of this.registeredContexts)try{const t=e.getExtension("WEBGL_lose_context");t&&t.loseContext()}catch{}this.registeredContexts.clear(),this._removeCreatedCanvases(),this.currentSystem=null}_removeCreatedCanvases(){for(const e of this.createdCanvases)e.remove();this.createdCanvases=[]}_getCanvasIdsForSystem(e){const t=["background-canvas","shadow-canvas","content-canvas","highlight-canvas","accent-canvas"];switch(e){case"faceted":return t;case"quantum":return t.map(i=>`quantum-${i}`);case"holographic":return t.map(i=>`holo-${i}`);case"polychora":return t.map(i=>`polychora-${i}`);default:return t}}}const p=["rot4dXY","rot4dXZ","rot4dYZ","rot4dXW","rot4dYW","rot4dZW","gridDensity","morphFactor","chaos","speed","hue","intensity","saturation","dimension","geometry"],y=["bass","mid","high"],w=["add","multiply","replace","max","min"],u={mouse:["rotation","velocity","shimmer","attract","repel","none"],click:["burst","blast","ripple","pulse","none"],scroll:["cycle","wave","sweep","zoom","morph","none"]},v={version:"1.0",audio:{enabled:!1,globalSensitivity:1,smoothing:.8,bands:{bass:{enabled:!0,sensitivity:1.5,frequencyRange:[20,250],targets:[{param:"morphFactor",weight:.8,mode:"add"},{param:"intensity",weight:.3,mode:"multiply"}]},mid:{enabled:!0,sensitivity:1,frequencyRange:[250,2e3],targets:[{param:"chaos",weight:.5,mode:"add"}]},high:{enabled:!0,sensitivity:.8,frequencyRange:[2e3,2e4],targets:[{param:"speed",weight:.4,mode:"add"},{param:"hue",weight:15,mode:"add"}]}}},tilt:{enabled:!1,sensitivity:1,smoothing:.1,dramaticMode:!1,calibrated:!1,calibrationOffset:{alpha:0,beta:0,gamma:0},mappings:{alpha:{target:"rot4dXY",scale:.006,clamp:[-3.14,3.14]},beta:{target:"rot4dXW",scale:.01,clamp:[-1.5,1.5]},gamma:{target:"rot4dYW",scale:.015,clamp:[-1.5,1.5]}},dramaticMappings:{alpha:{target:"rot4dXY",scale:.048,clamp:[-6.28,6.28]},beta:{target:"rot4dXW",scale:.08,clamp:[-6,6]},gamma:{target:"rot4dYW",scale:.12,clamp:[-6,6]}}},interaction:{enabled:!0,mouse:{enabled:!0,mode:"rotation",sensitivity:1,smoothing:.15,targets:["rot4dXY","rot4dYZ"],invertX:!1,invertY:!1},click:{enabled:!0,mode:"burst",intensity:1,decay:.92,target:"morphFactor",maxValue:2},scroll:{enabled:!0,mode:"cycle",sensitivity:1,target:"geometry",wrap:!0,step:1},touch:{enabled:!0,multiTouchEnabled:!0,pinchZoom:{enabled:!0,target:"dimension",sensitivity:.01},twoFingerRotate:{enabled:!0,target:"rot4dZW",sensitivity:.02},swipeGestures:!0}}};class m{constructor(e=null){this.config=this.deepClone(v),e&&this.merge(e)}deepClone(e){return JSON.parse(JSON.stringify(e))}merge(e){return this.deepMerge(this.config,e),this}deepMerge(e,t){for(const i in t)t[i]&&typeof t[i]=="object"&&!Array.isArray(t[i])?(e[i]||(e[i]={}),this.deepMerge(e[i],t[i])):e[i]=t[i]}validate(){const e=[];if(this.config.audio){const t=this.config.audio;(typeof t.globalSensitivity!="number"||t.globalSensitivity<0||t.globalSensitivity>10)&&e.push("audio.globalSensitivity must be a number between 0 and 10");for(const i of y)if(t.bands&&t.bands[i]){const s=t.bands[i];if(s.targets)for(const a of s.targets)p.includes(a.param)||e.push(`audio.bands.${i}.targets: invalid parameter "${a.param}"`),w.includes(a.mode)||e.push(`audio.bands.${i}.targets: invalid mode "${a.mode}"`)}}if(this.config.tilt){const t=this.config.tilt;if((typeof t.sensitivity!="number"||t.sensitivity<.1||t.sensitivity>10)&&e.push("tilt.sensitivity must be a number between 0.1 and 10"),t.mappings)for(const i of["alpha","beta","gamma"])t.mappings[i]&&t.mappings[i].target&&(p.includes(t.mappings[i].target)||e.push(`tilt.mappings.${i}.target: invalid parameter`))}if(this.config.interaction){const t=this.config.interaction;t.mouse&&t.mouse.mode&&(u.mouse.includes(t.mouse.mode)||e.push(`interaction.mouse.mode: invalid mode "${t.mouse.mode}"`)),t.click&&t.click.mode&&(u.click.includes(t.click.mode)||e.push(`interaction.click.mode: invalid mode "${t.click.mode}"`)),t.scroll&&t.scroll.mode&&(u.scroll.includes(t.scroll.mode)||e.push(`interaction.scroll.mode: invalid mode "${t.scroll.mode}"`))}return{valid:e.length===0,errors:e}}getConfig(){return this.deepClone(this.config)}getAudioConfig(){return this.deepClone(this.config.audio)}getTiltConfig(){return this.deepClone(this.config.tilt)}getInteractionConfig(){return this.deepClone(this.config.interaction)}setAudioEnabled(e){return this.config.audio.enabled=!!e,this}setAudioBand(e,t){if(!y.includes(e))throw new Error(`Invalid audio band: ${e}`);return this.deepMerge(this.config.audio.bands[e],t),this}addAudioTarget(e,t,i=1,s="add"){if(!y.includes(e))throw new Error(`Invalid audio band: ${e}`);if(!p.includes(t))throw new Error(`Invalid parameter: ${t}`);if(!w.includes(s))throw new Error(`Invalid blend mode: ${s}`);return this.config.audio.bands[e].targets.push({param:t,weight:i,mode:s}),this}clearAudioTargets(e){if(!y.includes(e))throw new Error(`Invalid audio band: ${e}`);return this.config.audio.bands[e].targets=[],this}setTiltEnabled(e){return this.config.tilt.enabled=!!e,this}setTiltDramaticMode(e){return this.config.tilt.dramaticMode=!!e,this}setTiltSensitivity(e){return this.config.tilt.sensitivity=Math.max(.1,Math.min(10,e)),this}setTiltMapping(e,t,i,s=null){if(!["alpha","beta","gamma"].includes(e))throw new Error(`Invalid axis: ${e}`);if(!p.includes(t))throw new Error(`Invalid parameter: ${t}`);return this.config.tilt.mappings[e]={target:t,scale:i,clamp:s||[-6.28,6.28]},this}setInteractionEnabled(e){return this.config.interaction.enabled=!!e,this}setMouseMode(e,t={}){if(!u.mouse.includes(e))throw new Error(`Invalid mouse mode: ${e}`);return this.config.interaction.mouse.mode=e,this.deepMerge(this.config.interaction.mouse,t),this}setClickMode(e,t={}){if(!u.click.includes(e))throw new Error(`Invalid click mode: ${e}`);return this.config.interaction.click.mode=e,this.deepMerge(this.config.interaction.click,t),this}setScrollMode(e,t={}){if(!u.scroll.includes(e))throw new Error(`Invalid scroll mode: ${e}`);return this.config.interaction.scroll.mode=e,this.deepMerge(this.config.interaction.scroll,t),this}toJSON(){return JSON.stringify(this.config,null,2)}static fromJSON(e){const t=typeof e=="string"?JSON.parse(e):e;return new m(t)}toMinimalJSON(){const e={},t=v;return this.extractDifferences(this.config,t,e),JSON.stringify(e,null,2)}extractDifferences(e,t,i){for(const s in e)if(typeof e[s]=="object"&&!Array.isArray(e[s])){const a={};this.extractDifferences(e[s],t[s]||{},a),Object.keys(a).length>0&&(i[s]=a)}else JSON.stringify(e[s])!==JSON.stringify(t[s])&&(i[s]=e[s])}clone(){return new m(this.config)}reset(){return this.config=this.deepClone(v),this}}class D{constructor(e=null){this.updateParameter=e||window.updateParameter||this.defaultUpdateParameter.bind(this),this.config=new m,this.inputState={audio:{bass:0,mid:0,high:0,energy:0},tilt:{alpha:0,beta:0,gamma:0},mouse:{x:.5,y:.5,velocityX:0,velocityY:0},click:{intensity:0,lastTime:0},scroll:{delta:0,accumulated:0},touch:{touches:[],pinchScale:1,rotation:0}},this.baseParameters={},this.reactivityDeltas={},this.isActive=!1,this.frameId=null,this.listeners=new Map,console.log("üéõÔ∏è ReactivityManager: Initialized")}defaultUpdateParameter(e,t){console.log(`ReactivityManager: updateParameter(${e}, ${t})`),this.baseParameters[e]=t}setParameterUpdateFunction(e){this.updateParameter=e}loadConfig(e){e instanceof m?this.config=e:this.config=new m(e);const t=this.config.validate();return t.valid||console.warn("ReactivityManager: Config validation errors:",t.errors),this.emit("configChanged",this.config.getConfig()),console.log("üéõÔ∏è ReactivityManager: Config loaded"),t}getConfig(){return this.config.getConfig()}start(){this.isActive||(this.isActive=!0,this.processFrame(),console.log("üéõÔ∏è ReactivityManager: Started"),this.emit("started"))}stop(){this.isActive=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null),console.log("üéõÔ∏è ReactivityManager: Stopped"),this.emit("stopped")}processFrame(){this.isActive&&(this.computeReactivityDeltas(),this.applyDeltas(),this.frameId=requestAnimationFrame(()=>this.processFrame()))}computeReactivityDeltas(){this.reactivityDeltas={};const e=this.config.getConfig();e.audio.enabled&&this.processAudioReactivity(e.audio),e.tilt.enabled&&this.processTiltReactivity(e.tilt),e.interaction.enabled&&this.processInteractionReactivity(e.interaction)}processAudioReactivity(e){const t=this.inputState.audio,i=e.globalSensitivity;for(const[s,a]of Object.entries(e.bands)){if(!a.enabled)continue;const c=(t[s]||0)*a.sensitivity*i;for(const o of a.targets)this.addDelta(o.param,c*o.weight,o.mode)}}processTiltReactivity(e){const t=this.inputState.tilt,i=e.dramaticMode?e.dramaticMappings:e.mappings,s=e.sensitivity;for(const[a,r]of Object.entries(i)){if(!r||!r.target)continue;let c=t[a]||0;e.calibrated&&e.calibrationOffset&&(c-=e.calibrationOffset[a]||0);let o=c*r.scale*s;r.clamp&&(o=Math.max(r.clamp[0],Math.min(r.clamp[1],o))),this.addDelta(r.target,o,"replace")}}processInteractionReactivity(e){e.mouse.enabled&&this.processMouseReactivity(e.mouse),e.click.enabled&&this.processClickReactivity(e.click),e.scroll.enabled&&this.processScrollReactivity(e.scroll),e.touch.enabled&&this.processTouchReactivity(e.touch)}processMouseReactivity(e){const t=this.inputState.mouse,i=e.sensitivity,s=e.mode;if(s==="none")return;const a=e.targets||["rot4dXY","rot4dYZ"],r=e.invertX?1-t.x:t.x,c=e.invertY?1-t.y:t.y;switch(s){case"rotation":a[0]&&this.addDelta(a[0],(r-.5)*2*i,"replace"),a[1]&&this.addDelta(a[1],(c-.5)*2*i,"replace");break;case"velocity":a[0]&&this.addDelta(a[0],t.velocityX*i*.1,"add"),a[1]&&this.addDelta(a[1],t.velocityY*i*.1,"add");break;case"shimmer":const o=Math.sqrt(t.velocityX**2+t.velocityY**2);this.addDelta("chaos",o*i*.01,"add");break;case"attract":this.addDelta("morphFactor",(1-Math.abs(r-.5)*2)*i,"multiply");break;case"repel":this.addDelta("morphFactor",Math.abs(r-.5)*2*i,"multiply");break}}processClickReactivity(e){const t=this.inputState.click;if(t.intensity*=e.decay,t.intensity<.001){t.intensity=0;return}const i=e.mode,s=e.target,a=t.intensity*e.intensity;switch(i){case"burst":this.addDelta(s,a,"add");break;case"blast":this.addDelta(s,a*2,"add"),this.addDelta("chaos",a*.5,"add");break;case"ripple":this.addDelta(s,Math.sin(Date.now()*.01)*a,"add");break;case"pulse":this.addDelta("intensity",a*.5,"add"),this.addDelta("speed",a,"add");break}}processScrollReactivity(e){const t=this.inputState.scroll;if(Math.abs(t.delta)<.001)return;const i=e.mode,s=e.target,a=e.sensitivity;switch(i){case"cycle":if(t.accumulated+=t.delta*a*e.step,Math.abs(t.accumulated)>=1){const r=Math.floor(Math.abs(t.accumulated)),c=t.accumulated>0?1:-1;this.addDelta(s,r*c,"add"),t.accumulated-=r*c}break;case"wave":this.addDelta(s,t.delta*a*.1,"add");break;case"sweep":this.addDelta("hue",t.delta*a*10,"add");break;case"zoom":this.addDelta("dimension",t.delta*a*.01,"add");break;case"morph":this.addDelta("morphFactor",t.delta*a*.1,"add");break}t.delta*=.9}processTouchReactivity(e){const t=this.inputState.touch;if(e.pinchZoom.enabled&&t.pinchScale!==1){const i=(t.pinchScale-1)*e.pinchZoom.sensitivity;this.addDelta(e.pinchZoom.target,i,"add"),t.pinchScale=1+(t.pinchScale-1)*.9}if(e.twoFingerRotate.enabled&&t.rotation!==0){const i=t.rotation*e.twoFingerRotate.sensitivity;this.addDelta(e.twoFingerRotate.target,i,"add"),t.rotation*=.9}}addDelta(e,t,i="add"){if(!p.includes(e)){console.warn(`ReactivityManager: Unknown parameter "${e}"`);return}this.reactivityDeltas[e]||(this.reactivityDeltas[e]={value:0,mode:"add"});const s=this.reactivityDeltas[e];switch(i){case"add":s.value+=t,s.mode="add";break;case"multiply":s.value=(s.value||1)*t,s.mode="multiply";break;case"replace":s.value=t,s.mode="replace";break;case"max":s.value=Math.max(s.value,t),s.mode="max";break;case"min":s.value=Math.min(s.value,t),s.mode="min";break}}applyDeltas(){for(const[e,t]of Object.entries(this.reactivityDeltas)){if(Math.abs(t.value)<1e-4&&t.mode!=="replace")continue;const i=this.baseParameters[e]||0;let s;switch(t.mode){case"add":s=i+t.value;break;case"multiply":s=i*t.value;break;case"replace":s=t.value;break;case"max":s=Math.max(i,t.value);break;case"min":s=Math.min(i,t.value);break;default:s=i+t.value}Number.isFinite(s)&&this.updateParameter(e,s)}}setAudioInput(e,t,i,s=null){this.inputState.audio.bass=Number.isFinite(e)?Math.max(0,Math.min(1,e)):0,this.inputState.audio.mid=Number.isFinite(t)?Math.max(0,Math.min(1,t)):0,this.inputState.audio.high=Number.isFinite(i)?Math.max(0,Math.min(1,i)):0,this.inputState.audio.energy=s!==null&&Number.isFinite(s)?s:(this.inputState.audio.bass+this.inputState.audio.mid+this.inputState.audio.high)/3}setTiltInput(e,t,i){this.inputState.tilt.alpha=e,this.inputState.tilt.beta=t,this.inputState.tilt.gamma=i}setMouseInput(e,t,i=0,s=0){this.inputState.mouse.x=Number.isFinite(e)?Math.max(0,Math.min(1,e)):.5,this.inputState.mouse.y=Number.isFinite(t)?Math.max(0,Math.min(1,t)):.5,this.inputState.mouse.velocityX=Number.isFinite(i)?i:0,this.inputState.mouse.velocityY=Number.isFinite(s)?s:0}triggerClick(e=1){this.inputState.click.intensity=Number.isFinite(e)?Math.max(0,Math.min(2,e)):1,this.inputState.click.lastTime=Date.now()}setScrollDelta(e){Number.isFinite(e)&&(this.inputState.scroll.delta+=e)}setTouchInput(e,t=1,i=0){this.inputState.touch.touches=e,this.inputState.touch.pinchScale=t,this.inputState.touch.rotation=i}setBaseParameter(e,t){this.baseParameters[e]=t}setBaseParameters(e){this.baseParameters={...this.baseParameters,...e}}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(this.listeners.has(e)){const i=this.listeners.get(e),s=i.indexOf(t);s>-1&&i.splice(s,1)}}emit(e,t){if(this.listeners.has(e))for(const i of this.listeners.get(e))try{i(t)}catch(s){console.error("ReactivityManager event handler error:",s)}}destroy(){this.stop(),this.listeners.clear(),console.log("üéõÔ∏è ReactivityManager: Destroyed")}}const l=Object.freeze({DEVICE_TILT:"deviceTilt",MOUSE_POSITION:"mousePosition",GYROSCOPE:"gyroscope",GAMEPAD:"gamepad",PERSPECTIVE:"perspective",PROGRAMMATIC:"programmatic",AUDIO:"audio",MIDI:"midi"}),g=Object.freeze(["pitch","yaw","roll","x","y","z","intensity","velocity"]),O=8,R=32,$=256;function n(h,e,t){return h<e?e:h>t?t:h}function V(h,e,t){return h+(e-h)*t}function S(){return{pitch:0,yaw:0,roll:0,x:0,y:0,z:0,intensity:0,velocity:0}}class N{constructor(e={}){this.sources=new Map,this.mappings=new Map,this.profiles=new Map,this.smoothing=new Map,this.enabled=!1,this.sensitivity=n(Number(e.sensitivity)||1,.1,10),this.smoothingFactor=n(Number(e.smoothing)||.15,0,1),this.dramaticMode=!1,this.parameterUpdateFn=typeof e.onParameterUpdate=="function"?e.onParameterUpdate:null,this._customTargets=new Set,this.spatialState=S(),this.smoothedState=S(),this._prevSmoothedState=S(),this._frameId=null,this._lastFrameTime=0,this._listeners=new Map,this._boundDeviceOrientation=null,this._boundMouseMove=null,this._boundGamepadPoll=null,this._gyroscopeSensor=null,this._initBuiltInProfiles(),this.activeProfile=null,e.autoRegisterGlobals!==!1&&typeof window<"u"&&this._registerGlobals(),console.log("SpatialInputSystem: Initialised")}_registerGlobals(){typeof window>"u"||(window.spatialInputSystem=this,window.enableSpatialInput=e=>{e&&this.loadProfile(e),this.enable()},window.disableSpatialInput=()=>{this.disable()},window.setSpatialProfile=e=>{this.loadProfile(e)},window.feedSpatialInput=e=>{this.feedInput(l.PROGRAMMATIC,e)},window.getSpatialState=()=>this.getState())}_initBuiltInProfiles(){this.profiles.set("cardTilt",{name:"Card Tilt",description:"Physical tilt controls 4D hyperspace rotation",mappings:[{axis:"pitch",target:"rot4dXW",scale:.02,clamp:[-1.5,1.5],blendMode:"replace"},{axis:"roll",target:"rot4dYW",scale:.025,clamp:[-1.5,1.5],blendMode:"replace"},{axis:"yaw",target:"rot4dZW",scale:.015,clamp:[-2,2],blendMode:"replace"},{axis:"intensity",target:"chaos",scale:.3,clamp:[0,1],blendMode:"replace"}],sources:[l.DEVICE_TILT,l.MOUSE_POSITION],smoothing:.12}),this.profiles.set("wearablePerspective",{name:"Wearable Perspective",description:"Viewing angle affects visuals without physical device tilt; designed for AR glasses and headsets",mappings:[{axis:"pitch",target:"rot4dXW",scale:.015,clamp:[-1,1],blendMode:"replace"},{axis:"yaw",target:"rot4dXY",scale:.02,clamp:[-3.14,3.14],blendMode:"replace"},{axis:"roll",target:"rot4dYW",scale:.01,clamp:[-.8,.8],blendMode:"replace"},{axis:"z",target:"dimension",scale:.5,clamp:[3,4.5],blendMode:"replace"},{axis:"intensity",target:"intensity",scale:.4,clamp:[.2,1],blendMode:"replace"}],sources:[l.PERSPECTIVE,l.DEVICE_TILT],smoothing:.2}),this.profiles.set("gameAsset",{name:"Game Asset",description:"Game object orientation in world space maps to all 6 rotation planes",mappings:[{axis:"pitch",target:"rot4dYZ",scale:1,clamp:[-6.28,6.28],blendMode:"replace"},{axis:"yaw",target:"rot4dXZ",scale:1,clamp:[-6.28,6.28],blendMode:"replace"},{axis:"roll",target:"rot4dXY",scale:1,clamp:[-6.28,6.28],blendMode:"replace"},{axis:"x",target:"rot4dXW",scale:.5,clamp:[-2,2],blendMode:"replace"},{axis:"y",target:"rot4dYW",scale:.5,clamp:[-2,2],blendMode:"replace"},{axis:"z",target:"rot4dZW",scale:.5,clamp:[-2,2],blendMode:"replace"}],sources:[l.PROGRAMMATIC,l.GAMEPAD],smoothing:.08}),this.profiles.set("vjAudioSpatial",{name:"VJ Audio Spatial",description:"Audio energy creates spatial movement for live VJ performance",mappings:[{axis:"pitch",target:"rot4dXW",scale:.8,clamp:[-1.5,1.5],blendMode:"add"},{axis:"yaw",target:"rot4dYW",scale:.6,clamp:[-1.5,1.5],blendMode:"add"},{axis:"roll",target:"rot4dZW",scale:.5,clamp:[-1,1],blendMode:"add"},{axis:"intensity",target:"morphFactor",scale:1.5,clamp:[0,2],blendMode:"replace"},{axis:"velocity",target:"chaos",scale:.8,clamp:[0,1],blendMode:"replace"},{axis:"x",target:"hue",scale:180,clamp:[0,360],blendMode:"add"},{axis:"y",target:"speed",scale:2,clamp:[.1,3],blendMode:"replace"}],sources:[l.AUDIO,l.MIDI],smoothing:.08}),this.profiles.set("uiElement",{name:"UI Element",description:"Mouse and scroll position changes visuals without physical movement",mappings:[{axis:"pitch",target:"rot4dXW",scale:.8,clamp:[-1,1],blendMode:"replace"},{axis:"roll",target:"rot4dYW",scale:.8,clamp:[-1,1],blendMode:"replace"},{axis:"yaw",target:"rot4dXY",scale:.5,clamp:[-1.5,1.5],blendMode:"replace"},{axis:"z",target:"dimension",scale:.3,clamp:[3,4.5],blendMode:"add"},{axis:"intensity",target:"intensity",scale:.5,clamp:[.1,1],blendMode:"replace"}],sources:[l.MOUSE_POSITION],smoothing:.18}),this.profiles.set("immersiveXR",{name:"Immersive XR",description:"Full 6DOF mapping for WebXR headsets and controllers",mappings:[{axis:"pitch",target:"rot4dYZ",scale:1,clamp:[-6.28,6.28],blendMode:"replace"},{axis:"yaw",target:"rot4dXZ",scale:1,clamp:[-6.28,6.28],blendMode:"replace"},{axis:"roll",target:"rot4dXY",scale:1,clamp:[-6.28,6.28],blendMode:"replace"},{axis:"x",target:"rot4dXW",scale:1,clamp:[-2,2],blendMode:"replace"},{axis:"y",target:"rot4dYW",scale:1,clamp:[-2,2],blendMode:"replace"},{axis:"z",target:"rot4dZW",scale:1,clamp:[-2,2],blendMode:"replace"},{axis:"intensity",target:"intensity",scale:.6,clamp:[.2,1],blendMode:"replace"},{axis:"velocity",target:"speed",scale:2,clamp:[.1,3],blendMode:"replace"}],sources:[l.PERSPECTIVE,l.GYROSCOPE,l.GAMEPAD],smoothing:.06})}addSource(e,t,i={}){if(!e||typeof e!="string")return console.warn("SpatialInputSystem.addSource: name must be a non-empty string"),!1;if(!Object.values(l).includes(t))return console.warn(`SpatialInputSystem.addSource: unknown source type "${t}"`),!1;if(this.sources.size>=R)return console.warn("SpatialInputSystem.addSource: maximum source count reached"),!1;this.sources.has(e)&&this.removeSource(e);const s={name:e,type:t,config:{...i},active:!0,_cleanup:null};return this.sources.set(e,s),this.enabled&&this._attachSourceListeners(s),this._emit("sourceAdded",{name:e,type:t}),console.log(`SpatialInputSystem: Source added "${e}" (${t})`),!0}removeSource(e){const t=this.sources.get(e);return t?(this._detachSourceListeners(t),this.sources.delete(e),this._emit("sourceRemoved",{name:e,type:t.type}),console.log(`SpatialInputSystem: Source removed "${e}"`),!0):!1}hasSource(e){return this.sources.has(e)}listSources(){const e=[];for(const[t,i]of this.sources)e.push({name:t,type:i.type,active:i.active});return e}setMapping(e,t,i=1,s=null,a="replace"){if(!g.includes(e))return console.warn(`SpatialInputSystem.setMapping: unknown axis "${e}"`),!1;if(!this._isValidTarget(t))return console.warn(`SpatialInputSystem.setMapping: unknown target "${t}"`),!1;if(w.includes(a)||(console.warn(`SpatialInputSystem.setMapping: unknown blend mode "${a}", defaulting to "replace"`),a="replace"),this.mappings.size>=$)return console.warn("SpatialInputSystem.setMapping: maximum mapping count reached"),!1;const r=`${e}->${t}`,c={axis:e,target:t,scale:Number.isFinite(i)?i:1,clamp:Array.isArray(s)&&s.length===2?s:null,blendMode:a};return this.mappings.set(r,c),this._emit("mappingChanged",c),!0}removeMapping(e,t){const i=`${e}->${t}`,s=this.mappings.delete(i);return s&&this._emit("mappingRemoved",{axis:e,target:t}),s}clearMappings(){this.mappings.clear(),this._emit("mappingsCleared")}listMappings(){return Array.from(this.mappings.values())}loadProfile(e){const t=this.profiles.get(e);if(!t)return console.warn(`SpatialInputSystem.loadProfile: unknown profile "${e}"`),!1;this.clearMappings(),typeof t.smoothing=="number"&&(this.smoothingFactor=n(t.smoothing,0,1));for(const i of t.mappings)this.setMapping(i.axis,i.target,i.scale,i.clamp||null,i.blendMode||"replace");return this.activeProfile=e,this._emit("profileLoaded",{name:e,profile:t}),console.log(`SpatialInputSystem: Profile loaded "${e}"`),!0}createProfile(e,t,i={}){if(!e||typeof e!="string")return console.warn("SpatialInputSystem.createProfile: name must be a non-empty string"),!1;if(!Array.isArray(t)||t.length===0)return console.warn("SpatialInputSystem.createProfile: mappings must be a non-empty array"),!1;const s={name:i.name||e,description:i.description||`Custom profile: ${e}`,mappings:t.map(a=>({axis:a.axis,target:a.target,scale:Number.isFinite(a.scale)?a.scale:1,clamp:Array.isArray(a.clamp)?a.clamp:null,blendMode:a.blendMode||"replace"})),sources:Array.isArray(i.sources)?i.sources:[],smoothing:typeof i.smoothing=="number"?n(i.smoothing,0,1):this.smoothingFactor};return this.profiles.set(e,s),this._emit("profileCreated",{name:e,profile:s}),console.log(`SpatialInputSystem: Profile created "${e}"`),!0}removeProfile(e){return["cardTilt","wearablePerspective","gameAsset","vjAudioSpatial","uiElement","immersiveXR"].includes(e)?(console.warn(`SpatialInputSystem.removeProfile: cannot remove built-in profile "${e}"`),!1):this.profiles.delete(e)}listProfiles(){return Array.from(this.profiles.keys())}getProfile(e){const t=this.profiles.get(e);return t?{...t,mappings:t.mappings.map(i=>({...i}))}:null}addCustomTarget(e){typeof e=="string"&&e.length>0&&this._customTargets.add(e)}removeCustomTarget(e){this._customTargets.delete(e)}_isValidTarget(e){return p.includes(e)||this._customTargets.has(e)}enable(){if(!this.enabled){this.enabled=!0,this._lastFrameTime=performance.now();for(const e of this.sources.values())this._attachSourceListeners(e);this._scheduleFrame(),this._emit("enabled"),console.log("SpatialInputSystem: Enabled")}}disable(){if(this.enabled){this.enabled=!1,this._frameId!==null&&(cancelAnimationFrame(this._frameId),this._frameId=null);for(const e of this.sources.values())this._detachSourceListeners(e);this._emit("disabled"),console.log("SpatialInputSystem: Disabled")}}isEnabled(){return this.enabled}setSensitivity(e){this.sensitivity=n(Number(e)||1,.1,10)}setSmoothing(e){this.smoothingFactor=n(Number(e)||.15,0,1)}setAxisSmoothing(e,t){g.includes(e)&&this.smoothing.set(e,n(Number(t)||0,0,1))}setDramaticMode(e){this.dramaticMode=!!e,this._emit("dramaticModeChanged",this.dramaticMode),console.log(`SpatialInputSystem: Dramatic mode ${this.dramaticMode?"ON":"OFF"}`)}setParameterUpdateFn(e){this.parameterUpdateFn=typeof e=="function"?e:null}feedInput(e,t){if(!(!t||typeof t!="object"))switch(e){case l.PROGRAMMATIC:this._processProgrammatic(t);break;case l.DEVICE_TILT:this._processDeviceTilt(t);break;case l.MOUSE_POSITION:this._processMousePosition(Number(t.x)||0,Number(t.y)||0,t.width||(typeof window<"u"?window.innerWidth:1920),t.height||(typeof window<"u"?window.innerHeight:1080));break;case l.GYROSCOPE:this._processGyroscope(t);break;case l.GAMEPAD:this._processGamepad(t);break;case l.PERSPECTIVE:this._processPerspective(t);break;case l.AUDIO:this._processAudioSpatial(Number(t.bass)||0,Number(t.mid)||0,Number(t.high)||0);break;case l.MIDI:this._processMIDI(Number(t.channel)||0,Number(t.cc)||0,Number(t.value)||0);break;default:console.warn(`SpatialInputSystem.feedInput: unknown source type "${e}"`)}}getState(){return{...this.smoothedState}}getRawState(){return{...this.spatialState}}exportConfig(){return{version:"1.0",sensitivity:this.sensitivity,smoothingFactor:this.smoothingFactor,dramaticMode:this.dramaticMode,activeProfile:this.activeProfile,sources:this.listSources(),mappings:this.listMappings(),customTargets:Array.from(this._customTargets),axisSmoothing:Object.fromEntries(this.smoothing)}}importConfig(e){if(!e||typeof e!="object")return console.warn("SpatialInputSystem.importConfig: invalid config"),!1;try{if(Number.isFinite(e.sensitivity)&&this.setSensitivity(e.sensitivity),Number.isFinite(e.smoothingFactor)&&this.setSmoothing(e.smoothingFactor),typeof e.dramaticMode=="boolean"&&this.setDramaticMode(e.dramaticMode),Array.isArray(e.customTargets)){this._customTargets.clear();for(const t of e.customTargets)this.addCustomTarget(t)}if(e.axisSmoothing&&typeof e.axisSmoothing=="object"){this.smoothing.clear();for(const[t,i]of Object.entries(e.axisSmoothing))this.setAxisSmoothing(t,i)}if(Array.isArray(e.sources)){for(const t of Array.from(this.sources.keys()))this.removeSource(t);for(const t of e.sources)t.name&&t.type&&this.addSource(t.name,t.type,t.config||{})}if(Array.isArray(e.mappings)){this.clearMappings();for(const t of e.mappings)this.setMapping(t.axis,t.target,t.scale,t.clamp,t.blendMode)}return e.activeProfile&&this.profiles.has(e.activeProfile)&&this.loadProfile(e.activeProfile),this._emit("configImported",e),console.log("SpatialInputSystem: Config imported"),!0}catch(t){return console.error("SpatialInputSystem.importConfig: error during import",t),!1}}_scheduleFrame(){this.enabled&&(this._frameId=requestAnimationFrame(e=>this._onFrame(e)))}_onFrame(e){if(!this.enabled)return;const t=Math.min((e-this._lastFrameTime)/1e3,.1);this._lastFrameTime=e,this._pollSources(),this.processFrame(t),this._scheduleFrame()}processFrame(e){const t=Number.isFinite(e)&&e>0?e:.016666666666666666,i=Math.sqrt(this.spatialState.pitch*this.spatialState.pitch+this.spatialState.yaw*this.spatialState.yaw+this.spatialState.roll*this.spatialState.roll+this.spatialState.x*this.spatialState.x+this.spatialState.y*this.spatialState.y+this.spatialState.z*this.spatialState.z);this.spatialState.intensity=n(i/Math.SQRT2,0,1);for(const a of g){const c=1-(this.smoothing.has(a)?this.smoothing.get(a):this.smoothingFactor);this.smoothedState[a]=V(this.smoothedState[a],this.spatialState[a],n(c,0,1))}let s=0;for(const a of["pitch","yaw","roll","x","y","z"]){const r=this.smoothedState[a]-this._prevSmoothedState[a];s+=r*r}this.smoothedState.velocity=n(Math.sqrt(s)/(t*10),0,1),Object.assign(this._prevSmoothedState,this.smoothedState),this._applyMappings()}_applyMappings(){if(!this.parameterUpdateFn)return;const e=new Map;for(const t of this.mappings.values()){let s=(this.smoothedState[t.axis]||0)*t.scale*this.sensitivity;if(this.dramaticMode&&(s*=O),t.clamp&&(s=n(s,t.clamp[0],t.clamp[1])),!Number.isFinite(s))continue;const a=t.blendMode||"replace",r=e.get(t.target);if(!r)e.set(t.target,{value:s,mode:a});else switch(a){case"add":r.value+=s;break;case"multiply":r.value*=s;break;case"max":r.value=Math.max(r.value,s);break;case"min":r.value=Math.min(r.value,s);break;case"replace":default:r.value=s;break}}for(const[t,{value:i}]of e)try{this.parameterUpdateFn(t,i)}catch(s){console.error(`SpatialInputSystem: Error updating parameter "${t}"`,s)}}_attachSourceListeners(e){if(!(typeof window>"u"))switch(e.type){case l.DEVICE_TILT:this._attachDeviceTilt(e);break;case l.MOUSE_POSITION:this._attachMousePosition(e);break;case l.GYROSCOPE:this._attachGyroscope(e);break;case l.GAMEPAD:e._cleanup=null;break;case l.PERSPECTIVE:case l.PROGRAMMATIC:case l.AUDIO:case l.MIDI:e._cleanup=null;break}}_detachSourceListeners(e){typeof e._cleanup=="function"&&(e._cleanup(),e._cleanup=null)}_attachDeviceTilt(e){if(typeof window>"u")return;const t=i=>{e.active&&this._processDeviceTilt(i)};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?window.addEventListener("deviceorientation",t):console.warn("SpatialInputSystem: Device orientation permission denied")}).catch(i=>{console.warn("SpatialInputSystem: Device orientation permission error",i)}):window.addEventListener("deviceorientation",t),e._cleanup=()=>{window.removeEventListener("deviceorientation",t)}}_attachMousePosition(e){if(typeof window>"u")return;const t=e.config.element||window,i=s=>{e.active&&this._processMousePosition(s.clientX,s.clientY,window.innerWidth,window.innerHeight)};t.addEventListener("mousemove",i),e._cleanup=()=>{t.removeEventListener("mousemove",i)}}_attachGyroscope(e){if(typeof window>"u"||typeof window.Gyroscope>"u"){console.warn("SpatialInputSystem: Gyroscope API not available");return}try{const t=e.config.frequency||60,i=new window.Gyroscope({frequency:t});i.addEventListener("reading",()=>{e.active&&this._processGyroscope({x:i.x,y:i.y,z:i.z})}),i.addEventListener("error",s=>{console.warn("SpatialInputSystem: Gyroscope error",s.error)}),i.start(),this._gyroscopeSensor=i,e._cleanup=()=>{i.stop(),this._gyroscopeSensor=null}}catch(t){console.warn("SpatialInputSystem: Failed to initialise Gyroscope",t)}}_pollSources(){for(const e of this.sources.values())if(e.active)switch(e.type){case l.GAMEPAD:this._pollGamepad(e);break}}_pollGamepad(e){if(typeof navigator>"u"||typeof navigator.getGamepads!="function")return;const t=navigator.getGamepads(),i=e.config.index||0,s=t[i];!s||!s.connected||this._processGamepad(s,e.config)}_processDeviceTilt(e){const t=Number(e.alpha)||0,i=Number(e.beta)||0,s=Number(e.gamma)||0;this.spatialState.pitch=n(i/90,-1,1),this.spatialState.roll=n(s/45,-1,1),this.spatialState.yaw=n((t-180)/180,-1,1)}_processMousePosition(e,t,i,s){const a=Number(i)||(typeof window<"u"?window.innerWidth:1920),r=Number(s)||(typeof window<"u"?window.innerHeight:1080);if(a===0||r===0)return;const c=n((e/a-.5)*2,-1,1),o=n((t/r-.5)*2,-1,1);this.spatialState.roll=c,this.spatialState.pitch=-o}_processGyroscope(e){const t=Number(e.x)||0,i=Number(e.y)||0,s=Number(e.z)||0,a=.1,r=.95;this.spatialState.pitch=n(this.spatialState.pitch*r+t*a,-1,1),this.spatialState.roll=n(this.spatialState.roll*r+i*a,-1,1),this.spatialState.yaw=n(this.spatialState.yaw*r+s*a,-1,1)}_processGamepad(e,t={}){const i=Number(t.deadzone)||.1,s=e.axes||[],a=e.buttons||[],r=c=>Math.abs(c)<i?0:c;if(s.length>=2&&(this.spatialState.roll=n(r(s[0]),-1,1),this.spatialState.pitch=n(r(-s[1]),-1,1)),s.length>=4&&(this.spatialState.yaw=n(r(s[2]),-1,1),this.spatialState.z=n(r(-s[3]),-1,1)),a.length>=8){const c=typeof a[6]=="object"?a[6].value:Number(a[6])||0,o=typeof a[7]=="object"?a[7].value:Number(a[7])||0;this.spatialState.x=n(o-c,-1,1)}}_processPerspective(e){Number.isFinite(e.pitch)&&(this.spatialState.pitch=n(e.pitch,-1,1)),Number.isFinite(e.yaw)&&(this.spatialState.yaw=n(e.yaw,-1,1)),Number.isFinite(e.roll)&&(this.spatialState.roll=n(e.roll,-1,1)),Number.isFinite(e.x)&&(this.spatialState.x=n(e.x,-1,1)),Number.isFinite(e.y)&&(this.spatialState.y=n(e.y,-1,1)),Number.isFinite(e.z)&&(this.spatialState.z=n(e.z,-1,1))}_processAudioSpatial(e,t,i){const s=n(e,0,1),a=n(t,0,1),r=n(i,0,1),c=(s+a+r)/3,o=typeof performance<"u"?performance.now()*.001:Date.now()*.001;this.spatialState.pitch=n(Math.sin(o*1.3)*s,-1,1),this.spatialState.yaw=n(Math.sin(o*.7)*a,-1,1),this.spatialState.roll=n(Math.sin(o*2.1)*r,-1,1),this.spatialState.x=n(Math.cos(o*.5)*c,-1,1),this.spatialState.y=n(c*2-1,-1,1)}_processMIDI(e,t,i){const s=n(i/63.5-1,-1,1);switch(t){case 1:this.spatialState.pitch=s;break;case 2:this.spatialState.yaw=s;break;case 11:this.spatialState.roll=s;break;case 74:this.spatialState.x=s;break;case 71:this.spatialState.y=s;break;case 7:this.spatialState.z=s;break;default:{const a=t%6,r=["pitch","yaw","roll","x","y","z"];this.spatialState[r[a]]=s;break}}this._emit("midiInput",{channel:e,cc:t,value:i,normalized:s})}_processProgrammatic(e){for(const t of g)Number.isFinite(e[t])&&(t==="intensity"||t==="velocity"?this.spatialState[t]=n(e[t],0,1):this.spatialState[t]=n(e[t],-1,1))}on(e,t){typeof t=="function"&&(this._listeners.has(e)||this._listeners.set(e,[]),this._listeners.get(e).push(t))}off(e,t){if(!this._listeners.has(e))return;const i=this._listeners.get(e),s=i.indexOf(t);s!==-1&&i.splice(s,1)}_emit(e,t){if(this._listeners.has(e))for(const i of this._listeners.get(e))try{i(t)}catch(s){console.error(`SpatialInputSystem: Event handler error for "${e}"`,s)}}destroy(){this.disable();for(const e of Array.from(this.sources.keys()))this.removeSource(e);this.mappings.clear(),this._listeners.clear(),this._customTargets.clear(),this.smoothing.clear(),typeof window<"u"&&(window.spatialInputSystem===this&&delete window.spatialInputSystem,delete window.enableSpatialInput,delete window.disableSpatialInput,delete window.setSpatialProfile,delete window.feedSpatialInput,delete window.getSpatialState),console.log("SpatialInputSystem: Destroyed")}}class G{constructor(){this.time=0,this.breath=0,this.cycleDuration=6e3,this.isRunning=!1}start(){this.isRunning=!0,this.startTime=Date.now()}stop(){this.isRunning=!1}update(e){if(!this.isRunning)return 0;const a=(Date.now()-this.startTime)%this.cycleDuration/this.cycleDuration*Math.PI*2;return this.breath=(1-Math.cos(a))*.5,this.breath}getBreath(){return this.breath}}class W{constructor(e={}){this.activeSystem=null,this.currentSystemName=e.system||"quantum",this.parameters=new A,this.initialized=!1,this.canvasManager=null,this.preferWebGPU=e.preferWebGPU!==!1,this.debug=e.debug||!1,this.vitality=new G,this.reactivity=new D((t,i)=>{this.parameters.setParameter(t,i),this.updateCurrentSystemParameters()}),this.spatialInput=new N({sensitivity:e.spatialSensitivity||1,smoothing:e.spatialSmoothing||.15,onParameterUpdate:(t,i)=>{this.parameters.setParameter(t,i),this.updateCurrentSystemParameters()}}),e.reactivityConfig&&this.reactivity.loadConfig(e.reactivityConfig),e.spatialProfile&&this.spatialInput.loadProfile(e.spatialProfile)}async initialize(e="vib3-container"){console.log("Initializing VIB3+ Engine");try{this.canvasManager=new F(e)}catch(i){return console.error("CanvasManager initialization failed:",i),!1}return await this.switchSystem(this.currentSystemName)?(this.reactivity.setBaseParameters(this.parameters.getAllParameters()),this.vitality.start(),this._startGlobalLoop(),this.initialized=!0,console.log("VIB3+ Engine initialized"),!0):(console.error(`VIB3+ Engine: Failed to create initial system "${this.currentSystemName}"`),!1)}_startGlobalLoop(){this._globalLoopActive=!0;const e=()=>{if(this._globalLoopActive){if(this.initialized){const t=this.vitality.update();this.activeSystem&&this.activeSystem.updateParameters&&this.activeSystem.updateParameters({breath:t})}this._globalRafId=requestAnimationFrame(e)}};this._globalRafId=requestAnimationFrame(e)}async createSystem(e){console.log(`Creating ${e} system...`);const t=this.canvasManager.createSystemCanvases(e);let i=null;try{switch(e){case"quantum":if(i=new P,this.preferWebGPU){try{if(await i.initWithBridge({preferWebGPU:!0,debug:this.debug})){console.log("Quantum: WebGPU bridge active");break}}catch{}console.warn("Quantum: WebGPU bridge failed, falling back to WebGL"),i=new P}break;case"faceted":if(i=new _,this.preferWebGPU){const a=document.getElementById("content-canvas");if(a){try{if(await i.initWithBridge(a,{preferWebGPU:!0,debug:this.debug})){console.log("Faceted: WebGPU bridge active");break}}catch{}console.warn("Faceted: WebGPU bridge failed, falling back to WebGL"),i=new _}}if(!await i.initialize())throw new Error("Faceted system initialization failed");break;case"holographic":if(i=new M,this.preferWebGPU){try{if(await i.initWithBridge({preferWebGPU:!0,debug:this.debug})){console.log("Holographic: WebGPU bridge active");break}}catch{}console.warn("Holographic: WebGPU bridge failed, falling back to WebGL"),i=new M}break;default:throw new Error(`Unknown system: ${e}`)}return t.forEach(s=>{const a=document.getElementById(s);if(a){const r=a.getContext("webgl")||a.getContext("webgl2");r&&this.canvasManager.registerContext(s,r)}}),i.updateParameters(this.parameters.getAllParameters()),i.setActive(!0),console.log(`${e} system created and activated`),i}catch(s){throw console.error(`${e} system creation failed:`,s),s}}async switchSystem(e){if(!["quantum","faceted","holographic"].includes(e))return console.error("Unknown system:",e),!1;console.log(`Switching from ${this.currentSystemName} to ${e}`),this.activeSystem&&(this.activeSystem.setActive&&this.activeSystem.setActive(!1),this.activeSystem.destroy&&this.activeSystem.destroy(),this.activeSystem=null);try{return this.activeSystem=await this.createSystem(e),this.currentSystemName=e,console.log(`Switched to ${e} system`),!0}catch(t){return console.error(`Failed to switch to ${e}:`,t),!1}}getActiveBackendType(){return this.activeSystem&&this.activeSystem.getBackendType?this.activeSystem.getBackendType():null}updateCurrentSystemParameters(){const e=this.parameters.getAllParameters();if(this.activeSystem&&this.activeSystem.updateParameters?this.activeSystem.updateParameters(e):this.debug&&this.activeSystem&&!this.activeSystem.updateParameters?console.warn("VIB3+ Engine [debug]: activeSystem missing updateParameters() method"):this.debug&&!this.activeSystem&&console.warn("VIB3+ Engine [debug]: updateCurrentSystemParameters() called with no activeSystem"),this._parameterListeners&&this._parameterListeners.size>0)for(const t of this._parameterListeners)try{t(e)}catch{}}setParameter(e,t){this.parameters.setParameter(e,t),this.reactivity.setBaseParameter(e,t),this.updateCurrentSystemParameters()}setParameters(e){this.parameters.setParameters(e),this.reactivity.setBaseParameters(e),this.updateCurrentSystemParameters()}getParameter(e){return this.parameters.getParameter(e)}getAllParameters(){return this.parameters.getAllParameters()}randomizeAll(){this.parameters.randomizeAll(),this.updateCurrentSystemParameters()}resetAll(){this.parameters.resetToDefaults(),this.updateCurrentSystemParameters()}getCurrentSystem(){return this.currentSystemName}getActiveSystemInstance(){return this.activeSystem}getReactivityManager(){return this.reactivity}loadReactivityConfig(e){return this.reactivity.loadConfig(e)}getReactivityConfig(){return this.reactivity.getConfig()}startReactivity(){this.reactivity.setBaseParameters(this.parameters.getAllParameters()),this.reactivity.start()}stopReactivity(){this.reactivity.stop()}isReactivityActive(){return this.reactivity.isActive}setAudioInput(e,t,i,s){this.reactivity.setAudioInput(e,t,i,s)}setTiltInput(e,t,i){this.reactivity.setTiltInput(e,t,i)}setMouseInput(e,t,i=0,s=0){this.reactivity.setMouseInput(e,t,i,s)}triggerClick(e=1){this.reactivity.triggerClick(e)}setScrollDelta(e){this.reactivity.setScrollDelta(e)}setTouchInput(e,t=1,i=0){this.reactivity.setTouchInput(e,t,i)}getSpatialInputSystem(){return this.spatialInput}enableSpatialInput(e="cardTilt"){return this.spatialInput.loadProfile(e),this.spatialInput.enable(),!0}disableSpatialInput(){this.spatialInput.disable()}setSpatialProfile(e){this.spatialInput.loadProfile(e)}feedSpatialInput(e){this.spatialInput.feedInput("programmatic",e)}setSpatialSensitivity(e){this.spatialInput.setSensitivity(e)}setSpatialDramaticMode(e){this.spatialInput.setDramaticMode(e)}getGeometryNames(){return["Tetrahedron","Hypercube","Sphere","Torus","Klein Bottle","Fractal","Wave","Crystal","Hypersphere Core (Tetrahedron)","Hypersphere Core (Hypercube)","Hypersphere Core (Sphere)","Hypersphere Core (Torus)","Hypersphere Core (Klein)","Hypersphere Core (Fractal)","Hypersphere Core (Wave)","Hypersphere Core (Crystal)","Hypertetrahedron Core (Tetrahedron)","Hypertetrahedron Core (Hypercube)","Hypertetrahedron Core (Sphere)","Hypertetrahedron Core (Torus)","Hypertetrahedron Core (Klein)","Hypertetrahedron Core (Fractal)","Hypertetrahedron Core (Wave)","Hypertetrahedron Core (Crystal)"]}exportState(){return{system:this.currentSystemName,parameters:this.parameters.getAllParameters(),reactivity:this.reactivity.getConfig(),reactivityActive:this.reactivity.isActive,spatialInput:this.spatialInput.exportConfig(),spatialActive:this.spatialInput.enabled,backend:this.getActiveBackendType(),timestamp:new Date().toISOString(),version:"2.0.3"}}async importState(e){if(!e||typeof e!="object"){console.warn("VIB3Engine: importState received invalid state");return}try{if(JSON.stringify(e).length>256*1024){console.warn("VIB3Engine: importState rejected ‚Äî state exceeds 256 KB");return}}catch{console.warn("VIB3Engine: importState received non-serializable state");return}const t=(i,s=0)=>{if(s>6||!i||typeof i!="object")return s;let a=s;for(const r of Object.values(i))if(a=Math.max(a,t(r,s+1)),a>6)return a;return a};if(t(e)>6){console.warn("VIB3Engine: importState rejected ‚Äî state nesting exceeds depth 6");return}if(e.system&&typeof e.system=="string"&&await this.switchSystem(e.system),e.parameters&&typeof e.parameters=="object"&&!Array.isArray(e.parameters)){const i={};for(const[s,a]of Object.entries(e.parameters))typeof a=="number"&&Number.isFinite(a)&&(i[s]=a);this.parameters.setParameters(i),this.reactivity.setBaseParameters(i),this.updateCurrentSystemParameters()}e.reactivity&&typeof e.reactivity=="object"&&!Array.isArray(e.reactivity)&&this.reactivity.loadConfig(e.reactivity),e.reactivityActive&&this.startReactivity(),e.spatialInput&&typeof e.spatialInput=="object"&&this.spatialInput.importConfig(e.spatialInput),e.spatialActive&&this.spatialInput.enable()}createParameterCallback(){return(e,t)=>this.setParameter(e,t)}getBreath(){return this.vitality.getBreath()}onParameterChange(e){return this._parameterListeners||(this._parameterListeners=new Set),this._parameterListeners.add(e),()=>this._parameterListeners.delete(e)}destroy(){this._globalLoopActive=!1,this._globalRafId&&(cancelAnimationFrame(this._globalRafId),this._globalRafId=null),this.vitality.stop(),this.spatialInput&&this.spatialInput.destroy(),this.reactivity&&this.reactivity.destroy(),this.activeSystem&&this.activeSystem.destroy&&this.activeSystem.destroy(),this.activeSystem=null,this.canvasManager&&this.canvasManager.destroy(),this.canvasManager=null,this.initialized=!1,console.log("VIB3+ Engine destroyed")}}class z{constructor(e="vib3-universe"){this.orchestrator=new k,this.compositor=new T(e),this.actors=new Map}start(){this.orchestrator.start()}stop(){this.orchestrator.stop()}async spawnActor(e={}){const t=`actor_${Date.now()}_${Math.floor(Math.random()*1e3)}`,i=document.createElement("div");i.id=`container_${t}`,i.style.width="100%",i.style.height="100%",i.style.pointerEvents="none",this.compositor.addInstance(t,i,e.layer||{});const s=new W({system:e.system||"holographic",preferWebGPU:!0});await s.initialize(i.id),e.geometry!==void 0&&s.setParameter("geometry",e.geometry);const a=new E(s,e.personality||"neutral");return a.id=t,this.orchestrator.entities.set(t,a),this.actors.set(t,a),console.log(`VIB3Universe: Spawned actor ${t}`),a}despawnActor(e){const t=this.actors.get(e);t&&(this.orchestrator.kill(e),t.engine&&t.engine.destroy&&t.engine.destroy(),this.compositor.removeInstance(e),this.actors.delete(e),console.log(`VIB3Universe: Despawned actor ${e}`))}}export{z as V};
//# sourceMappingURL=VIB3Universe-CBjOFS4d.js.map
