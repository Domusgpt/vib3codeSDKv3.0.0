{"version":3,"file":"VIB3Universe-CBjOFS4d.js","sources":["../../src/experimental/VIB3Orchestrator.js","../../src/experimental/VIB3Compositor.js","../../src/creative/TransitionAnimator.js","../../src/experimental/VIB3Actor.js","../../src/core/CanvasManager.js","../../src/reactivity/ReactivityConfig.js","../../src/reactivity/ReactivityManager.js","../../src/reactivity/SpatialInputSystem.js","../../src/core/VitalitySystem.js","../../src/core/VIB3Engine.js","../../src/experimental/VIB3Universe.js"],"sourcesContent":["/**\n * VIB3Orchestrator - The Core of the VIB3 Universe\n * \n * Manages the lifecycle and coordination of multiple VIB3+ entities (visualizers).\n * Implements the \"Universe\" concept where multiple instances share a clock, \n * physics, and event bus.\n *\n * @experimental\n */\nexport class VIB3Orchestrator {\n    constructor() {\n        this.entities = new Map(); // id -> Entity\n        this.nextEntityId = 1;\n        \n        // Master Clock\n        this.time = 0;\n        this.lastFrameTime = 0;\n        this.paused = false;\n        \n        // Systems\n        this.eventBus = new EventTarget();\n        \n        // Bind loop\n        this.tick = this.tick.bind(this);\n    }\n\n    /**\n     * Start the universe simulation loop.\n     */\n    start() {\n        if (this.running) return;\n        this.running = true;\n        this.lastFrameTime = performance.now();\n        requestAnimationFrame(this.tick);\n        console.log('VIB3Orchestrator: Universe started.');\n    }\n\n    /**\n     * Stop the universe simulation loop.\n     */\n    stop() {\n        this.running = false;\n        console.log('VIB3Orchestrator: Universe stopped.');\n    }\n\n    /**\n     * Spawn a new VIB3 entity.\n     * @param {string} type - 'actor', 'prop', 'environment'\n     * @param {object} config - Configuration for the entity\n     * @returns {string} Entity ID\n     */\n    spawn(type, config = {}) {\n        const id = `vib3_entity_${this.nextEntityId++}`;\n        \n        // In a real implementation, this would instantiate VIB3Actor or VIB3Prop\n        // For now, we store a mock object representing the entity state\n        const entity = {\n            id,\n            type,\n            config,\n            position: config.position || { x: 0, y: 0, z: 0 },\n            rotation: config.rotation || { x: 0, y: 0, z: 0, w: 0 }, // 4D rotation\n            active: true,\n            \n            // Mock VIB3Engine interface\n            engine: {\n                setParameter: (k, v) => console.log(`[${id}] set ${k}=${v}`),\n                getParameter: (k) => 0\n            },\n\n            update: (dt) => {\n                // Default update logic\n                // e.g., apply basic physics or script behavior\n            }\n        };\n\n        this.entities.set(id, entity);\n        this.emit('entitySpawned', { id, type });\n        console.log(`VIB3Orchestrator: Spawned ${type} (${id})`);\n        \n        return id;\n    }\n\n    /**\n     * Remove an entity from the universe.\n     * @param {string} id \n     */\n    kill(id) {\n        if (this.entities.has(id)) {\n            const entity = this.entities.get(id);\n            // Cleanup logic (e.g., destroy VIB3Engine instance)\n            if (entity.destroy) entity.destroy();\n            \n            this.entities.delete(id);\n            this.emit('entityDespawned', { id });\n            console.log(`VIB3Orchestrator: Killed entity ${id}`);\n        }\n    }\n\n    /**\n     * The main simulation loop.\n     * Prioritizes Physics -> Narrative -> Visuals.\n     * @param {number} timestamp \n     */\n    tick(timestamp) {\n        if (!this.running) return;\n\n        const dt = (timestamp - this.lastFrameTime) / 1000;\n        this.lastFrameTime = timestamp;\n        this.time += dt;\n\n        // 1. Physics / Logic Update\n        this.entities.forEach(entity => {\n            if (entity.active && entity.update) {\n                entity.update(this.time, dt);\n            }\n        });\n\n        // 2. Event Processing (Mock)\n        // Check for collisions, triggers, etc.\n\n        // 3. Visual Sync (Mock)\n        // Ensure all entities are rendering the current frame\n\n        requestAnimationFrame(this.tick);\n    }\n\n    /**\n     * Emit a global universe event.\n     * @param {string} name \n     * @param {object} detail \n     */\n    emit(name, detail) {\n        const event = new CustomEvent(name, { detail });\n        this.eventBus.dispatchEvent(event);\n    }\n\n    /**\n     * Listen for global universe events.\n     * @param {string} name \n     * @param {function} callback \n     */\n    on(name, callback) {\n        this.eventBus.addEventListener(name, (e) => callback(e.detail));\n    }\n}\n","/**\n * VIB3Compositor - Visual Layering and Scene Management\n * \n * Handles the complexity of rendering multiple VIB3+ instances into a cohesive visual.\n * Manages DOM structure, Z-indexing, masking, and blend modes for \"Universe\" rendering.\n *\n * @experimental\n */\nexport class VIB3Compositor {\n    constructor(containerId = 'vib3-universe') {\n        this.containerId = containerId;\n        this.layers = []; // Ordered list of layer configs\n        this.activeInstances = new Map(); // instanceId -> DOM element\n        \n        // Ensure container exists\n        if (typeof document !== 'undefined') {\n            this.container = document.getElementById(containerId);\n            if (!this.container) {\n                this.container = document.createElement('div');\n                this.container.id = containerId;\n                this.container.style.position = 'relative';\n                this.container.style.width = '100vw';\n                this.container.style.height = '100vh';\n                this.container.style.overflow = 'hidden';\n                document.body.appendChild(this.container);\n            }\n        }\n    }\n\n    /**\n     * Register a VIB3 instance to be composited.\n     * @param {string} instanceId - Unique ID for the VIB3 instance\n     * @param {HTMLElement} canvasElement - The canvas element of the VIB3 instance\n     * @param {object} options - Layer configuration (zIndex, blendMode, opacity)\n     */\n    addInstance(instanceId, canvasElement, options = {}) {\n        if (this.activeInstances.has(instanceId)) {\n            console.warn(`VIB3Compositor: Instance ${instanceId} already registered.`);\n            return;\n        }\n\n        // Apply default styles for compositing\n        canvasElement.style.position = 'absolute';\n        canvasElement.style.top = '0';\n        canvasElement.style.left = '0';\n        canvasElement.style.width = '100%';\n        canvasElement.style.height = '100%';\n        \n        // Apply options\n        this.updateLayer(instanceId, options);\n\n        this.container.appendChild(canvasElement);\n        this.activeInstances.set(instanceId, canvasElement);\n        this.layers.push(instanceId);\n        \n        console.log(`VIB3Compositor: Added instance ${instanceId}`);\n    }\n\n    /**\n     * Remove a VIB3 instance from the compositor.\n     * @param {string} instanceId \n     */\n    removeInstance(instanceId) {\n        if (this.activeInstances.has(instanceId)) {\n            const canvasElement = this.activeInstances.get(instanceId);\n            if (canvasElement.parentNode) {\n                canvasElement.parentNode.removeChild(canvasElement);\n            }\n            this.activeInstances.delete(instanceId);\n            this.layers = this.layers.filter(id => id !== instanceId);\n            console.log(`VIB3Compositor: Removed instance ${instanceId}`);\n        }\n    }\n\n    /**\n     * Update visual properties of a layer.\n     * @param {string} instanceId \n     * @param {object} options - { zIndex, blendMode, opacity, visible }\n     */\n    updateLayer(instanceId, options) {\n        const canvasElement = this.activeInstances.get(instanceId);\n        if (!canvasElement) return;\n\n        if (options.zIndex !== undefined) canvasElement.style.zIndex = options.zIndex;\n        if (options.blendMode !== undefined) canvasElement.style.mixBlendMode = options.blendMode;\n        if (options.opacity !== undefined) canvasElement.style.opacity = options.opacity;\n        if (options.visible !== undefined) canvasElement.style.display = options.visible ? 'block' : 'none';\n        \n        // Handle masking if provided (experimental CSS mask)\n        if (options.maskImage) {\n            canvasElement.style.webkitMaskImage = `url(${options.maskImage})`;\n            canvasElement.style.maskImage = `url(${options.maskImage})`;\n        }\n    }\n\n    /**\n     * Reorder layers based on a list of IDs.\n     * @param {string[]} order - Array of instance IDs, from bottom to top\n     */\n    setLayerOrder(order) {\n        order.forEach((id, index) => {\n            this.updateLayer(id, { zIndex: index });\n        });\n        this.layers = order;\n    }\n\n    /**\n     * Clear all instances.\n     */\n    clear() {\n        this.activeInstances.forEach((el, id) => {\n            if (el.parentNode) el.parentNode.removeChild(el);\n        });\n        this.activeInstances.clear();\n        this.layers = [];\n    }\n}\n","/**\n * TransitionAnimator.js - VIB3+ Smooth Parameter Transition System\n *\n * Provides smooth animated transitions between arbitrary sets of VIB3+\n * parameters. Supports multiple concurrent transitions, a rich library of\n * easing functions, chainable sequences, cancellation, and completion\n * callbacks.\n *\n * @module creative/TransitionAnimator\n * @version 1.0.0\n * @author VIB3+ Creative Tooling - Phase B\n */\n\n/**\n * @typedef {Object} TransitionOptions\n * @property {Object<string, number>} params - Target parameter values keyed by name\n * @property {number} [duration=1000] - Transition duration in milliseconds\n * @property {string} [easing='easeInOut'] - Easing function name\n * @property {number} [delay=0] - Delay before starting (ms)\n * @property {Function} [onComplete] - Callback when this transition completes\n * @property {Function} [onUpdate] - Callback on each frame with progress (0-1)\n */\n\n/**\n * @typedef {Object} SequenceStep\n * @property {Object<string, number>} params - Target parameter values\n * @property {number} [duration=1000] - Step duration in milliseconds\n * @property {string} [easing='easeInOut'] - Easing function name\n * @property {number} [delay=0] - Delay before this step starts\n */\n\n/**\n * @typedef {Object} ActiveTransition\n * @property {string} id - Unique transition identifier\n * @property {Object<string, number>} fromValues - Starting parameter values\n * @property {Object<string, number>} toValues - Target parameter values\n * @property {number} startTime - Timestamp when the transition started (ms)\n * @property {number} duration - Total duration (ms)\n * @property {string} easing - Easing function name\n * @property {Function|null} onComplete - Completion callback\n * @property {Function|null} onUpdate - Per-frame callback\n * @property {boolean} cancelled - Whether this transition has been cancelled\n */\n\nlet _nextTransitionId = 0;\n\n/**\n * Smooth parameter transition animator for the VIB3+ engine.\n *\n * Transitions any set of VIB3+ parameters simultaneously from their current\n * values to target values over a configurable duration with configurable\n * easing. Multiple transitions can run concurrently, and transitions can\n * be chained into sequences.\n *\n * @example\n * const animator = new TransitionAnimator((name, value) => {\n *     engine.setParameter(name, value);\n * });\n *\n * // Simple transition\n * animator.transition({ hue: 120, intensity: 0.9 }, 1500, 'easeOut');\n *\n * // Sequence of transitions\n * animator.sequence([\n *     { params: { hue: 0, chaos: 0.8 }, duration: 1000, easing: 'elastic' },\n *     { params: { hue: 180, chaos: 0.1 }, duration: 2000, easing: 'easeInOut' },\n *     { params: { hue: 360, chaos: 0.5 }, duration: 1000, easing: 'bounce' }\n * ]);\n */\nexport class TransitionAnimator {\n    /**\n     * Create a new TransitionAnimator.\n     *\n     * @param {Function} parameterUpdateFn - Callback invoked as (paramName, value)\n     *   whenever a VIB3+ parameter should be updated.\n     * @param {Function} [parameterGetFn] - Optional callback to read current\n     *   parameter values, invoked as (paramName) => number. If not provided,\n     *   transitions will use the target values of any currently running\n     *   transition or fall back to VIB3+ defaults.\n     */\n    constructor(parameterUpdateFn, parameterGetFn = null) {\n        if (typeof parameterUpdateFn !== 'function') {\n            throw new Error('TransitionAnimator requires a parameterUpdateFn callback');\n        }\n\n        /** @type {Function} */\n        this.updateParameter = parameterUpdateFn;\n\n        /** @type {Function|null} */\n        this.getParameter = typeof parameterGetFn === 'function' ? parameterGetFn : null;\n\n        /** @type {Map<string, ActiveTransition>} Active transitions keyed by ID */\n        this.activeTransitions = new Map();\n\n        /** @type {Array<{steps: SequenceStep[], currentIndex: number, id: string, onComplete: Function|null}>} */\n        this.sequences = [];\n\n        /** @type {number|null} requestAnimationFrame ID */\n        this._frameId = null;\n\n        /** @type {Object<string, number>} Snapshot of last-known parameter values */\n        this._knownValues = {};\n\n        /**\n         * Map of all available easing functions.\n         * @type {Object<string, Function>}\n         */\n        this.easingFunctions = this._buildEasingFunctions();\n    }\n\n    // -------------------------------------------------------------------------\n    // Public API - Transitions\n    // -------------------------------------------------------------------------\n\n    /**\n     * Start a transition to the given parameter values.\n     *\n     * @param {Object<string, number>} params - Target parameter values\n     * @param {number} [duration=1000] - Duration in milliseconds\n     * @param {string} [easing='easeInOut'] - Easing function name\n     * @param {Function} [onComplete] - Callback when complete\n     * @param {Function} [onUpdate] - Callback on each frame with progress (0-1)\n     * @returns {string} Transition ID (can be used to cancel)\n     */\n    transition(params, duration = 1000, easing = 'easeInOut', onComplete = null, onUpdate = null) {\n        if (!params || typeof params !== 'object') {\n            console.warn('TransitionAnimator: params must be an object');\n            return null;\n        }\n\n        const id = `transition_${++_nextTransitionId}`;\n        const fromValues = {};\n\n        // Capture starting values for each parameter\n        for (const paramName of Object.keys(params)) {\n            fromValues[paramName] = this._getCurrentValue(paramName);\n        }\n\n        /** @type {ActiveTransition} */\n        const record = {\n            id,\n            fromValues,\n            toValues: { ...params },\n            startTime: performance.now(),\n            duration: Math.max(0, duration),\n            easing: this.easingFunctions[easing] ? easing : 'easeInOut',\n            onComplete: typeof onComplete === 'function' ? onComplete : null,\n            onUpdate: typeof onUpdate === 'function' ? onUpdate : null,\n            cancelled: false\n        };\n\n        this.activeTransitions.set(id, record);\n        this._ensureAnimating();\n\n        return id;\n    }\n\n    /**\n     * Transition to a full target state (shorthand for `transition`).\n     *\n     * @param {Object<string, number>} targetState - Target parameter state\n     * @param {number} [duration=1000] - Duration in ms\n     * @param {string} [easing='easeInOut'] - Easing function name\n     * @param {Function} [onComplete] - Completion callback\n     * @returns {string} Transition ID\n     */\n    transitionTo(targetState, duration = 1000, easing = 'easeInOut', onComplete = null) {\n        return this.transition(targetState, duration, easing, onComplete);\n    }\n\n    /**\n     * Execute a sequence of transitions one after another.\n     *\n     * @param {SequenceStep[]} steps - Array of transition steps\n     * @param {Function} [onComplete] - Callback when the entire sequence finishes\n     * @returns {string} Sequence ID (can be used to cancel)\n     */\n    sequence(steps, onComplete = null) {\n        if (!Array.isArray(steps) || steps.length === 0) {\n            console.warn('TransitionAnimator: sequence requires a non-empty array of steps');\n            return null;\n        }\n\n        const seqId = `sequence_${++_nextTransitionId}`;\n\n        const seq = {\n            id: seqId,\n            steps: steps.map(step => ({\n                params: { ...step.params },\n                duration: step.duration != null ? step.duration : 1000,\n                easing: step.easing || 'easeInOut',\n                delay: step.delay || 0\n            })),\n            currentIndex: 0,\n            onComplete: typeof onComplete === 'function' ? onComplete : null\n        };\n\n        this.sequences.push(seq);\n        this._runNextSequenceStep(seq);\n\n        return seqId;\n    }\n\n    // -------------------------------------------------------------------------\n    // Public API - Cancellation\n    // -------------------------------------------------------------------------\n\n    /**\n     * Cancel a specific transition or sequence by ID.\n     *\n     * @param {string} id - Transition or sequence ID\n     * @returns {boolean} true if something was cancelled\n     */\n    cancel(id) {\n        // Try transitions first\n        const transition = this.activeTransitions.get(id);\n        if (transition) {\n            transition.cancelled = true;\n            this.activeTransitions.delete(id);\n            return true;\n        }\n\n        // Try sequences\n        const seqIndex = this.sequences.findIndex(s => s.id === id);\n        if (seqIndex >= 0) {\n            const seq = this.sequences[seqIndex];\n            // Cancel any active transition belonging to this sequence\n            for (const [tId, t] of this.activeTransitions) {\n                if (tId.startsWith(id + '_step_')) {\n                    t.cancelled = true;\n                    this.activeTransitions.delete(tId);\n                }\n            }\n            this.sequences.splice(seqIndex, 1);\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Cancel all active transitions and sequences immediately.\n     */\n    cancelAll() {\n        for (const [, transition] of this.activeTransitions) {\n            transition.cancelled = true;\n        }\n        this.activeTransitions.clear();\n        this.sequences.length = 0;\n\n        if (this._frameId !== null) {\n            cancelAnimationFrame(this._frameId);\n            this._frameId = null;\n        }\n    }\n\n    // -------------------------------------------------------------------------\n    // Public API - Queries\n    // -------------------------------------------------------------------------\n\n    /**\n     * Check if any transitions are currently active.\n     *\n     * @returns {boolean}\n     */\n    isAnimating() {\n        return this.activeTransitions.size > 0 || this.sequences.length > 0;\n    }\n\n    /**\n     * Get the number of active transitions.\n     *\n     * @returns {number}\n     */\n    getActiveCount() {\n        return this.activeTransitions.size;\n    }\n\n    /**\n     * Get the list of available easing function names.\n     *\n     * @returns {string[]}\n     */\n    getEasingNames() {\n        return Object.keys(this.easingFunctions);\n    }\n\n    // -------------------------------------------------------------------------\n    // Public API - Lifecycle\n    // -------------------------------------------------------------------------\n\n    /**\n     * Clean up resources and cancel all animations.\n     */\n    dispose() {\n        this.cancelAll();\n        this._knownValues = {};\n    }\n\n    // -------------------------------------------------------------------------\n    // Private - Animation Loop\n    // -------------------------------------------------------------------------\n\n    /**\n     * Ensure the animation loop is running.\n     * @private\n     */\n    _ensureAnimating() {\n        if (this._frameId === null) {\n            this._frameId = requestAnimationFrame(() => this._tick());\n        }\n    }\n\n    /**\n     * Main animation tick. Evaluates all active transitions.\n     * @private\n     */\n    _tick() {\n        this._frameId = null;\n        const now = performance.now();\n        const completed = [];\n\n        for (const [id, t] of this.activeTransitions) {\n            if (t.cancelled) {\n                completed.push(id);\n                continue;\n            }\n\n            const elapsed = now - t.startTime;\n            const rawProgress = t.duration > 0 ? Math.min(elapsed / t.duration, 1) : 1;\n            const easeFn = this.easingFunctions[t.easing] || this.easingFunctions.linear;\n            const eased = easeFn(rawProgress);\n\n            // Apply interpolated values\n            for (const paramName of Object.keys(t.toValues)) {\n                const from = t.fromValues[paramName];\n                const to = t.toValues[paramName];\n\n                // Special circular interpolation for hue\n                let value;\n                if (paramName === 'hue') {\n                    value = this._lerpHue(from, to, eased);\n                } else {\n                    value = from + (to - from) * eased;\n                }\n\n                this.updateParameter(paramName, value);\n                this._knownValues[paramName] = value;\n            }\n\n            // Per-frame callback\n            if (t.onUpdate) {\n                t.onUpdate(rawProgress);\n            }\n\n            // Check completion\n            if (rawProgress >= 1) {\n                completed.push(id);\n            }\n        }\n\n        // Process completions\n        for (const id of completed) {\n            const t = this.activeTransitions.get(id);\n            this.activeTransitions.delete(id);\n            if (t && !t.cancelled && t.onComplete) {\n                t.onComplete();\n            }\n        }\n\n        // Continue loop if there is still work\n        if (this.activeTransitions.size > 0) {\n            this._frameId = requestAnimationFrame(() => this._tick());\n        }\n    }\n\n    // -------------------------------------------------------------------------\n    // Private - Sequence Runner\n    // -------------------------------------------------------------------------\n\n    /**\n     * Run the next step in a sequence.\n     *\n     * @param {Object} seq - The sequence record\n     * @private\n     */\n    _runNextSequenceStep(seq) {\n        if (seq.currentIndex >= seq.steps.length) {\n            // Sequence complete\n            const idx = this.sequences.indexOf(seq);\n            if (idx >= 0) {\n                this.sequences.splice(idx, 1);\n            }\n            if (seq.onComplete) {\n                seq.onComplete();\n            }\n            return;\n        }\n\n        const step = seq.steps[seq.currentIndex];\n        const stepId = `${seq.id}_step_${seq.currentIndex}`;\n\n        const startStep = () => {\n            const fromValues = {};\n            for (const paramName of Object.keys(step.params)) {\n                fromValues[paramName] = this._getCurrentValue(paramName);\n            }\n\n            const record = {\n                id: stepId,\n                fromValues,\n                toValues: { ...step.params },\n                startTime: performance.now(),\n                duration: Math.max(0, step.duration),\n                easing: this.easingFunctions[step.easing] ? step.easing : 'easeInOut',\n                onComplete: () => {\n                    seq.currentIndex++;\n                    this._runNextSequenceStep(seq);\n                },\n                onUpdate: null,\n                cancelled: false\n            };\n\n            this.activeTransitions.set(stepId, record);\n            this._ensureAnimating();\n        };\n\n        if (step.delay > 0) {\n            setTimeout(startStep, step.delay);\n        } else {\n            startStep();\n        }\n    }\n\n    // -------------------------------------------------------------------------\n    // Private - Value Resolution\n    // -------------------------------------------------------------------------\n\n    /**\n     * Get the current value for a parameter.\n     *\n     * Priority:\n     * 1. External getter function (if provided)\n     * 2. Last known value from a transition\n     * 3. VIB3+ parameter defaults\n     *\n     * @param {string} paramName\n     * @returns {number}\n     * @private\n     */\n    _getCurrentValue(paramName) {\n        // Try external getter first\n        if (this.getParameter) {\n            const val = this.getParameter(paramName);\n            if (typeof val === 'number' && Number.isFinite(val)) {\n                return val;\n            }\n        }\n\n        // Check last known value from a completed/in-progress transition\n        if (paramName in this._knownValues) {\n            return this._knownValues[paramName];\n        }\n\n        // Check in-flight transitions for target value\n        for (const [, t] of this.activeTransitions) {\n            if (paramName in t.toValues) {\n                return t.toValues[paramName];\n            }\n        }\n\n        // Fall back to VIB3+ defaults\n        return this._getDefaultValue(paramName);\n    }\n\n    /**\n     * VIB3+ default parameter values as defined in Parameters.js.\n     *\n     * @param {string} paramName\n     * @returns {number}\n     * @private\n     */\n    _getDefaultValue(paramName) {\n        const defaults = {\n            hue: 200,\n            saturation: 0.8,\n            intensity: 0.5,\n            speed: 1.0,\n            chaos: 0.2,\n            morphFactor: 1.0,\n            gridDensity: 15,\n            dimension: 3.5,\n            geometry: 0,\n            rot4dXY: 0,\n            rot4dXZ: 0,\n            rot4dYZ: 0,\n            rot4dXW: 0,\n            rot4dYW: 0,\n            rot4dZW: 0\n        };\n        return defaults[paramName] !== undefined ? defaults[paramName] : 0;\n    }\n\n    // -------------------------------------------------------------------------\n    // Private - Math Utilities\n    // -------------------------------------------------------------------------\n\n    /**\n     * Circular hue interpolation (shortest path around 360-degree wheel).\n     *\n     * @param {number} a - Start hue (0-360)\n     * @param {number} b - End hue (0-360)\n     * @param {number} t - Progress (0-1)\n     * @returns {number}\n     * @private\n     */\n    _lerpHue(a, b, t) {\n        let diff = b - a;\n        if (diff > 180) diff -= 360;\n        if (diff < -180) diff += 360;\n        let result = a + diff * t;\n        if (result < 0) result += 360;\n        if (result >= 360) result -= 360;\n        return result;\n    }\n\n    /**\n     * Build the complete set of easing functions.\n     *\n     * @returns {Object<string, Function>}\n     * @private\n     */\n    _buildEasingFunctions() {\n        return {\n            /**\n             * No easing, constant velocity.\n             * @param {number} t\n             * @returns {number}\n             */\n            linear(t) {\n                return t;\n            },\n\n            /**\n             * Cubic acceleration from zero velocity.\n             * @param {number} t\n             * @returns {number}\n             */\n            easeIn(t) {\n                return t * t * t;\n            },\n\n            /**\n             * Cubic deceleration to zero velocity.\n             * @param {number} t\n             * @returns {number}\n             */\n            easeOut(t) {\n                return 1 - Math.pow(1 - t, 3);\n            },\n\n            /**\n             * Cubic acceleration then deceleration.\n             * @param {number} t\n             * @returns {number}\n             */\n            easeInOut(t) {\n                return t < 0.5\n                    ? 4 * t * t * t\n                    : 1 - Math.pow(-2 * t + 2, 3) / 2;\n            },\n\n            /**\n             * Quadratic ease-in.\n             * @param {number} t\n             * @returns {number}\n             */\n            easeInQuad(t) {\n                return t * t;\n            },\n\n            /**\n             * Quadratic ease-out.\n             * @param {number} t\n             * @returns {number}\n             */\n            easeOutQuad(t) {\n                return 1 - (1 - t) * (1 - t);\n            },\n\n            /**\n             * Bounce effect that simulates a ball bouncing to rest.\n             * @param {number} t\n             * @returns {number}\n             */\n            bounce(t) {\n                const n1 = 7.5625;\n                const d1 = 2.75;\n\n                if (t < 1 / d1) {\n                    return n1 * t * t;\n                } else if (t < 2 / d1) {\n                    return n1 * (t -= 1.5 / d1) * t + 0.75;\n                } else if (t < 2.5 / d1) {\n                    return n1 * (t -= 2.25 / d1) * t + 0.9375;\n                } else {\n                    return n1 * (t -= 2.625 / d1) * t + 0.984375;\n                }\n            },\n\n            /**\n             * Elastic oscillation that overshoots then settles.\n             * @param {number} t\n             * @returns {number}\n             */\n            elastic(t) {\n                if (t === 0 || t === 1) return t;\n                const c4 = (2 * Math.PI) / 3;\n                return Math.pow(2, -10 * t) * Math.sin((t * 10 - 0.75) * c4) + 1;\n            },\n\n            /**\n             * Smooth cubic Bezier-style ease.\n             * @param {number} t\n             * @returns {number}\n             */\n            cubic(t) {\n                return t < 0.5\n                    ? 4 * t * t * t\n                    : 1 - Math.pow(-2 * t + 2, 3) / 2;\n            },\n\n            /**\n             * Back ease-out: slightly overshoots then returns.\n             * @param {number} t\n             * @returns {number}\n             */\n            backOut(t) {\n                const c1 = 1.70158;\n                const c3 = c1 + 1;\n                return 1 + c3 * Math.pow(t - 1, 3) + c1 * Math.pow(t - 1, 2);\n            },\n\n            /**\n             * Back ease-in: pulls back before accelerating.\n             * @param {number} t\n             * @returns {number}\n             */\n            backIn(t) {\n                const c1 = 1.70158;\n                const c3 = c1 + 1;\n                return c3 * t * t * t - c1 * t * t;\n            },\n\n            /**\n             * Exponential ease-out.\n             * @param {number} t\n             * @returns {number}\n             */\n            expoOut(t) {\n                return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);\n            },\n\n            /**\n             * Exponential ease-in.\n             * @param {number} t\n             * @returns {number}\n             */\n            expoIn(t) {\n                return t === 0 ? 0 : Math.pow(2, 10 * t - 10);\n            },\n\n            /**\n             * Sinusoidal ease-in-out.\n             * @param {number} t\n             * @returns {number}\n             */\n            sineInOut(t) {\n                return -(Math.cos(Math.PI * t) - 1) / 2;\n            }\n        };\n    }\n}\n","/**\n * VIB3Actor - A VIB3+ Entity with Personality\n * \n * Wraps a VIB3Engine instance with emotional state and expression logic.\n * Actors can \"emote\" (transition parameters based on mood) and \"speak\" \n * (modulate geometry).\n *\n * @experimental\n */\nimport { TransitionAnimator } from '../creative/TransitionAnimator.js';\n\nexport class VIB3Actor {\n    /**\n     * @param {VIB3Engine} engine - The VIB3 engine instance\n     * @param {string|object} profile - Personality profile name or object\n     */\n    constructor(engine, profile = 'neutral') {\n        this.engine = engine;\n        this.id = `actor_${Math.random().toString(36).substr(2, 9)}`;\n        this.active = true;\n        \n        // Emotional State (-1.0 to 1.0)\n        this.emotion = { \n            valence: 0, // Positive/Negative\n            arousal: 0  // High/Low Energy\n        };\n\n        // Animation system\n        this.animator = new TransitionAnimator(\n            (k, v) => this.engine.setParameter(k, v),\n            (k) => this.engine.getParameter(k)\n        );\n\n        // Load profile\n        this.profile = typeof profile === 'string' ? this._getProfile(profile) : profile;\n        \n        // Apply base state\n        this.reset();\n    }\n\n    /**\n     * Update loop called by Orchestrator.\n     * @param {number} time - Total elapsed simulation time\n     * @param {number} dt - Delta time in seconds\n     */\n    update(time, dt) {\n        if (!this.active) return;\n        \n        // Idle behavior (breathing)\n        // Sync morphFactor to universe time\n        const breath = Math.sin(time * 2.0) * 0.1; // 2.0 rad/s\n        \n        // Apply breath modulation on top of base profile\n        // Note: This is a simple additive modulation. \n        // A real system would blend this with active transitions.\n        const currentMorph = this.engine.getParameter('morphFactor') || 1.0;\n        // Only modulate if not transitioning heavily\n        if (!this.animator.isAnimating()) {\n             // Gentle idle sway\n             this.engine.setParameter('morphFactor', 1.0 + breath);\n        }\n    }\n\n    /**\n     * Express an emotion.\n     * @param {string} emotionName - e.g., 'joy', 'anger', 'fear', 'sadness'\n     * @param {number} intensity - 0.0 to 1.0\n     * @param {number} duration - Transition duration in ms\n     */\n    emote(emotionName, intensity = 1.0, duration = 1000) {\n        const mapping = this.profile.emotions[emotionName];\n        if (!mapping) {\n            console.warn(`VIB3Actor: Unknown emotion '${emotionName}' for profile '${this.profile.name}'`);\n            return;\n        }\n\n        const targetParams = {};\n        for (const [param, baseVal] of Object.entries(mapping)) {\n            // Lerp between current/neutral and target based on intensity\n            // Simplified: just setting target value scaled by intensity logic could go here\n            // For now, we just use the mapped value directly as the \"100% intensity\" target\n            targetParams[param] = baseVal; \n        }\n\n        // Apply global intensity modifiers\n        if (targetParams.intensity) targetParams.intensity *= intensity;\n        if (targetParams.speed) targetParams.speed *= intensity;\n\n        this.animator.transition(targetParams, duration, 'easeOut');\n        \n        // Update internal state (simplified)\n        this.emotion.lastEmote = emotionName;\n    }\n\n    /**\n     * Reset to neutral state.\n     */\n    reset(duration = 1000) {\n        this.animator.transition(this.profile.base, duration, 'easeInOut');\n    }\n\n    /**\n     * Get a predefined personality profile.\n     * @param {string} name \n     */\n    _getProfile(name) {\n        const profiles = {\n            neutral: {\n                name: 'neutral',\n                base: { hue: 200, saturation: 0.5, intensity: 0.5, chaos: 0, speed: 1.0, gridDensity: 20 },\n                emotions: {\n                    joy: { hue: 50, saturation: 1.0, intensity: 0.8, speed: 2.0, chaos: 0.2 },\n                    anger: { hue: 0, saturation: 1.0, intensity: 0.9, speed: 3.0, chaos: 0.8 },\n                    sadness: { hue: 240, saturation: 0.2, intensity: 0.3, speed: 0.2, chaos: 0 },\n                    fear: { hue: 280, saturation: 0.8, intensity: 0.6, speed: 2.5, chaos: 0.9, gridDensity: 50 }\n                }\n            },\n            heroic: {\n                name: 'heroic',\n                base: { hue: 210, saturation: 0.8, intensity: 0.7, chaos: 0.1, speed: 1.0, gridDensity: 15 },\n                emotions: {\n                    joy: { hue: 50, saturation: 1.0, intensity: 1.0, speed: 1.5, morphFactor: 1.2 },\n                    anger: { hue: 20, saturation: 1.0, intensity: 1.0, speed: 2.5, chaos: 0.5 },\n                    determination: { hue: 220, saturation: 0.9, intensity: 0.9, speed: 1.2, gridDensity: 10 }\n                }\n            },\n            glitch: {\n                name: 'glitch',\n                base: { hue: 120, saturation: 0.0, intensity: 0.4, chaos: 0.5, speed: 2.0, gridDensity: 40 },\n                emotions: {\n                    panic: { hue: 0, saturation: 0, intensity: 0.9, speed: 5.0, chaos: 1.0, rot4dXW: 1.5 },\n                    calm: { hue: 120, saturation: 0.5, intensity: 0.4, speed: 0.5, chaos: 0.2 }\n                }\n            }\n        };\n        return profiles[name] || profiles.neutral;\n    }\n}\n","/**\n * CanvasManager - Creates and manages 5-layer canvas architecture per system.\n *\n * Provides the API surface expected by VIB3Engine:\n *   constructor(containerId)\n *   createSystemCanvases(systemName) -> string[]\n *   registerContext(canvasId, gl)\n *   destroy()\n */\n\nexport class CanvasManager {\n    constructor(containerId = 'vib3-container') {\n        this.containerId = containerId;\n        this.container = (typeof document !== 'undefined')\n            ? document.getElementById(containerId)\n            : null;\n        this.currentSystem = null;\n        this.createdCanvases = [];\n        this.registeredContexts = new Map();\n    }\n\n    /**\n     * Create 5 canvases with system-appropriate IDs inside the container.\n     * Returns the array of canvas IDs created.\n     */\n    createSystemCanvases(systemName) {\n        // Tear down previous canvases\n        this._removeCreatedCanvases();\n\n        const canvasIds = this._getCanvasIdsForSystem(systemName);\n\n        if (this.container) {\n            const viewWidth = this.container.clientWidth || (typeof window !== 'undefined' ? window.innerWidth : 800);\n            const viewHeight = this.container.clientHeight || (typeof window !== 'undefined' ? window.innerHeight : 600);\n            const dpr = (typeof window !== 'undefined') ? Math.min(window.devicePixelRatio || 1, 2) : 1;\n\n            canvasIds.forEach((canvasId, index) => {\n                const canvas = document.createElement('canvas');\n                canvas.id = canvasId;\n                canvas.className = 'visualization-canvas';\n                canvas.style.position = 'absolute';\n                canvas.style.top = '0';\n                canvas.style.left = '0';\n                canvas.style.width = '100%';\n                canvas.style.height = '100%';\n                canvas.style.zIndex = String(index + 1);\n                canvas.width = viewWidth * dpr;\n                canvas.height = viewHeight * dpr;\n                this.container.appendChild(canvas);\n                this.createdCanvases.push(canvas);\n            });\n        }\n\n        this.currentSystem = systemName;\n        return canvasIds;\n    }\n\n    /**\n     * Track a WebGL context so we can force-lose it during cleanup.\n     */\n    registerContext(canvasId, gl) {\n        this.registeredContexts.set(canvasId, gl);\n    }\n\n    /**\n     * Destroy all managed canvases and force-lose registered WebGL contexts.\n     */\n    destroy() {\n        // Force-lose all tracked contexts\n        for (const [, gl] of this.registeredContexts) {\n            try {\n                const ext = gl.getExtension('WEBGL_lose_context');\n                if (ext) ext.loseContext();\n            } catch (_) { /* context may already be lost */ }\n        }\n        this.registeredContexts.clear();\n\n        this._removeCreatedCanvases();\n        this.currentSystem = null;\n    }\n\n    // ── Private helpers ──\n\n    _removeCreatedCanvases() {\n        for (const canvas of this.createdCanvases) {\n            canvas.remove();\n        }\n        this.createdCanvases = [];\n    }\n\n    _getCanvasIdsForSystem(systemName) {\n        const baseIds = [\n            'background-canvas', 'shadow-canvas', 'content-canvas',\n            'highlight-canvas', 'accent-canvas'\n        ];\n\n        switch (systemName) {\n            case 'faceted':\n                return baseIds;\n            case 'quantum':\n                return baseIds.map(id => `quantum-${id}`);\n            case 'holographic':\n                return baseIds.map(id => `holo-${id}`);\n            case 'polychora':\n                return baseIds.map(id => `polychora-${id}`);\n            default:\n                return baseIds;\n        }\n    }\n}\n","/**\n * VIB3+ ReactivityConfig\n *\n * Unified configuration schema for all reactivity inputs:\n * - Audio frequency band mappings\n * - Device tilt/gyroscope mappings\n * - Mouse/touch/click interaction modes\n *\n * This config is exported with VIB3Package for portable behavior.\n */\n\n/**\n * Valid parameter names that can be targeted by reactivity\n */\nexport const TARGETABLE_PARAMETERS = [\n    'rot4dXY', 'rot4dXZ', 'rot4dYZ',  // 3D rotations\n    'rot4dXW', 'rot4dYW', 'rot4dZW',  // 4D rotations\n    'gridDensity', 'morphFactor', 'chaos', 'speed',\n    'hue', 'intensity', 'saturation', 'dimension',\n    'geometry'\n];\n\n/**\n * Audio band names\n */\nexport const AUDIO_BANDS = ['bass', 'mid', 'high'];\n\n/**\n * Reactivity blend modes\n */\nexport const BLEND_MODES = ['add', 'multiply', 'replace', 'max', 'min'];\n\n/**\n * Interaction modes for different input types\n */\nexport const INTERACTION_MODES = {\n    mouse: ['rotation', 'velocity', 'shimmer', 'attract', 'repel', 'none'],\n    click: ['burst', 'blast', 'ripple', 'pulse', 'none'],\n    scroll: ['cycle', 'wave', 'sweep', 'zoom', 'morph', 'none']\n};\n\n/**\n * Default ReactivityConfig\n */\nexport const DEFAULT_REACTIVITY_CONFIG = {\n    version: '1.0',\n\n    audio: {\n        enabled: false,\n        globalSensitivity: 1.0,\n        smoothing: 0.8,\n        bands: {\n            bass: {\n                enabled: true,\n                sensitivity: 1.5,\n                frequencyRange: [20, 250],\n                targets: [\n                    { param: 'morphFactor', weight: 0.8, mode: 'add' },\n                    { param: 'intensity', weight: 0.3, mode: 'multiply' }\n                ]\n            },\n            mid: {\n                enabled: true,\n                sensitivity: 1.0,\n                frequencyRange: [250, 2000],\n                targets: [\n                    { param: 'chaos', weight: 0.5, mode: 'add' }\n                ]\n            },\n            high: {\n                enabled: true,\n                sensitivity: 0.8,\n                frequencyRange: [2000, 20000],\n                targets: [\n                    { param: 'speed', weight: 0.4, mode: 'add' },\n                    { param: 'hue', weight: 15, mode: 'add' }\n                ]\n            }\n        }\n    },\n\n    tilt: {\n        enabled: false,\n        sensitivity: 1.0,\n        smoothing: 0.1,\n        dramaticMode: false,\n        calibrated: false,\n        calibrationOffset: { alpha: 0, beta: 0, gamma: 0 },\n        mappings: {\n            // Device axis -> rotation parameter\n            alpha: { target: 'rot4dXY', scale: 0.006, clamp: [-3.14, 3.14] },\n            beta: { target: 'rot4dXW', scale: 0.01, clamp: [-1.5, 1.5] },\n            gamma: { target: 'rot4dYW', scale: 0.015, clamp: [-1.5, 1.5] }\n        },\n        dramaticMappings: {\n            // 8x more sensitive for dramatic mode\n            alpha: { target: 'rot4dXY', scale: 0.048, clamp: [-6.28, 6.28] },\n            beta: { target: 'rot4dXW', scale: 0.08, clamp: [-6.0, 6.0] },\n            gamma: { target: 'rot4dYW', scale: 0.12, clamp: [-6.0, 6.0] }\n        }\n    },\n\n    interaction: {\n        enabled: true,\n\n        mouse: {\n            enabled: true,\n            mode: 'rotation',\n            sensitivity: 1.0,\n            smoothing: 0.15,\n            targets: ['rot4dXY', 'rot4dYZ'],\n            invertX: false,\n            invertY: false\n        },\n\n        click: {\n            enabled: true,\n            mode: 'burst',\n            intensity: 1.0,\n            decay: 0.92,\n            target: 'morphFactor',\n            maxValue: 2.0\n        },\n\n        scroll: {\n            enabled: true,\n            mode: 'cycle',\n            sensitivity: 1.0,\n            target: 'geometry',\n            wrap: true,\n            step: 1\n        },\n\n        touch: {\n            enabled: true,\n            multiTouchEnabled: true,\n            pinchZoom: { enabled: true, target: 'dimension', sensitivity: 0.01 },\n            twoFingerRotate: { enabled: true, target: 'rot4dZW', sensitivity: 0.02 },\n            swipeGestures: true\n        }\n    }\n};\n\n/**\n * ReactivityConfig class\n * Manages, validates, and serializes reactivity configuration\n */\nexport class ReactivityConfig {\n    constructor(config = null) {\n        this.config = this.deepClone(DEFAULT_REACTIVITY_CONFIG);\n\n        if (config) {\n            this.merge(config);\n        }\n    }\n\n    /**\n     * Deep clone an object\n     */\n    deepClone(obj) {\n        return JSON.parse(JSON.stringify(obj));\n    }\n\n    /**\n     * Merge partial config into current config\n     */\n    merge(partialConfig) {\n        this.deepMerge(this.config, partialConfig);\n        return this;\n    }\n\n    /**\n     * Deep merge source into target\n     */\n    deepMerge(target, source) {\n        for (const key in source) {\n            if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {\n                if (!target[key]) target[key] = {};\n                this.deepMerge(target[key], source[key]);\n            } else {\n                target[key] = source[key];\n            }\n        }\n    }\n\n    /**\n     * Validate the configuration\n     * @returns {{ valid: boolean, errors: string[] }}\n     */\n    validate() {\n        const errors = [];\n\n        // Validate audio config\n        if (this.config.audio) {\n            const audio = this.config.audio;\n\n            if (typeof audio.globalSensitivity !== 'number' ||\n                audio.globalSensitivity < 0 || audio.globalSensitivity > 10) {\n                errors.push('audio.globalSensitivity must be a number between 0 and 10');\n            }\n\n            for (const band of AUDIO_BANDS) {\n                if (audio.bands && audio.bands[band]) {\n                    const bandConfig = audio.bands[band];\n\n                    if (bandConfig.targets) {\n                        for (const target of bandConfig.targets) {\n                            if (!TARGETABLE_PARAMETERS.includes(target.param)) {\n                                errors.push(`audio.bands.${band}.targets: invalid parameter \"${target.param}\"`);\n                            }\n                            if (!BLEND_MODES.includes(target.mode)) {\n                                errors.push(`audio.bands.${band}.targets: invalid mode \"${target.mode}\"`);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        // Validate tilt config\n        if (this.config.tilt) {\n            const tilt = this.config.tilt;\n\n            if (typeof tilt.sensitivity !== 'number' ||\n                tilt.sensitivity < 0.1 || tilt.sensitivity > 10) {\n                errors.push('tilt.sensitivity must be a number between 0.1 and 10');\n            }\n\n            if (tilt.mappings) {\n                for (const axis of ['alpha', 'beta', 'gamma']) {\n                    if (tilt.mappings[axis] && tilt.mappings[axis].target) {\n                        if (!TARGETABLE_PARAMETERS.includes(tilt.mappings[axis].target)) {\n                            errors.push(`tilt.mappings.${axis}.target: invalid parameter`);\n                        }\n                    }\n                }\n            }\n        }\n\n        // Validate interaction config\n        if (this.config.interaction) {\n            const interaction = this.config.interaction;\n\n            if (interaction.mouse && interaction.mouse.mode) {\n                if (!INTERACTION_MODES.mouse.includes(interaction.mouse.mode)) {\n                    errors.push(`interaction.mouse.mode: invalid mode \"${interaction.mouse.mode}\"`);\n                }\n            }\n\n            if (interaction.click && interaction.click.mode) {\n                if (!INTERACTION_MODES.click.includes(interaction.click.mode)) {\n                    errors.push(`interaction.click.mode: invalid mode \"${interaction.click.mode}\"`);\n                }\n            }\n\n            if (interaction.scroll && interaction.scroll.mode) {\n                if (!INTERACTION_MODES.scroll.includes(interaction.scroll.mode)) {\n                    errors.push(`interaction.scroll.mode: invalid mode \"${interaction.scroll.mode}\"`);\n                }\n            }\n        }\n\n        return {\n            valid: errors.length === 0,\n            errors\n        };\n    }\n\n    // ==================== GETTERS ====================\n\n    /**\n     * Get full config\n     */\n    getConfig() {\n        return this.deepClone(this.config);\n    }\n\n    /**\n     * Get audio config\n     */\n    getAudioConfig() {\n        return this.deepClone(this.config.audio);\n    }\n\n    /**\n     * Get tilt config\n     */\n    getTiltConfig() {\n        return this.deepClone(this.config.tilt);\n    }\n\n    /**\n     * Get interaction config\n     */\n    getInteractionConfig() {\n        return this.deepClone(this.config.interaction);\n    }\n\n    // ==================== SETTERS ====================\n\n    /**\n     * Enable/disable audio reactivity\n     */\n    setAudioEnabled(enabled) {\n        this.config.audio.enabled = !!enabled;\n        return this;\n    }\n\n    /**\n     * Set audio band configuration\n     */\n    setAudioBand(band, config) {\n        if (!AUDIO_BANDS.includes(band)) {\n            throw new Error(`Invalid audio band: ${band}`);\n        }\n        this.deepMerge(this.config.audio.bands[band], config);\n        return this;\n    }\n\n    /**\n     * Add a target to an audio band\n     */\n    addAudioTarget(band, param, weight = 1.0, mode = 'add') {\n        if (!AUDIO_BANDS.includes(band)) {\n            throw new Error(`Invalid audio band: ${band}`);\n        }\n        if (!TARGETABLE_PARAMETERS.includes(param)) {\n            throw new Error(`Invalid parameter: ${param}`);\n        }\n        if (!BLEND_MODES.includes(mode)) {\n            throw new Error(`Invalid blend mode: ${mode}`);\n        }\n\n        this.config.audio.bands[band].targets.push({ param, weight, mode });\n        return this;\n    }\n\n    /**\n     * Clear all targets from an audio band\n     */\n    clearAudioTargets(band) {\n        if (!AUDIO_BANDS.includes(band)) {\n            throw new Error(`Invalid audio band: ${band}`);\n        }\n        this.config.audio.bands[band].targets = [];\n        return this;\n    }\n\n    /**\n     * Enable/disable tilt reactivity\n     */\n    setTiltEnabled(enabled) {\n        this.config.tilt.enabled = !!enabled;\n        return this;\n    }\n\n    /**\n     * Set tilt dramatic mode\n     */\n    setTiltDramaticMode(enabled) {\n        this.config.tilt.dramaticMode = !!enabled;\n        return this;\n    }\n\n    /**\n     * Set tilt sensitivity\n     */\n    setTiltSensitivity(sensitivity) {\n        this.config.tilt.sensitivity = Math.max(0.1, Math.min(10, sensitivity));\n        return this;\n    }\n\n    /**\n     * Set tilt axis mapping\n     */\n    setTiltMapping(axis, target, scale, clamp = null) {\n        if (!['alpha', 'beta', 'gamma'].includes(axis)) {\n            throw new Error(`Invalid axis: ${axis}`);\n        }\n        if (!TARGETABLE_PARAMETERS.includes(target)) {\n            throw new Error(`Invalid parameter: ${target}`);\n        }\n\n        this.config.tilt.mappings[axis] = {\n            target,\n            scale,\n            clamp: clamp || [-6.28, 6.28]\n        };\n        return this;\n    }\n\n    /**\n     * Enable/disable interaction\n     */\n    setInteractionEnabled(enabled) {\n        this.config.interaction.enabled = !!enabled;\n        return this;\n    }\n\n    /**\n     * Set mouse interaction mode\n     */\n    setMouseMode(mode, options = {}) {\n        if (!INTERACTION_MODES.mouse.includes(mode)) {\n            throw new Error(`Invalid mouse mode: ${mode}`);\n        }\n        this.config.interaction.mouse.mode = mode;\n        this.deepMerge(this.config.interaction.mouse, options);\n        return this;\n    }\n\n    /**\n     * Set click interaction mode\n     */\n    setClickMode(mode, options = {}) {\n        if (!INTERACTION_MODES.click.includes(mode)) {\n            throw new Error(`Invalid click mode: ${mode}`);\n        }\n        this.config.interaction.click.mode = mode;\n        this.deepMerge(this.config.interaction.click, options);\n        return this;\n    }\n\n    /**\n     * Set scroll interaction mode\n     */\n    setScrollMode(mode, options = {}) {\n        if (!INTERACTION_MODES.scroll.includes(mode)) {\n            throw new Error(`Invalid scroll mode: ${mode}`);\n        }\n        this.config.interaction.scroll.mode = mode;\n        this.deepMerge(this.config.interaction.scroll, options);\n        return this;\n    }\n\n    // ==================== SERIALIZATION ====================\n\n    /**\n     * Export to JSON\n     */\n    toJSON() {\n        return JSON.stringify(this.config, null, 2);\n    }\n\n    /**\n     * Import from JSON\n     */\n    static fromJSON(json) {\n        const parsed = typeof json === 'string' ? JSON.parse(json) : json;\n        return new ReactivityConfig(parsed);\n    }\n\n    /**\n     * Export minimal config (only non-default values)\n     */\n    toMinimalJSON() {\n        const minimal = {};\n        const defaults = DEFAULT_REACTIVITY_CONFIG;\n\n        // Only include values that differ from defaults\n        this.extractDifferences(this.config, defaults, minimal);\n\n        return JSON.stringify(minimal, null, 2);\n    }\n\n    /**\n     * Extract differences between current and default config\n     */\n    extractDifferences(current, defaults, result) {\n        for (const key in current) {\n            if (typeof current[key] === 'object' && !Array.isArray(current[key])) {\n                const subResult = {};\n                this.extractDifferences(current[key], defaults[key] || {}, subResult);\n                if (Object.keys(subResult).length > 0) {\n                    result[key] = subResult;\n                }\n            } else if (JSON.stringify(current[key]) !== JSON.stringify(defaults[key])) {\n                result[key] = current[key];\n            }\n        }\n    }\n\n    /**\n     * Create a copy\n     */\n    clone() {\n        return new ReactivityConfig(this.config);\n    }\n\n    /**\n     * Reset to defaults\n     */\n    reset() {\n        this.config = this.deepClone(DEFAULT_REACTIVITY_CONFIG);\n        return this;\n    }\n}\n\nexport default ReactivityConfig;\n","/**\n * VIB3+ ReactivityManager\n *\n * Coordinates all reactivity inputs (audio, tilt, interaction)\n * and applies them to the visualization parameters.\n *\n * This is the central hub that:\n * 1. Receives input from AudioReactivityEngine, TiltReactivityEngine, InteractionEngine\n * 2. Applies configured mappings from ReactivityConfig\n * 3. Updates visualization parameters through the parameter system\n */\n\nimport { ReactivityConfig, TARGETABLE_PARAMETERS, BLEND_MODES } from './ReactivityConfig.js';\n\n/**\n * ReactivityManager - Coordinates all reactivity systems\n */\nexport class ReactivityManager {\n    constructor(parameterUpdateFn = null) {\n        // Function to call when parameters need updating\n        this.updateParameter = parameterUpdateFn || window.updateParameter || this.defaultUpdateParameter.bind(this);\n\n        // ReactivityConfig instance\n        this.config = new ReactivityConfig();\n\n        // Current input values from various sources\n        this.inputState = {\n            audio: { bass: 0, mid: 0, high: 0, energy: 0 },\n            tilt: { alpha: 0, beta: 0, gamma: 0 },\n            mouse: { x: 0.5, y: 0.5, velocityX: 0, velocityY: 0 },\n            click: { intensity: 0, lastTime: 0 },\n            scroll: { delta: 0, accumulated: 0 },\n            touch: { touches: [], pinchScale: 1, rotation: 0 }\n        };\n\n        // Base parameter values (before reactivity applied)\n        this.baseParameters = {};\n\n        // Computed reactivity deltas\n        this.reactivityDeltas = {};\n\n        // Active state\n        this.isActive = false;\n        this.frameId = null;\n\n        // Event emitter for telemetry\n        this.listeners = new Map();\n\n        console.log('🎛️ ReactivityManager: Initialized');\n    }\n\n    /**\n     * Default parameter update function (fallback)\n     */\n    defaultUpdateParameter(name, value) {\n        console.log(`ReactivityManager: updateParameter(${name}, ${value})`);\n        // Store locally if no external handler\n        this.baseParameters[name] = value;\n    }\n\n    /**\n     * Set the parameter update function\n     */\n    setParameterUpdateFunction(fn) {\n        this.updateParameter = fn;\n    }\n\n    /**\n     * Load a ReactivityConfig\n     */\n    loadConfig(config) {\n        if (config instanceof ReactivityConfig) {\n            this.config = config;\n        } else {\n            this.config = new ReactivityConfig(config);\n        }\n\n        const validation = this.config.validate();\n        if (!validation.valid) {\n            console.warn('ReactivityManager: Config validation errors:', validation.errors);\n        }\n\n        this.emit('configChanged', this.config.getConfig());\n        console.log('🎛️ ReactivityManager: Config loaded');\n        return validation;\n    }\n\n    /**\n     * Get current config\n     */\n    getConfig() {\n        return this.config.getConfig();\n    }\n\n    /**\n     * Start the reactivity processing loop\n     */\n    start() {\n        if (this.isActive) return;\n\n        this.isActive = true;\n        this.processFrame();\n        console.log('🎛️ ReactivityManager: Started');\n        this.emit('started');\n    }\n\n    /**\n     * Stop the reactivity processing loop\n     */\n    stop() {\n        this.isActive = false;\n        if (this.frameId) {\n            cancelAnimationFrame(this.frameId);\n            this.frameId = null;\n        }\n        console.log('🎛️ ReactivityManager: Stopped');\n        this.emit('stopped');\n    }\n\n    /**\n     * Main processing loop\n     */\n    processFrame() {\n        if (!this.isActive) return;\n\n        // Process all input sources and compute deltas\n        this.computeReactivityDeltas();\n\n        // Apply deltas to parameters\n        this.applyDeltas();\n\n        // Schedule next frame\n        this.frameId = requestAnimationFrame(() => this.processFrame());\n    }\n\n    /**\n     * Compute reactivity deltas from all input sources\n     */\n    computeReactivityDeltas() {\n        // Reset deltas\n        this.reactivityDeltas = {};\n\n        const cfg = this.config.getConfig();\n\n        // Process audio reactivity\n        if (cfg.audio.enabled) {\n            this.processAudioReactivity(cfg.audio);\n        }\n\n        // Process tilt reactivity\n        if (cfg.tilt.enabled) {\n            this.processTiltReactivity(cfg.tilt);\n        }\n\n        // Process interaction reactivity\n        if (cfg.interaction.enabled) {\n            this.processInteractionReactivity(cfg.interaction);\n        }\n    }\n\n    /**\n     * Process audio input and compute parameter deltas\n     */\n    processAudioReactivity(audioConfig) {\n        const audio = this.inputState.audio;\n        const globalSens = audioConfig.globalSensitivity;\n\n        for (const [bandName, bandConfig] of Object.entries(audioConfig.bands)) {\n            if (!bandConfig.enabled) continue;\n\n            const bandValue = audio[bandName] || 0;\n            const scaledValue = bandValue * bandConfig.sensitivity * globalSens;\n\n            for (const target of bandConfig.targets) {\n                this.addDelta(target.param, scaledValue * target.weight, target.mode);\n            }\n        }\n    }\n\n    /**\n     * Process tilt input and compute parameter deltas\n     */\n    processTiltReactivity(tiltConfig) {\n        const tilt = this.inputState.tilt;\n        const mappings = tiltConfig.dramaticMode ? tiltConfig.dramaticMappings : tiltConfig.mappings;\n        const sens = tiltConfig.sensitivity;\n\n        for (const [axis, mapping] of Object.entries(mappings)) {\n            if (!mapping || !mapping.target) continue;\n\n            // Apply calibration offset\n            let axisValue = tilt[axis] || 0;\n            if (tiltConfig.calibrated && tiltConfig.calibrationOffset) {\n                axisValue -= tiltConfig.calibrationOffset[axis] || 0;\n            }\n\n            // Scale and clamp\n            let delta = axisValue * mapping.scale * sens;\n            if (mapping.clamp) {\n                delta = Math.max(mapping.clamp[0], Math.min(mapping.clamp[1], delta));\n            }\n\n            this.addDelta(mapping.target, delta, 'replace');\n        }\n    }\n\n    /**\n     * Process mouse/click/scroll/touch and compute parameter deltas\n     */\n    processInteractionReactivity(interactionConfig) {\n        // Mouse movement\n        if (interactionConfig.mouse.enabled) {\n            this.processMouseReactivity(interactionConfig.mouse);\n        }\n\n        // Click effects\n        if (interactionConfig.click.enabled) {\n            this.processClickReactivity(interactionConfig.click);\n        }\n\n        // Scroll effects\n        if (interactionConfig.scroll.enabled) {\n            this.processScrollReactivity(interactionConfig.scroll);\n        }\n\n        // Touch effects\n        if (interactionConfig.touch.enabled) {\n            this.processTouchReactivity(interactionConfig.touch);\n        }\n    }\n\n    /**\n     * Process mouse movement\n     */\n    processMouseReactivity(mouseConfig) {\n        const mouse = this.inputState.mouse;\n        const sens = mouseConfig.sensitivity;\n        const mode = mouseConfig.mode;\n\n        if (mode === 'none') return;\n\n        const targets = mouseConfig.targets || ['rot4dXY', 'rot4dYZ'];\n        const x = mouseConfig.invertX ? (1 - mouse.x) : mouse.x;\n        const y = mouseConfig.invertY ? (1 - mouse.y) : mouse.y;\n\n        switch (mode) {\n            case 'rotation':\n                // Map mouse position to rotation\n                if (targets[0]) this.addDelta(targets[0], (x - 0.5) * 2 * sens, 'replace');\n                if (targets[1]) this.addDelta(targets[1], (y - 0.5) * 2 * sens, 'replace');\n                break;\n\n            case 'velocity':\n                // Use mouse velocity\n                if (targets[0]) this.addDelta(targets[0], mouse.velocityX * sens * 0.1, 'add');\n                if (targets[1]) this.addDelta(targets[1], mouse.velocityY * sens * 0.1, 'add');\n                break;\n\n            case 'shimmer':\n                // High-frequency shimmer based on velocity magnitude\n                const velocity = Math.sqrt(mouse.velocityX ** 2 + mouse.velocityY ** 2);\n                this.addDelta('chaos', velocity * sens * 0.01, 'add');\n                break;\n\n            case 'attract':\n                // Pull visualization toward mouse\n                this.addDelta('morphFactor', (1 - Math.abs(x - 0.5) * 2) * sens, 'multiply');\n                break;\n\n            case 'repel':\n                // Push visualization away from mouse\n                this.addDelta('morphFactor', Math.abs(x - 0.5) * 2 * sens, 'multiply');\n                break;\n        }\n    }\n\n    /**\n     * Process click effects\n     */\n    processClickReactivity(clickConfig) {\n        const click = this.inputState.click;\n\n        // Decay click intensity\n        click.intensity *= clickConfig.decay;\n\n        if (click.intensity < 0.001) {\n            click.intensity = 0;\n            return;\n        }\n\n        const mode = clickConfig.mode;\n        const target = clickConfig.target;\n        const intensity = click.intensity * clickConfig.intensity;\n\n        switch (mode) {\n            case 'burst':\n                this.addDelta(target, intensity, 'add');\n                break;\n\n            case 'blast':\n                this.addDelta(target, intensity * 2, 'add');\n                this.addDelta('chaos', intensity * 0.5, 'add');\n                break;\n\n            case 'ripple':\n                this.addDelta(target, Math.sin(Date.now() * 0.01) * intensity, 'add');\n                break;\n\n            case 'pulse':\n                this.addDelta('intensity', intensity * 0.5, 'add');\n                this.addDelta('speed', intensity, 'add');\n                break;\n        }\n    }\n\n    /**\n     * Process scroll effects\n     */\n    processScrollReactivity(scrollConfig) {\n        const scroll = this.inputState.scroll;\n\n        if (Math.abs(scroll.delta) < 0.001) return;\n\n        const mode = scrollConfig.mode;\n        const target = scrollConfig.target;\n        const sens = scrollConfig.sensitivity;\n\n        switch (mode) {\n            case 'cycle':\n                // Cycle through values (e.g., geometry)\n                scroll.accumulated += scroll.delta * sens * scrollConfig.step;\n                if (Math.abs(scroll.accumulated) >= 1) {\n                    const steps = Math.floor(Math.abs(scroll.accumulated));\n                    const direction = scroll.accumulated > 0 ? 1 : -1;\n                    this.addDelta(target, steps * direction, 'add');\n                    scroll.accumulated -= steps * direction;\n                }\n                break;\n\n            case 'wave':\n                this.addDelta(target, scroll.delta * sens * 0.1, 'add');\n                break;\n\n            case 'sweep':\n                this.addDelta('hue', scroll.delta * sens * 10, 'add');\n                break;\n\n            case 'zoom':\n                this.addDelta('dimension', scroll.delta * sens * 0.01, 'add');\n                break;\n\n            case 'morph':\n                this.addDelta('morphFactor', scroll.delta * sens * 0.1, 'add');\n                break;\n        }\n\n        // Decay scroll delta\n        scroll.delta *= 0.9;\n    }\n\n    /**\n     * Process touch gestures\n     */\n    processTouchReactivity(touchConfig) {\n        const touch = this.inputState.touch;\n\n        if (touchConfig.pinchZoom.enabled && touch.pinchScale !== 1) {\n            const delta = (touch.pinchScale - 1) * touchConfig.pinchZoom.sensitivity;\n            this.addDelta(touchConfig.pinchZoom.target, delta, 'add');\n            touch.pinchScale = 1 + (touch.pinchScale - 1) * 0.9; // Decay\n        }\n\n        if (touchConfig.twoFingerRotate.enabled && touch.rotation !== 0) {\n            const delta = touch.rotation * touchConfig.twoFingerRotate.sensitivity;\n            this.addDelta(touchConfig.twoFingerRotate.target, delta, 'add');\n            touch.rotation *= 0.9; // Decay\n        }\n    }\n\n    /**\n     * Add a delta to a parameter\n     */\n    addDelta(param, value, mode = 'add') {\n        if (!TARGETABLE_PARAMETERS.includes(param)) {\n            console.warn(`ReactivityManager: Unknown parameter \"${param}\"`);\n            return;\n        }\n\n        if (!this.reactivityDeltas[param]) {\n            this.reactivityDeltas[param] = { value: 0, mode: 'add' };\n        }\n\n        const delta = this.reactivityDeltas[param];\n\n        switch (mode) {\n            case 'add':\n                delta.value += value;\n                delta.mode = 'add';\n                break;\n\n            case 'multiply':\n                delta.value = (delta.value || 1) * value;\n                delta.mode = 'multiply';\n                break;\n\n            case 'replace':\n                delta.value = value;\n                delta.mode = 'replace';\n                break;\n\n            case 'max':\n                delta.value = Math.max(delta.value, value);\n                delta.mode = 'max';\n                break;\n\n            case 'min':\n                delta.value = Math.min(delta.value, value);\n                delta.mode = 'min';\n                break;\n        }\n    }\n\n    /**\n     * Apply computed deltas to parameters\n     */\n    applyDeltas() {\n        for (const [param, delta] of Object.entries(this.reactivityDeltas)) {\n            if (Math.abs(delta.value) < 0.0001 && delta.mode !== 'replace') continue;\n\n            const baseValue = this.baseParameters[param] || 0;\n            let newValue;\n\n            switch (delta.mode) {\n                case 'add':\n                    newValue = baseValue + delta.value;\n                    break;\n                case 'multiply':\n                    newValue = baseValue * delta.value;\n                    break;\n                case 'replace':\n                    newValue = delta.value;\n                    break;\n                case 'max':\n                    newValue = Math.max(baseValue, delta.value);\n                    break;\n                case 'min':\n                    newValue = Math.min(baseValue, delta.value);\n                    break;\n                default:\n                    newValue = baseValue + delta.value;\n            }\n\n            // Guard against NaN propagation\n            if (!Number.isFinite(newValue)) continue;\n\n            // Apply the update\n            this.updateParameter(param, newValue);\n        }\n    }\n\n    // ==================== INPUT METHODS ====================\n\n    /**\n     * Update audio input values\n     */\n    setAudioInput(bass, mid, high, energy = null) {\n        this.inputState.audio.bass = Number.isFinite(bass) ? Math.max(0, Math.min(1, bass)) : 0;\n        this.inputState.audio.mid = Number.isFinite(mid) ? Math.max(0, Math.min(1, mid)) : 0;\n        this.inputState.audio.high = Number.isFinite(high) ? Math.max(0, Math.min(1, high)) : 0;\n        this.inputState.audio.energy = (energy !== null && Number.isFinite(energy))\n            ? energy\n            : (this.inputState.audio.bass + this.inputState.audio.mid + this.inputState.audio.high) / 3;\n    }\n\n    /**\n     * Update tilt input values\n     */\n    setTiltInput(alpha, beta, gamma) {\n        this.inputState.tilt.alpha = alpha;\n        this.inputState.tilt.beta = beta;\n        this.inputState.tilt.gamma = gamma;\n    }\n\n    /**\n     * Update mouse input values\n     */\n    setMouseInput(x, y, velocityX = 0, velocityY = 0) {\n        this.inputState.mouse.x = Number.isFinite(x) ? Math.max(0, Math.min(1, x)) : 0.5;\n        this.inputState.mouse.y = Number.isFinite(y) ? Math.max(0, Math.min(1, y)) : 0.5;\n        this.inputState.mouse.velocityX = Number.isFinite(velocityX) ? velocityX : 0;\n        this.inputState.mouse.velocityY = Number.isFinite(velocityY) ? velocityY : 0;\n    }\n\n    /**\n     * Trigger a click event\n     */\n    triggerClick(intensity = 1.0) {\n        this.inputState.click.intensity = Number.isFinite(intensity) ? Math.max(0, Math.min(2, intensity)) : 1.0;\n        this.inputState.click.lastTime = Date.now();\n    }\n\n    /**\n     * Update scroll delta\n     */\n    setScrollDelta(delta) {\n        if (Number.isFinite(delta)) {\n            this.inputState.scroll.delta += delta;\n        }\n    }\n\n    /**\n     * Update touch input\n     */\n    setTouchInput(touches, pinchScale = 1, rotation = 0) {\n        this.inputState.touch.touches = touches;\n        this.inputState.touch.pinchScale = pinchScale;\n        this.inputState.touch.rotation = rotation;\n    }\n\n    /**\n     * Set base parameter value (before reactivity)\n     */\n    setBaseParameter(param, value) {\n        this.baseParameters[param] = value;\n    }\n\n    /**\n     * Set all base parameters\n     */\n    setBaseParameters(params) {\n        this.baseParameters = { ...this.baseParameters, ...params };\n    }\n\n    // ==================== EVENT EMITTER ====================\n\n    /**\n     * Add event listener\n     */\n    on(event, callback) {\n        if (!this.listeners.has(event)) {\n            this.listeners.set(event, []);\n        }\n        this.listeners.get(event).push(callback);\n    }\n\n    /**\n     * Remove event listener\n     */\n    off(event, callback) {\n        if (this.listeners.has(event)) {\n            const callbacks = this.listeners.get(event);\n            const index = callbacks.indexOf(callback);\n            if (index > -1) {\n                callbacks.splice(index, 1);\n            }\n        }\n    }\n\n    /**\n     * Emit event\n     */\n    emit(event, data) {\n        if (this.listeners.has(event)) {\n            for (const callback of this.listeners.get(event)) {\n                try {\n                    callback(data);\n                } catch (e) {\n                    console.error(`ReactivityManager event handler error:`, e);\n                }\n            }\n        }\n    }\n\n    // ==================== CLEANUP ====================\n\n    /**\n     * Destroy and cleanup\n     */\n    destroy() {\n        this.stop();\n        this.listeners.clear();\n        console.log('🎛️ ReactivityManager: Destroyed');\n    }\n}\n\nexport default ReactivityManager;\n","/**\n * VIB3+ SpatialInputSystem\n *\n * Evolved spatial orientation input abstraction that maps ANY input source\n * to visualization parameters. Provides universal \"card tilting\" behavior\n * decoupled from physical device tilt -- mouse, gamepad, gyroscope, audio,\n * MIDI, AR perspective, and programmatic API all feed the same spatial state.\n *\n * Architecture:\n *   Input Sources --> Spatial State (pitch/yaw/roll/x/y/z) --> Smoothing --> Mapping --> Parameter Updates\n *\n * @module reactivity/SpatialInputSystem\n * @version 1.0.0\n */\n\nimport { TARGETABLE_PARAMETERS, BLEND_MODES } from './ReactivityConfig.js';\n\n// ---------------------------------------------------------------------------\n// Constants\n// ---------------------------------------------------------------------------\n\n/**\n * Recognised input source types.\n * @readonly\n * @enum {string}\n */\nexport const SOURCE_TYPES = Object.freeze({\n    DEVICE_TILT: 'deviceTilt',\n    MOUSE_POSITION: 'mousePosition',\n    GYROSCOPE: 'gyroscope',\n    GAMEPAD: 'gamepad',\n    PERSPECTIVE: 'perspective',\n    PROGRAMMATIC: 'programmatic',\n    AUDIO: 'audio',\n    MIDI: 'midi'\n});\n\n/**\n * Named spatial axes that form the normalised intermediate state.\n * All values are kept in the range -1 .. 1 (translations) or -1 .. 1\n * (rotational axes). `intensity` and `velocity` are 0 .. 1.\n * @readonly\n * @enum {string}\n */\nexport const SPATIAL_AXES = Object.freeze([\n    'pitch', 'yaw', 'roll',\n    'x', 'y', 'z',\n    'intensity', 'velocity'\n]);\n\n/**\n * Dramatic mode amplification factor (matches legacy DeviceTiltHandler).\n * @constant {number}\n */\nconst DRAMATIC_MULTIPLIER = 8;\n\n/**\n * Maximum number of concurrently registered input sources.\n * @constant {number}\n */\nconst MAX_SOURCES = 32;\n\n/**\n * Maximum number of active mappings.\n * @constant {number}\n */\nconst MAX_MAPPINGS = 256;\n\n// ---------------------------------------------------------------------------\n// Helpers\n// ---------------------------------------------------------------------------\n\n/**\n * Clamp a number between min and max.\n * @param {number} v\n * @param {number} lo\n * @param {number} hi\n * @returns {number}\n */\nfunction clamp(v, lo, hi) {\n    return v < lo ? lo : v > hi ? hi : v;\n}\n\n/**\n * Linear interpolation.\n * @param {number} a - Start value\n * @param {number} b - End value\n * @param {number} t - Interpolant (0..1)\n * @returns {number}\n */\nfunction lerp(a, b, t) {\n    return a + (b - a) * t;\n}\n\n/**\n * Create a fresh zero-valued spatial state object.\n * @returns {SpatialState}\n */\nfunction createSpatialState() {\n    return {\n        pitch: 0,\n        yaw: 0,\n        roll: 0,\n        x: 0,\n        y: 0,\n        z: 0,\n        intensity: 0,\n        velocity: 0\n    };\n}\n\n// ---------------------------------------------------------------------------\n// Type definitions (JSDoc only -- no TypeScript)\n// ---------------------------------------------------------------------------\n\n/**\n * @typedef {Object} SpatialState\n * @property {number} pitch   - Forward/back tilt (-1..1)\n * @property {number} yaw     - Left/right rotation (-1..1)\n * @property {number} roll    - Left/right tilt (-1..1)\n * @property {number} x       - Translation X (-1..1)\n * @property {number} y       - Translation Y (-1..1)\n * @property {number} z       - Translation Z / depth (-1..1)\n * @property {number} intensity - Overall spatial intensity (0..1)\n * @property {number} velocity  - Rate of change (0..1)\n */\n\n/**\n * @typedef {Object} MappingEntry\n * @property {string}   axis      - Source spatial axis name\n * @property {string}   target    - Target VIB3+ parameter name\n * @property {number}   scale     - Multiplier applied to axis value\n * @property {number[]} [clamp]   - Optional [min, max] to clamp mapped output\n * @property {string}   [blendMode] - One of BLEND_MODES ('add'|'replace'|'multiply'|'max'|'min')\n */\n\n/**\n * @typedef {Object} ProfileDef\n * @property {string}         name        - Human-readable name\n * @property {string}         description - What this profile does\n * @property {MappingEntry[]} mappings    - Array of axis-to-parameter mappings\n * @property {string[]}       sources     - Recommended input source types\n * @property {number}         smoothing   - Suggested smoothing factor (0..1)\n */\n\n/**\n * @typedef {Object} SourceEntry\n * @property {string}   name     - Unique source name\n * @property {string}   type     - One of SOURCE_TYPES\n * @property {Object}   config   - Source-specific configuration\n * @property {boolean}  active   - Whether this source is currently feeding data\n * @property {Function|null} _cleanup - Cleanup function for event listeners\n */\n\n/**\n * @typedef {Object} SpatialInputOptions\n * @property {number}   [sensitivity=1.0]  - Global sensitivity multiplier\n * @property {number}   [smoothing=0.15]   - Default smoothing factor (0..1)\n * @property {Function} [onParameterUpdate] - Callback invoked as fn(paramName, value)\n * @property {boolean}  [autoRegisterGlobals=true] - Expose window helpers\n */\n\n// ---------------------------------------------------------------------------\n// SpatialInputSystem\n// ---------------------------------------------------------------------------\n\n/**\n * SpatialInputSystem -- universal spatial orientation input for VIB3+.\n *\n * Abstracts spatial orientation from any combination of input sources\n * (device tilt, mouse, gamepad, gyroscope, audio, MIDI, AR perspective,\n * programmatic API) and maps the resulting spatial state to any VIB3+\n * visualisation parameter.\n *\n * @example\n * const spatial = new SpatialInputSystem({\n *     onParameterUpdate: (name, value) => engine.setParameter(name, value),\n *     smoothing: 0.12\n * });\n * spatial.addSource('tilt', 'deviceTilt');\n * spatial.addSource('mouse', 'mousePosition');\n * spatial.loadProfile('cardTilt');\n * spatial.enable();\n */\nexport class SpatialInputSystem {\n\n    // ------------------------------------------------------------------\n    // Construction\n    // ------------------------------------------------------------------\n\n    /**\n     * Create a new SpatialInputSystem.\n     * @param {SpatialInputOptions} [options={}]\n     */\n    constructor(options = {}) {\n        /** @type {Map<string, SourceEntry>} Active input sources keyed by name */\n        this.sources = new Map();\n\n        /** @type {Map<string, MappingEntry>} Active mappings keyed by \"axis->target\" */\n        this.mappings = new Map();\n\n        /** @type {Map<string, ProfileDef>} Named mapping profiles */\n        this.profiles = new Map();\n\n        /** @type {Map<string, number>} Per-axis smoothing state */\n        this.smoothing = new Map();\n\n        /** @type {boolean} Whether the frame loop is running */\n        this.enabled = false;\n\n        /** @type {number} Global sensitivity multiplier (0.1 .. 10) */\n        this.sensitivity = clamp(Number(options.sensitivity) || 1.0, 0.1, 10);\n\n        /** @type {number} Default smoothing factor (0 .. 1) */\n        this.smoothingFactor = clamp(Number(options.smoothing) || 0.15, 0, 1);\n\n        /** @type {boolean} Whether dramatic mode (8x amplification) is active */\n        this.dramaticMode = false;\n\n        /**\n         * Callback invoked when a mapped parameter should be updated.\n         * Signature: `(parameterName: string, value: number) => void`\n         * @type {Function|null}\n         */\n        this.parameterUpdateFn = typeof options.onParameterUpdate === 'function'\n            ? options.onParameterUpdate\n            : null;\n\n        /** @type {Set<string>} Custom user-defined target names beyond TARGETABLE_PARAMETERS */\n        this._customTargets = new Set();\n\n        // -- Spatial state (raw, pre-smoothing) --\n        /** @type {SpatialState} */\n        this.spatialState = createSpatialState();\n\n        // -- Smoothed output state --\n        /** @type {SpatialState} */\n        this.smoothedState = createSpatialState();\n\n        // -- Previous smoothed state (for velocity calculation) --\n        /** @private @type {SpatialState} */\n        this._prevSmoothedState = createSpatialState();\n\n        // -- Frame loop bookkeeping --\n        /** @private */\n        this._frameId = null;\n        /** @private */\n        this._lastFrameTime = 0;\n\n        // -- Event listeners --\n        /** @private @type {Map<string, Function[]>} */\n        this._listeners = new Map();\n\n        // -- Bound handlers stored for cleanup --\n        /** @private */\n        this._boundDeviceOrientation = null;\n        /** @private */\n        this._boundMouseMove = null;\n        /** @private */\n        this._boundGamepadPoll = null;\n        /** @private */\n        this._gyroscopeSensor = null;\n\n        // Initialise built-in profiles\n        this._initBuiltInProfiles();\n\n        /** @type {string|null} Name of the currently active profile */\n        this.activeProfile = null;\n\n        // Optionally register global helpers\n        if (options.autoRegisterGlobals !== false && typeof window !== 'undefined') {\n            this._registerGlobals();\n        }\n\n        console.log('SpatialInputSystem: Initialised');\n    }\n\n    // ------------------------------------------------------------------\n    // Global browser helpers\n    // ------------------------------------------------------------------\n\n    /**\n     * Register convenience functions on the window object.\n     * @private\n     */\n    _registerGlobals() {\n        if (typeof window === 'undefined') return;\n\n        window.spatialInputSystem = this;\n\n        /**\n         * Enable spatial input with an optional profile.\n         * @param {string} [profile]\n         */\n        window.enableSpatialInput = (profile) => {\n            if (profile) this.loadProfile(profile);\n            this.enable();\n        };\n\n        /**\n         * Disable spatial input processing.\n         */\n        window.disableSpatialInput = () => {\n            this.disable();\n        };\n\n        /**\n         * Switch the active spatial profile.\n         * @param {string} name\n         */\n        window.setSpatialProfile = (name) => {\n            this.loadProfile(name);\n        };\n\n        /**\n         * Feed manual spatial data (programmatic source).\n         * @param {Partial<SpatialState>} data\n         */\n        window.feedSpatialInput = (data) => {\n            this.feedInput(SOURCE_TYPES.PROGRAMMATIC, data);\n        };\n\n        /**\n         * Get the current smoothed spatial state.\n         * @returns {SpatialState}\n         */\n        window.getSpatialState = () => {\n            return this.getState();\n        };\n    }\n\n    // ------------------------------------------------------------------\n    // Built-in profiles\n    // ------------------------------------------------------------------\n\n    /**\n     * Register all built-in mapping profiles.\n     * @private\n     */\n    _initBuiltInProfiles() {\n\n        // ---- Card Tilt ----\n        this.profiles.set('cardTilt', {\n            name: 'Card Tilt',\n            description: 'Physical tilt controls 4D hyperspace rotation',\n            mappings: [\n                { axis: 'pitch', target: 'rot4dXW', scale: 0.02, clamp: [-1.5, 1.5], blendMode: 'replace' },\n                { axis: 'roll', target: 'rot4dYW', scale: 0.025, clamp: [-1.5, 1.5], blendMode: 'replace' },\n                { axis: 'yaw', target: 'rot4dZW', scale: 0.015, clamp: [-2.0, 2.0], blendMode: 'replace' },\n                { axis: 'intensity', target: 'chaos', scale: 0.3, clamp: [0, 1], blendMode: 'replace' }\n            ],\n            sources: [SOURCE_TYPES.DEVICE_TILT, SOURCE_TYPES.MOUSE_POSITION],\n            smoothing: 0.12\n        });\n\n        // ---- Wearable Perspective ----\n        this.profiles.set('wearablePerspective', {\n            name: 'Wearable Perspective',\n            description: 'Viewing angle affects visuals without physical device tilt; designed for AR glasses and headsets',\n            mappings: [\n                { axis: 'pitch', target: 'rot4dXW', scale: 0.015, clamp: [-1.0, 1.0], blendMode: 'replace' },\n                { axis: 'yaw', target: 'rot4dXY', scale: 0.02, clamp: [-3.14, 3.14], blendMode: 'replace' },\n                { axis: 'roll', target: 'rot4dYW', scale: 0.01, clamp: [-0.8, 0.8], blendMode: 'replace' },\n                { axis: 'z', target: 'dimension', scale: 0.5, clamp: [3.0, 4.5], blendMode: 'replace' },\n                { axis: 'intensity', target: 'intensity', scale: 0.4, clamp: [0.2, 1.0], blendMode: 'replace' }\n            ],\n            sources: [SOURCE_TYPES.PERSPECTIVE, SOURCE_TYPES.DEVICE_TILT],\n            smoothing: 0.2\n        });\n\n        // ---- Game Asset ----\n        this.profiles.set('gameAsset', {\n            name: 'Game Asset',\n            description: 'Game object orientation in world space maps to all 6 rotation planes',\n            mappings: [\n                { axis: 'pitch', target: 'rot4dYZ', scale: 1.0, clamp: [-6.28, 6.28], blendMode: 'replace' },\n                { axis: 'yaw', target: 'rot4dXZ', scale: 1.0, clamp: [-6.28, 6.28], blendMode: 'replace' },\n                { axis: 'roll', target: 'rot4dXY', scale: 1.0, clamp: [-6.28, 6.28], blendMode: 'replace' },\n                { axis: 'x', target: 'rot4dXW', scale: 0.5, clamp: [-2.0, 2.0], blendMode: 'replace' },\n                { axis: 'y', target: 'rot4dYW', scale: 0.5, clamp: [-2.0, 2.0], blendMode: 'replace' },\n                { axis: 'z', target: 'rot4dZW', scale: 0.5, clamp: [-2.0, 2.0], blendMode: 'replace' }\n            ],\n            sources: [SOURCE_TYPES.PROGRAMMATIC, SOURCE_TYPES.GAMEPAD],\n            smoothing: 0.08\n        });\n\n        // ---- VJ Audio Spatial ----\n        this.profiles.set('vjAudioSpatial', {\n            name: 'VJ Audio Spatial',\n            description: 'Audio energy creates spatial movement for live VJ performance',\n            mappings: [\n                { axis: 'pitch', target: 'rot4dXW', scale: 0.8, clamp: [-1.5, 1.5], blendMode: 'add' },\n                { axis: 'yaw', target: 'rot4dYW', scale: 0.6, clamp: [-1.5, 1.5], blendMode: 'add' },\n                { axis: 'roll', target: 'rot4dZW', scale: 0.5, clamp: [-1.0, 1.0], blendMode: 'add' },\n                { axis: 'intensity', target: 'morphFactor', scale: 1.5, clamp: [0, 2], blendMode: 'replace' },\n                { axis: 'velocity', target: 'chaos', scale: 0.8, clamp: [0, 1], blendMode: 'replace' },\n                { axis: 'x', target: 'hue', scale: 180, clamp: [0, 360], blendMode: 'add' },\n                { axis: 'y', target: 'speed', scale: 2.0, clamp: [0.1, 3.0], blendMode: 'replace' }\n            ],\n            sources: [SOURCE_TYPES.AUDIO, SOURCE_TYPES.MIDI],\n            smoothing: 0.08\n        });\n\n        // ---- UI Element ----\n        this.profiles.set('uiElement', {\n            name: 'UI Element',\n            description: 'Mouse and scroll position changes visuals without physical movement',\n            mappings: [\n                { axis: 'pitch', target: 'rot4dXW', scale: 0.8, clamp: [-1.0, 1.0], blendMode: 'replace' },\n                { axis: 'roll', target: 'rot4dYW', scale: 0.8, clamp: [-1.0, 1.0], blendMode: 'replace' },\n                { axis: 'yaw', target: 'rot4dXY', scale: 0.5, clamp: [-1.5, 1.5], blendMode: 'replace' },\n                { axis: 'z', target: 'dimension', scale: 0.3, clamp: [3.0, 4.5], blendMode: 'add' },\n                { axis: 'intensity', target: 'intensity', scale: 0.5, clamp: [0.1, 1.0], blendMode: 'replace' }\n            ],\n            sources: [SOURCE_TYPES.MOUSE_POSITION],\n            smoothing: 0.18\n        });\n\n        // ---- Immersive XR ----\n        this.profiles.set('immersiveXR', {\n            name: 'Immersive XR',\n            description: 'Full 6DOF mapping for WebXR headsets and controllers',\n            mappings: [\n                // Rotational axes map to all 6 rotation planes\n                { axis: 'pitch', target: 'rot4dYZ', scale: 1.0, clamp: [-6.28, 6.28], blendMode: 'replace' },\n                { axis: 'yaw', target: 'rot4dXZ', scale: 1.0, clamp: [-6.28, 6.28], blendMode: 'replace' },\n                { axis: 'roll', target: 'rot4dXY', scale: 1.0, clamp: [-6.28, 6.28], blendMode: 'replace' },\n                // Translational axes map to 4D hyperspace rotations\n                { axis: 'x', target: 'rot4dXW', scale: 1.0, clamp: [-2.0, 2.0], blendMode: 'replace' },\n                { axis: 'y', target: 'rot4dYW', scale: 1.0, clamp: [-2.0, 2.0], blendMode: 'replace' },\n                { axis: 'z', target: 'rot4dZW', scale: 1.0, clamp: [-2.0, 2.0], blendMode: 'replace' },\n                // Movement intensity drives visual intensity\n                { axis: 'intensity', target: 'intensity', scale: 0.6, clamp: [0.2, 1.0], blendMode: 'replace' },\n                { axis: 'velocity', target: 'speed', scale: 2.0, clamp: [0.1, 3.0], blendMode: 'replace' }\n            ],\n            sources: [SOURCE_TYPES.PERSPECTIVE, SOURCE_TYPES.GYROSCOPE, SOURCE_TYPES.GAMEPAD],\n            smoothing: 0.06\n        });\n    }\n\n    // ------------------------------------------------------------------\n    // Source management\n    // ------------------------------------------------------------------\n\n    /**\n     * Register an input source.\n     *\n     * @param {string} name   - Unique identifier for this source instance\n     * @param {string} type   - One of SOURCE_TYPES values\n     * @param {Object} [config={}] - Source-specific configuration\n     * @returns {boolean} True if the source was added successfully\n     *\n     * @example\n     * spatial.addSource('tilt', 'deviceTilt');\n     * spatial.addSource('mouse', 'mousePosition', { element: myCanvas });\n     * spatial.addSource('pad', 'gamepad', { index: 0, deadzone: 0.1 });\n     */\n    addSource(name, type, config = {}) {\n        if (!name || typeof name !== 'string') {\n            console.warn('SpatialInputSystem.addSource: name must be a non-empty string');\n            return false;\n        }\n        if (!Object.values(SOURCE_TYPES).includes(type)) {\n            console.warn(`SpatialInputSystem.addSource: unknown source type \"${type}\"`);\n            return false;\n        }\n        if (this.sources.size >= MAX_SOURCES) {\n            console.warn('SpatialInputSystem.addSource: maximum source count reached');\n            return false;\n        }\n\n        // Remove existing source with same name first\n        if (this.sources.has(name)) {\n            this.removeSource(name);\n        }\n\n        /** @type {SourceEntry} */\n        const entry = {\n            name,\n            type,\n            config: { ...config },\n            active: true,\n            _cleanup: null\n        };\n\n        this.sources.set(name, entry);\n\n        // If already enabled, start listening immediately\n        if (this.enabled) {\n            this._attachSourceListeners(entry);\n        }\n\n        this._emit('sourceAdded', { name, type });\n        console.log(`SpatialInputSystem: Source added \"${name}\" (${type})`);\n        return true;\n    }\n\n    /**\n     * Remove an input source and clean up its listeners.\n     * @param {string} name\n     * @returns {boolean} True if a source was removed\n     */\n    removeSource(name) {\n        const entry = this.sources.get(name);\n        if (!entry) return false;\n\n        this._detachSourceListeners(entry);\n        this.sources.delete(name);\n\n        this._emit('sourceRemoved', { name, type: entry.type });\n        console.log(`SpatialInputSystem: Source removed \"${name}\"`);\n        return true;\n    }\n\n    /**\n     * Check whether a source with the given name is registered.\n     * @param {string} name\n     * @returns {boolean}\n     */\n    hasSource(name) {\n        return this.sources.has(name);\n    }\n\n    /**\n     * Get a list of all registered source names and types.\n     * @returns {{ name: string, type: string, active: boolean }[]}\n     */\n    listSources() {\n        const list = [];\n        for (const [name, entry] of this.sources) {\n            list.push({ name, type: entry.type, active: entry.active });\n        }\n        return list;\n    }\n\n    // ------------------------------------------------------------------\n    // Mapping management\n    // ------------------------------------------------------------------\n\n    /**\n     * Map a spatial axis to a VIB3+ parameter (or custom target).\n     *\n     * @param {string}   sourceAxis  - Spatial axis name (e.g. 'pitch', 'yaw')\n     * @param {string}   targetParam - VIB3+ parameter name (e.g. 'rot4dXW')\n     * @param {number}   [scale=1.0] - Scaling multiplier\n     * @param {number[]} [clampRange=null] - Optional [min, max]\n     * @param {string}   [blendMode='replace'] - One of BLEND_MODES\n     * @returns {boolean} True if the mapping was added\n     */\n    setMapping(sourceAxis, targetParam, scale = 1.0, clampRange = null, blendMode = 'replace') {\n        if (!SPATIAL_AXES.includes(sourceAxis)) {\n            console.warn(`SpatialInputSystem.setMapping: unknown axis \"${sourceAxis}\"`);\n            return false;\n        }\n        if (!this._isValidTarget(targetParam)) {\n            console.warn(`SpatialInputSystem.setMapping: unknown target \"${targetParam}\"`);\n            return false;\n        }\n        if (!BLEND_MODES.includes(blendMode)) {\n            console.warn(`SpatialInputSystem.setMapping: unknown blend mode \"${blendMode}\", defaulting to \"replace\"`);\n            blendMode = 'replace';\n        }\n        if (this.mappings.size >= MAX_MAPPINGS) {\n            console.warn('SpatialInputSystem.setMapping: maximum mapping count reached');\n            return false;\n        }\n\n        const key = `${sourceAxis}->${targetParam}`;\n\n        /** @type {MappingEntry} */\n        const entry = {\n            axis: sourceAxis,\n            target: targetParam,\n            scale: Number.isFinite(scale) ? scale : 1.0,\n            clamp: Array.isArray(clampRange) && clampRange.length === 2 ? clampRange : null,\n            blendMode\n        };\n\n        this.mappings.set(key, entry);\n        this._emit('mappingChanged', entry);\n        return true;\n    }\n\n    /**\n     * Remove a specific axis-to-parameter mapping.\n     * @param {string} sourceAxis\n     * @param {string} targetParam\n     * @returns {boolean}\n     */\n    removeMapping(sourceAxis, targetParam) {\n        const key = `${sourceAxis}->${targetParam}`;\n        const removed = this.mappings.delete(key);\n        if (removed) {\n            this._emit('mappingRemoved', { axis: sourceAxis, target: targetParam });\n        }\n        return removed;\n    }\n\n    /**\n     * Clear all active mappings.\n     */\n    clearMappings() {\n        this.mappings.clear();\n        this._emit('mappingsCleared');\n    }\n\n    /**\n     * Get all current mappings as an array.\n     * @returns {MappingEntry[]}\n     */\n    listMappings() {\n        return Array.from(this.mappings.values());\n    }\n\n    // ------------------------------------------------------------------\n    // Profiles\n    // ------------------------------------------------------------------\n\n    /**\n     * Load a mapping profile by name, replacing all current mappings.\n     *\n     * @param {string} profileName\n     * @returns {boolean} True if the profile was loaded\n     *\n     * @example\n     * spatial.loadProfile('cardTilt');\n     */\n    loadProfile(profileName) {\n        const profile = this.profiles.get(profileName);\n        if (!profile) {\n            console.warn(`SpatialInputSystem.loadProfile: unknown profile \"${profileName}\"`);\n            return false;\n        }\n\n        // Clear existing mappings\n        this.clearMappings();\n\n        // Apply profile smoothing\n        if (typeof profile.smoothing === 'number') {\n            this.smoothingFactor = clamp(profile.smoothing, 0, 1);\n        }\n\n        // Install all mappings from the profile\n        for (const m of profile.mappings) {\n            this.setMapping(m.axis, m.target, m.scale, m.clamp || null, m.blendMode || 'replace');\n        }\n\n        this.activeProfile = profileName;\n        this._emit('profileLoaded', { name: profileName, profile });\n        console.log(`SpatialInputSystem: Profile loaded \"${profileName}\"`);\n        return true;\n    }\n\n    /**\n     * Create (or overwrite) a custom mapping profile.\n     *\n     * @param {string}         name        - Profile identifier\n     * @param {MappingEntry[]} mappings    - Array of mapping definitions\n     * @param {Object}         [meta={}]   - Optional metadata\n     * @param {string}         [meta.description]\n     * @param {string[]}       [meta.sources]\n     * @param {number}         [meta.smoothing]\n     * @returns {boolean}\n     */\n    createProfile(name, mappings, meta = {}) {\n        if (!name || typeof name !== 'string') {\n            console.warn('SpatialInputSystem.createProfile: name must be a non-empty string');\n            return false;\n        }\n        if (!Array.isArray(mappings) || mappings.length === 0) {\n            console.warn('SpatialInputSystem.createProfile: mappings must be a non-empty array');\n            return false;\n        }\n\n        /** @type {ProfileDef} */\n        const profile = {\n            name: meta.name || name,\n            description: meta.description || `Custom profile: ${name}`,\n            mappings: mappings.map(m => ({\n                axis: m.axis,\n                target: m.target,\n                scale: Number.isFinite(m.scale) ? m.scale : 1.0,\n                clamp: Array.isArray(m.clamp) ? m.clamp : null,\n                blendMode: m.blendMode || 'replace'\n            })),\n            sources: Array.isArray(meta.sources) ? meta.sources : [],\n            smoothing: typeof meta.smoothing === 'number' ? clamp(meta.smoothing, 0, 1) : this.smoothingFactor\n        };\n\n        this.profiles.set(name, profile);\n        this._emit('profileCreated', { name, profile });\n        console.log(`SpatialInputSystem: Profile created \"${name}\"`);\n        return true;\n    }\n\n    /**\n     * Remove a custom profile (built-in profiles cannot be removed).\n     * @param {string} name\n     * @returns {boolean}\n     */\n    removeProfile(name) {\n        const builtIn = ['cardTilt', 'wearablePerspective', 'gameAsset', 'vjAudioSpatial', 'uiElement', 'immersiveXR'];\n        if (builtIn.includes(name)) {\n            console.warn(`SpatialInputSystem.removeProfile: cannot remove built-in profile \"${name}\"`);\n            return false;\n        }\n        return this.profiles.delete(name);\n    }\n\n    /**\n     * Get a list of all available profile names.\n     * @returns {string[]}\n     */\n    listProfiles() {\n        return Array.from(this.profiles.keys());\n    }\n\n    /**\n     * Get a profile definition by name.\n     * @param {string} name\n     * @returns {ProfileDef|null}\n     */\n    getProfile(name) {\n        const p = this.profiles.get(name);\n        return p ? { ...p, mappings: p.mappings.map(m => ({ ...m })) } : null;\n    }\n\n    // ------------------------------------------------------------------\n    // Custom targets\n    // ------------------------------------------------------------------\n\n    /**\n     * Register a custom target parameter name (beyond TARGETABLE_PARAMETERS).\n     * @param {string} name\n     */\n    addCustomTarget(name) {\n        if (typeof name === 'string' && name.length > 0) {\n            this._customTargets.add(name);\n        }\n    }\n\n    /**\n     * Remove a custom target parameter name.\n     * @param {string} name\n     */\n    removeCustomTarget(name) {\n        this._customTargets.delete(name);\n    }\n\n    /**\n     * Check whether a target name is valid (built-in or custom).\n     * @private\n     * @param {string} name\n     * @returns {boolean}\n     */\n    _isValidTarget(name) {\n        return TARGETABLE_PARAMETERS.includes(name) || this._customTargets.has(name);\n    }\n\n    // ------------------------------------------------------------------\n    // Enable / Disable\n    // ------------------------------------------------------------------\n\n    /**\n     * Start processing input and updating parameters each frame.\n     */\n    enable() {\n        if (this.enabled) return;\n\n        this.enabled = true;\n        this._lastFrameTime = performance.now();\n\n        // Attach listeners for all registered sources\n        for (const entry of this.sources.values()) {\n            this._attachSourceListeners(entry);\n        }\n\n        // Start frame loop\n        this._scheduleFrame();\n\n        this._emit('enabled');\n        console.log('SpatialInputSystem: Enabled');\n    }\n\n    /**\n     * Stop processing and detach all listeners.\n     */\n    disable() {\n        if (!this.enabled) return;\n\n        this.enabled = false;\n\n        // Cancel frame loop\n        if (this._frameId !== null) {\n            cancelAnimationFrame(this._frameId);\n            this._frameId = null;\n        }\n\n        // Detach listeners for all registered sources\n        for (const entry of this.sources.values()) {\n            this._detachSourceListeners(entry);\n        }\n\n        this._emit('disabled');\n        console.log('SpatialInputSystem: Disabled');\n    }\n\n    /**\n     * Whether the system is currently active.\n     * @returns {boolean}\n     */\n    isEnabled() {\n        return this.enabled;\n    }\n\n    // ------------------------------------------------------------------\n    // Configuration setters\n    // ------------------------------------------------------------------\n\n    /**\n     * Set the global sensitivity multiplier.\n     * @param {number} value - 0.1 .. 10\n     */\n    setSensitivity(value) {\n        this.sensitivity = clamp(Number(value) || 1.0, 0.1, 10);\n    }\n\n    /**\n     * Set the default smoothing factor.\n     * @param {number} value - 0 .. 1 (0 = no smoothing, 1 = maximum smoothing)\n     */\n    setSmoothing(value) {\n        this.smoothingFactor = clamp(Number(value) || 0.15, 0, 1);\n    }\n\n    /**\n     * Set per-axis smoothing override.\n     * @param {string} axis  - Spatial axis name\n     * @param {number} value - 0 .. 1\n     */\n    setAxisSmoothing(axis, value) {\n        if (SPATIAL_AXES.includes(axis)) {\n            this.smoothing.set(axis, clamp(Number(value) || 0, 0, 1));\n        }\n    }\n\n    /**\n     * Enable or disable dramatic mode (8x amplification).\n     * @param {boolean} enabled\n     */\n    setDramaticMode(enabled) {\n        this.dramaticMode = !!enabled;\n        this._emit('dramaticModeChanged', this.dramaticMode);\n        console.log(`SpatialInputSystem: Dramatic mode ${this.dramaticMode ? 'ON' : 'OFF'}`);\n    }\n\n    /**\n     * Set the parameter update callback.\n     * @param {Function} fn - (paramName: string, value: number) => void\n     */\n    setParameterUpdateFn(fn) {\n        this.parameterUpdateFn = typeof fn === 'function' ? fn : null;\n    }\n\n    // ------------------------------------------------------------------\n    // Manual data injection\n    // ------------------------------------------------------------------\n\n    /**\n     * Feed spatial data from an external/programmatic source.\n     *\n     * @param {string} sourceType - One of SOURCE_TYPES\n     * @param {Object} data       - Partial spatial state or source-specific data\n     *\n     * @example\n     * // Programmatic: set pitch and roll directly\n     * spatial.feedInput('programmatic', { pitch: 0.5, roll: -0.3 });\n     *\n     * // Audio: provide frequency band levels\n     * spatial.feedInput('audio', { bass: 0.8, mid: 0.4, high: 0.2 });\n     *\n     * // MIDI: provide channel, CC number, and value\n     * spatial.feedInput('midi', { channel: 0, cc: 1, value: 64 });\n     */\n    feedInput(sourceType, data) {\n        if (!data || typeof data !== 'object') return;\n\n        switch (sourceType) {\n            case SOURCE_TYPES.PROGRAMMATIC:\n                this._processProgrammatic(data);\n                break;\n            case SOURCE_TYPES.DEVICE_TILT:\n                this._processDeviceTilt(data);\n                break;\n            case SOURCE_TYPES.MOUSE_POSITION:\n                this._processMousePosition(\n                    Number(data.x) || 0,\n                    Number(data.y) || 0,\n                    data.width || (typeof window !== 'undefined' ? window.innerWidth : 1920),\n                    data.height || (typeof window !== 'undefined' ? window.innerHeight : 1080)\n                );\n                break;\n            case SOURCE_TYPES.GYROSCOPE:\n                this._processGyroscope(data);\n                break;\n            case SOURCE_TYPES.GAMEPAD:\n                this._processGamepad(data);\n                break;\n            case SOURCE_TYPES.PERSPECTIVE:\n                this._processPerspective(data);\n                break;\n            case SOURCE_TYPES.AUDIO:\n                this._processAudioSpatial(\n                    Number(data.bass) || 0,\n                    Number(data.mid) || 0,\n                    Number(data.high) || 0\n                );\n                break;\n            case SOURCE_TYPES.MIDI:\n                this._processMIDI(\n                    Number(data.channel) || 0,\n                    Number(data.cc) || 0,\n                    Number(data.value) || 0\n                );\n                break;\n            default:\n                console.warn(`SpatialInputSystem.feedInput: unknown source type \"${sourceType}\"`);\n        }\n    }\n\n    // ------------------------------------------------------------------\n    // State retrieval\n    // ------------------------------------------------------------------\n\n    /**\n     * Get the current smoothed spatial state.\n     * @returns {SpatialState}\n     */\n    getState() {\n        return { ...this.smoothedState };\n    }\n\n    /**\n     * Get the raw (pre-smoothing) spatial state.\n     * @returns {SpatialState}\n     */\n    getRawState() {\n        return { ...this.spatialState };\n    }\n\n    // ------------------------------------------------------------------\n    // Serialisation\n    // ------------------------------------------------------------------\n\n    /**\n     * Export the full configuration (sources, mappings, profile, settings).\n     * @returns {Object}\n     */\n    exportConfig() {\n        return {\n            version: '1.0',\n            sensitivity: this.sensitivity,\n            smoothingFactor: this.smoothingFactor,\n            dramaticMode: this.dramaticMode,\n            activeProfile: this.activeProfile,\n            sources: this.listSources(),\n            mappings: this.listMappings(),\n            customTargets: Array.from(this._customTargets),\n            axisSmoothing: Object.fromEntries(this.smoothing)\n        };\n    }\n\n    /**\n     * Import a previously exported configuration.\n     *\n     * @param {Object} config - Configuration object from exportConfig()\n     * @returns {boolean} True if import succeeded\n     */\n    importConfig(config) {\n        if (!config || typeof config !== 'object') {\n            console.warn('SpatialInputSystem.importConfig: invalid config');\n            return false;\n        }\n\n        try {\n            // Settings\n            if (Number.isFinite(config.sensitivity)) {\n                this.setSensitivity(config.sensitivity);\n            }\n            if (Number.isFinite(config.smoothingFactor)) {\n                this.setSmoothing(config.smoothingFactor);\n            }\n            if (typeof config.dramaticMode === 'boolean') {\n                this.setDramaticMode(config.dramaticMode);\n            }\n\n            // Custom targets\n            if (Array.isArray(config.customTargets)) {\n                this._customTargets.clear();\n                for (const t of config.customTargets) {\n                    this.addCustomTarget(t);\n                }\n            }\n\n            // Axis smoothing overrides\n            if (config.axisSmoothing && typeof config.axisSmoothing === 'object') {\n                this.smoothing.clear();\n                for (const [axis, val] of Object.entries(config.axisSmoothing)) {\n                    this.setAxisSmoothing(axis, val);\n                }\n            }\n\n            // Sources\n            if (Array.isArray(config.sources)) {\n                // Remove all existing sources first\n                for (const name of Array.from(this.sources.keys())) {\n                    this.removeSource(name);\n                }\n                for (const s of config.sources) {\n                    if (s.name && s.type) {\n                        this.addSource(s.name, s.type, s.config || {});\n                    }\n                }\n            }\n\n            // Mappings\n            if (Array.isArray(config.mappings)) {\n                this.clearMappings();\n                for (const m of config.mappings) {\n                    this.setMapping(m.axis, m.target, m.scale, m.clamp, m.blendMode);\n                }\n            }\n\n            // Profile (load after mappings -- if a profile is specified, it\n            // replaces the explicit mappings above)\n            if (config.activeProfile && this.profiles.has(config.activeProfile)) {\n                this.loadProfile(config.activeProfile);\n            }\n\n            this._emit('configImported', config);\n            console.log('SpatialInputSystem: Config imported');\n            return true;\n        } catch (err) {\n            console.error('SpatialInputSystem.importConfig: error during import', err);\n            return false;\n        }\n    }\n\n    // ------------------------------------------------------------------\n    // Frame processing\n    // ------------------------------------------------------------------\n\n    /**\n     * Schedule the next animation frame.\n     * @private\n     */\n    _scheduleFrame() {\n        if (!this.enabled) return;\n        this._frameId = requestAnimationFrame((ts) => this._onFrame(ts));\n    }\n\n    /**\n     * Animation frame callback.\n     * @private\n     * @param {number} timestamp - High-resolution timestamp from rAF\n     */\n    _onFrame(timestamp) {\n        if (!this.enabled) return;\n\n        const deltaTime = Math.min((timestamp - this._lastFrameTime) / 1000, 0.1); // cap at 100ms\n        this._lastFrameTime = timestamp;\n\n        // Poll sources that need polling (e.g. gamepad)\n        this._pollSources();\n\n        // Run the main processing pipeline\n        this.processFrame(deltaTime);\n\n        // Schedule next\n        this._scheduleFrame();\n    }\n\n    /**\n     * Main per-frame processing pipeline.\n     *\n     * 1. Compute velocity from state delta\n     * 2. Compute intensity from overall displacement\n     * 3. Apply smoothing\n     * 4. Apply dramatic mode amplification\n     * 5. Map smoothed state to parameters via active mappings\n     * 6. Invoke parameter update callbacks\n     *\n     * @param {number} deltaTime - Seconds since last frame\n     */\n    processFrame(deltaTime) {\n        const dt = Number.isFinite(deltaTime) && deltaTime > 0 ? deltaTime : 1 / 60;\n\n        // -- Compute derived values --\n\n        // Intensity: Euclidean distance of orientation + translation from origin\n        const rawIntensity = Math.sqrt(\n            this.spatialState.pitch * this.spatialState.pitch +\n            this.spatialState.yaw * this.spatialState.yaw +\n            this.spatialState.roll * this.spatialState.roll +\n            this.spatialState.x * this.spatialState.x +\n            this.spatialState.y * this.spatialState.y +\n            this.spatialState.z * this.spatialState.z\n        );\n        this.spatialState.intensity = clamp(rawIntensity / Math.SQRT2, 0, 1);\n\n        // -- Smooth all axes --\n        for (const axis of SPATIAL_AXES) {\n            const factor = this.smoothing.has(axis)\n                ? this.smoothing.get(axis)\n                : this.smoothingFactor;\n\n            // Lerp factor: lower smoothingFactor = more responsive\n            const lerpFactor = 1.0 - factor;\n\n            this.smoothedState[axis] = lerp(\n                this.smoothedState[axis],\n                this.spatialState[axis],\n                clamp(lerpFactor, 0, 1)\n            );\n        }\n\n        // Velocity: rate of change of the smoothed state\n        let velocitySum = 0;\n        for (const axis of ['pitch', 'yaw', 'roll', 'x', 'y', 'z']) {\n            const delta = this.smoothedState[axis] - this._prevSmoothedState[axis];\n            velocitySum += delta * delta;\n        }\n        this.smoothedState.velocity = clamp(Math.sqrt(velocitySum) / (dt * 10), 0, 1);\n\n        // Store previous state\n        Object.assign(this._prevSmoothedState, this.smoothedState);\n\n        // -- Apply mappings --\n        this._applyMappings();\n    }\n\n    /**\n     * Apply all active mappings, reading from smoothedState and invoking\n     * the parameter update callback.\n     * @private\n     */\n    _applyMappings() {\n        if (!this.parameterUpdateFn) return;\n\n        // Accumulate per-target to handle multiple mappings to the same target\n        /** @type {Map<string, { value: number, mode: string }>} */\n        const accumulator = new Map();\n\n        for (const mapping of this.mappings.values()) {\n            const rawValue = this.smoothedState[mapping.axis] || 0;\n\n            // Apply sensitivity and scale\n            let value = rawValue * mapping.scale * this.sensitivity;\n\n            // Dramatic mode amplification\n            if (this.dramaticMode) {\n                value *= DRAMATIC_MULTIPLIER;\n            }\n\n            // Clamp if configured\n            if (mapping.clamp) {\n                value = clamp(value, mapping.clamp[0], mapping.clamp[1]);\n            }\n\n            // Guard against NaN\n            if (!Number.isFinite(value)) continue;\n\n            const mode = mapping.blendMode || 'replace';\n            const existing = accumulator.get(mapping.target);\n\n            if (!existing) {\n                accumulator.set(mapping.target, { value, mode });\n            } else {\n                // Combine multiple mappings targeting the same parameter\n                switch (mode) {\n                    case 'add':\n                        existing.value += value;\n                        break;\n                    case 'multiply':\n                        existing.value *= value;\n                        break;\n                    case 'max':\n                        existing.value = Math.max(existing.value, value);\n                        break;\n                    case 'min':\n                        existing.value = Math.min(existing.value, value);\n                        break;\n                    case 'replace':\n                    default:\n                        existing.value = value;\n                        break;\n                }\n            }\n        }\n\n        // Invoke callback for each accumulated target\n        for (const [param, { value }] of accumulator) {\n            try {\n                this.parameterUpdateFn(param, value);\n            } catch (err) {\n                console.error(`SpatialInputSystem: Error updating parameter \"${param}\"`, err);\n            }\n        }\n    }\n\n    // ------------------------------------------------------------------\n    // Input source listeners\n    // ------------------------------------------------------------------\n\n    /**\n     * Attach native event listeners for a source.\n     * @private\n     * @param {SourceEntry} entry\n     */\n    _attachSourceListeners(entry) {\n        if (typeof window === 'undefined') return;\n\n        switch (entry.type) {\n            case SOURCE_TYPES.DEVICE_TILT:\n                this._attachDeviceTilt(entry);\n                break;\n            case SOURCE_TYPES.MOUSE_POSITION:\n                this._attachMousePosition(entry);\n                break;\n            case SOURCE_TYPES.GYROSCOPE:\n                this._attachGyroscope(entry);\n                break;\n            case SOURCE_TYPES.GAMEPAD:\n                // Gamepad is polled, not event-driven; mark for polling\n                entry._cleanup = null;\n                break;\n            case SOURCE_TYPES.PERSPECTIVE:\n            case SOURCE_TYPES.PROGRAMMATIC:\n            case SOURCE_TYPES.AUDIO:\n            case SOURCE_TYPES.MIDI:\n                // These are feed-based; no automatic listeners\n                entry._cleanup = null;\n                break;\n        }\n    }\n\n    /**\n     * Detach native event listeners for a source.\n     * @private\n     * @param {SourceEntry} entry\n     */\n    _detachSourceListeners(entry) {\n        if (typeof entry._cleanup === 'function') {\n            entry._cleanup();\n            entry._cleanup = null;\n        }\n    }\n\n    /**\n     * Attach DeviceOrientationEvent listener.\n     * @private\n     * @param {SourceEntry} entry\n     */\n    _attachDeviceTilt(entry) {\n        if (typeof window === 'undefined') return;\n\n        const handler = (event) => {\n            if (!entry.active) return;\n            this._processDeviceTilt(event);\n        };\n\n        // Request permission on iOS 13+\n        if (typeof DeviceOrientationEvent !== 'undefined' &&\n            typeof DeviceOrientationEvent.requestPermission === 'function') {\n            DeviceOrientationEvent.requestPermission()\n                .then((permission) => {\n                    if (permission === 'granted') {\n                        window.addEventListener('deviceorientation', handler);\n                    } else {\n                        console.warn('SpatialInputSystem: Device orientation permission denied');\n                    }\n                })\n                .catch((err) => {\n                    console.warn('SpatialInputSystem: Device orientation permission error', err);\n                });\n        } else {\n            window.addEventListener('deviceorientation', handler);\n        }\n\n        entry._cleanup = () => {\n            window.removeEventListener('deviceorientation', handler);\n        };\n    }\n\n    /**\n     * Attach mousemove listener.\n     * @private\n     * @param {SourceEntry} entry\n     */\n    _attachMousePosition(entry) {\n        if (typeof window === 'undefined') return;\n\n        const element = entry.config.element || window;\n        const handler = (event) => {\n            if (!entry.active) return;\n            this._processMousePosition(\n                event.clientX,\n                event.clientY,\n                window.innerWidth,\n                window.innerHeight\n            );\n        };\n\n        element.addEventListener('mousemove', handler);\n        entry._cleanup = () => {\n            element.removeEventListener('mousemove', handler);\n        };\n    }\n\n    /**\n     * Attach GyroscopeSensor API (Generic Sensor API).\n     * @private\n     * @param {SourceEntry} entry\n     */\n    _attachGyroscope(entry) {\n        if (typeof window === 'undefined' || typeof window.Gyroscope === 'undefined') {\n            console.warn('SpatialInputSystem: Gyroscope API not available');\n            return;\n        }\n\n        try {\n            const frequency = entry.config.frequency || 60;\n            const sensor = new window.Gyroscope({ frequency });\n\n            sensor.addEventListener('reading', () => {\n                if (!entry.active) return;\n                this._processGyroscope({\n                    x: sensor.x,\n                    y: sensor.y,\n                    z: sensor.z\n                });\n            });\n\n            sensor.addEventListener('error', (event) => {\n                console.warn('SpatialInputSystem: Gyroscope error', event.error);\n            });\n\n            sensor.start();\n            this._gyroscopeSensor = sensor;\n\n            entry._cleanup = () => {\n                sensor.stop();\n                this._gyroscopeSensor = null;\n            };\n        } catch (err) {\n            console.warn('SpatialInputSystem: Failed to initialise Gyroscope', err);\n        }\n    }\n\n    /**\n     * Poll-based sources (called every frame).\n     * @private\n     */\n    _pollSources() {\n        for (const entry of this.sources.values()) {\n            if (!entry.active) continue;\n\n            switch (entry.type) {\n                case SOURCE_TYPES.GAMEPAD:\n                    this._pollGamepad(entry);\n                    break;\n                // Other poll-based sources can be added here\n            }\n        }\n    }\n\n    /**\n     * Poll the Gamepad API for analog stick data.\n     * @private\n     * @param {SourceEntry} entry\n     */\n    _pollGamepad(entry) {\n        if (typeof navigator === 'undefined' || typeof navigator.getGamepads !== 'function') return;\n\n        const gamepads = navigator.getGamepads();\n        const index = entry.config.index || 0;\n        const gamepad = gamepads[index];\n\n        if (!gamepad || !gamepad.connected) return;\n\n        this._processGamepad(gamepad, entry.config);\n    }\n\n    // ------------------------------------------------------------------\n    // Input processors\n    // ------------------------------------------------------------------\n\n    /**\n     * Process DeviceOrientationEvent data.\n     *\n     * Maps:\n     *   beta  (-180..180) --> pitch (-1..1)\n     *   gamma (-90..90)   --> roll  (-1..1)\n     *   alpha (0..360)    --> yaw   (-1..1)\n     *\n     * @private\n     * @param {DeviceOrientationEvent|Object} event\n     */\n    _processDeviceTilt(event) {\n        const alpha = Number(event.alpha) || 0; // 0..360\n        const beta = Number(event.beta) || 0;   // -180..180\n        const gamma = Number(event.gamma) || 0; // -90..90\n\n        // Normalise to -1..1\n        this.spatialState.pitch = clamp(beta / 90, -1, 1);\n        this.spatialState.roll = clamp(gamma / 45, -1, 1);\n        this.spatialState.yaw = clamp((alpha - 180) / 180, -1, 1);\n    }\n\n    /**\n     * Process mouse position as spatial orientation.\n     *\n     * Maps screen-relative position to pitch (vertical) and roll (horizontal).\n     * Centre of screen = neutral (0, 0).\n     *\n     * @private\n     * @param {number} x       - Mouse X pixel coordinate\n     * @param {number} y       - Mouse Y pixel coordinate\n     * @param {number} [width]  - Viewport width\n     * @param {number} [height] - Viewport height\n     */\n    _processMousePosition(x, y, width, height) {\n        const w = Number(width) || (typeof window !== 'undefined' ? window.innerWidth : 1920);\n        const h = Number(height) || (typeof window !== 'undefined' ? window.innerHeight : 1080);\n\n        if (w === 0 || h === 0) return;\n\n        // Normalise to -1..1 (centre = 0)\n        const normX = clamp(((x / w) - 0.5) * 2, -1, 1);\n        const normY = clamp(((y / h) - 0.5) * 2, -1, 1);\n\n        this.spatialState.roll = normX;\n        this.spatialState.pitch = -normY; // Inverted: mouse up = positive pitch\n        // Yaw stays unchanged by mouse (no horizontal rotation equivalent)\n    }\n\n    /**\n     * Process GyroscopeSensor reading.\n     *\n     * Maps angular velocity (rad/s) to spatial axes.\n     * Integrates velocity over time to produce position-like values\n     * with natural decay.\n     *\n     * @private\n     * @param {Object} event\n     * @param {number} event.x - Angular velocity around X axis (rad/s)\n     * @param {number} event.y - Angular velocity around Y axis (rad/s)\n     * @param {number} event.z - Angular velocity around Z axis (rad/s)\n     */\n    _processGyroscope(event) {\n        const gx = Number(event.x) || 0;\n        const gy = Number(event.y) || 0;\n        const gz = Number(event.z) || 0;\n\n        // Scale factor to normalise typical angular velocity range (-10..10 rad/s) to -1..1\n        const scale = 0.1;\n        // Decay factor for integration (prevents drift)\n        const decay = 0.95;\n\n        this.spatialState.pitch = clamp(this.spatialState.pitch * decay + gx * scale, -1, 1);\n        this.spatialState.roll = clamp(this.spatialState.roll * decay + gy * scale, -1, 1);\n        this.spatialState.yaw = clamp(this.spatialState.yaw * decay + gz * scale, -1, 1);\n    }\n\n    /**\n     * Process Gamepad API data.\n     *\n     * Standard mapping:\n     *   Left stick X   --> roll\n     *   Left stick Y   --> pitch\n     *   Right stick X  --> yaw\n     *   Right stick Y  --> z (depth)\n     *   Left trigger    --> negative x\n     *   Right trigger   --> positive x\n     *\n     * @private\n     * @param {Gamepad|Object} gamepad\n     * @param {Object} [config={}]\n     * @param {number} [config.deadzone=0.1] - Analog stick deadzone\n     */\n    _processGamepad(gamepad, config = {}) {\n        const deadzone = Number(config.deadzone) || 0.1;\n        const axes = gamepad.axes || [];\n        const buttons = gamepad.buttons || [];\n\n        /**\n         * Apply deadzone to a value.\n         * @param {number} v\n         * @returns {number}\n         */\n        const applyDeadzone = (v) => {\n            return Math.abs(v) < deadzone ? 0 : v;\n        };\n\n        // Left stick\n        if (axes.length >= 2) {\n            this.spatialState.roll = clamp(applyDeadzone(axes[0]), -1, 1);\n            this.spatialState.pitch = clamp(applyDeadzone(-axes[1]), -1, 1); // Invert Y\n        }\n\n        // Right stick\n        if (axes.length >= 4) {\n            this.spatialState.yaw = clamp(applyDeadzone(axes[2]), -1, 1);\n            this.spatialState.z = clamp(applyDeadzone(-axes[3]), -1, 1);\n        }\n\n        // Triggers (L2 = button 6, R2 = button 7 in standard mapping)\n        if (buttons.length >= 8) {\n            const lt = typeof buttons[6] === 'object' ? buttons[6].value : Number(buttons[6]) || 0;\n            const rt = typeof buttons[7] === 'object' ? buttons[7].value : Number(buttons[7]) || 0;\n            this.spatialState.x = clamp(rt - lt, -1, 1);\n        }\n    }\n\n    /**\n     * Process AR/wearable perspective data.\n     *\n     * Expects pre-normalised orientation and position data from a\n     * perspective tracking system (WebXR, custom AR SDK, etc.).\n     *\n     * @private\n     * @param {Object} data\n     * @param {number} [data.pitch]  - Viewing pitch (-1..1)\n     * @param {number} [data.yaw]    - Viewing yaw (-1..1)\n     * @param {number} [data.roll]   - Viewing roll (-1..1)\n     * @param {number} [data.x]      - Position X (-1..1)\n     * @param {number} [data.y]      - Position Y (-1..1)\n     * @param {number} [data.z]      - Position Z (-1..1)\n     */\n    _processPerspective(data) {\n        if (Number.isFinite(data.pitch)) {\n            this.spatialState.pitch = clamp(data.pitch, -1, 1);\n        }\n        if (Number.isFinite(data.yaw)) {\n            this.spatialState.yaw = clamp(data.yaw, -1, 1);\n        }\n        if (Number.isFinite(data.roll)) {\n            this.spatialState.roll = clamp(data.roll, -1, 1);\n        }\n        if (Number.isFinite(data.x)) {\n            this.spatialState.x = clamp(data.x, -1, 1);\n        }\n        if (Number.isFinite(data.y)) {\n            this.spatialState.y = clamp(data.y, -1, 1);\n        }\n        if (Number.isFinite(data.z)) {\n            this.spatialState.z = clamp(data.z, -1, 1);\n        }\n    }\n\n    /**\n     * Process audio frequency band levels as spatial movement.\n     *\n     * Maps:\n     *   bass   --> pitch (deep frequencies drive forward tilt)\n     *   mid    --> yaw   (mid-range drives lateral movement)\n     *   high   --> roll  (high frequencies drive shimmer/roll)\n     *   energy --> x     (overall volume drives translation)\n     *\n     * Values are normalised 0..1 and mapped to -1..1 spatial range\n     * using oscillation modulated by the input level.\n     *\n     * @private\n     * @param {number} bass - Bass band level (0..1)\n     * @param {number} mid  - Mid band level (0..1)\n     * @param {number} high - High band level (0..1)\n     */\n    _processAudioSpatial(bass, mid, high) {\n        const b = clamp(bass, 0, 1);\n        const m = clamp(mid, 0, 1);\n        const h = clamp(high, 0, 1);\n        const energy = (b + m + h) / 3;\n\n        // Use time-based oscillation modulated by audio levels.\n        // This creates organic movement rather than static positioning.\n        const t = typeof performance !== 'undefined' ? performance.now() * 0.001 : Date.now() * 0.001;\n\n        this.spatialState.pitch = clamp(Math.sin(t * 1.3) * b, -1, 1);\n        this.spatialState.yaw = clamp(Math.sin(t * 0.7) * m, -1, 1);\n        this.spatialState.roll = clamp(Math.sin(t * 2.1) * h, -1, 1);\n        this.spatialState.x = clamp(Math.cos(t * 0.5) * energy, -1, 1);\n        this.spatialState.y = clamp(energy * 2 - 1, -1, 1);\n    }\n\n    /**\n     * Process MIDI Control Change data.\n     *\n     * Default mapping (configurable by adding sources with config):\n     *   CC 1  (Mod Wheel) --> pitch\n     *   CC 2  (Breath)    --> yaw\n     *   CC 11 (Expression)--> roll\n     *   CC 74 (Brightness)--> x\n     *   CC 71 (Resonance) --> y\n     *   CC 7  (Volume)    --> z\n     *\n     * MIDI CC values are 0..127, normalised to -1..1.\n     *\n     * @private\n     * @param {number} channel - MIDI channel (0..15)\n     * @param {number} cc      - Control Change number (0..127)\n     * @param {number} value   - CC value (0..127)\n     */\n    _processMIDI(channel, cc, value) {\n        // Normalise 0..127 to -1..1\n        const norm = clamp((value / 63.5) - 1.0, -1, 1);\n        // Normalise 0..127 to 0..1 (for unipolar axes)\n        const normUni = clamp(value / 127, 0, 1);\n\n        switch (cc) {\n            case 1:  // Mod Wheel\n                this.spatialState.pitch = norm;\n                break;\n            case 2:  // Breath Controller\n                this.spatialState.yaw = norm;\n                break;\n            case 11: // Expression Controller\n                this.spatialState.roll = norm;\n                break;\n            case 74: // Brightness (MPE slide)\n                this.spatialState.x = norm;\n                break;\n            case 71: // Resonance / Timbre\n                this.spatialState.y = norm;\n                break;\n            case 7:  // Channel Volume\n                this.spatialState.z = norm;\n                break;\n            default: {\n                // For unmapped CCs, distribute across axes by CC group\n                // This allows any CC to have some spatial effect\n                const axisIndex = cc % 6;\n                const axes = ['pitch', 'yaw', 'roll', 'x', 'y', 'z'];\n                this.spatialState[axes[axisIndex]] = norm;\n                break;\n            }\n        }\n\n        this._emit('midiInput', { channel, cc, value, normalized: norm });\n    }\n\n    /**\n     * Process programmatic / direct API input.\n     * Accepts a partial SpatialState and merges it.\n     *\n     * @private\n     * @param {Partial<SpatialState>} data\n     */\n    _processProgrammatic(data) {\n        for (const axis of SPATIAL_AXES) {\n            if (Number.isFinite(data[axis])) {\n                if (axis === 'intensity' || axis === 'velocity') {\n                    this.spatialState[axis] = clamp(data[axis], 0, 1);\n                } else {\n                    this.spatialState[axis] = clamp(data[axis], -1, 1);\n                }\n            }\n        }\n    }\n\n    // ------------------------------------------------------------------\n    // Event system\n    // ------------------------------------------------------------------\n\n    /**\n     * Subscribe to an event.\n     * @param {string}   event    - Event name\n     * @param {Function} callback - Handler function\n     */\n    on(event, callback) {\n        if (typeof callback !== 'function') return;\n        if (!this._listeners.has(event)) {\n            this._listeners.set(event, []);\n        }\n        this._listeners.get(event).push(callback);\n    }\n\n    /**\n     * Unsubscribe from an event.\n     * @param {string}   event    - Event name\n     * @param {Function} callback - Handler to remove\n     */\n    off(event, callback) {\n        if (!this._listeners.has(event)) return;\n        const arr = this._listeners.get(event);\n        const idx = arr.indexOf(callback);\n        if (idx !== -1) {\n            arr.splice(idx, 1);\n        }\n    }\n\n    /**\n     * Emit an event to all registered listeners.\n     * @private\n     * @param {string} event\n     * @param {*}      [data]\n     */\n    _emit(event, data) {\n        if (!this._listeners.has(event)) return;\n        for (const fn of this._listeners.get(event)) {\n            try {\n                fn(data);\n            } catch (err) {\n                console.error(`SpatialInputSystem: Event handler error for \"${event}\"`, err);\n            }\n        }\n    }\n\n    // ------------------------------------------------------------------\n    // Cleanup\n    // ------------------------------------------------------------------\n\n    /**\n     * Completely destroy the system, removing all listeners, sources,\n     * and global references.\n     */\n    destroy() {\n        this.disable();\n\n        // Remove all sources (which cleans up their listeners)\n        for (const name of Array.from(this.sources.keys())) {\n            this.removeSource(name);\n        }\n\n        this.mappings.clear();\n        this._listeners.clear();\n        this._customTargets.clear();\n        this.smoothing.clear();\n\n        // Clean up global references\n        if (typeof window !== 'undefined') {\n            if (window.spatialInputSystem === this) {\n                delete window.spatialInputSystem;\n            }\n            delete window.enableSpatialInput;\n            delete window.disableSpatialInput;\n            delete window.setSpatialProfile;\n            delete window.feedSpatialInput;\n            delete window.getSpatialState;\n        }\n\n        console.log('SpatialInputSystem: Destroyed');\n    }\n}\n\n// ---------------------------------------------------------------------------\n// Default instance setup\n// ---------------------------------------------------------------------------\n\n/**\n * Create and return a default SpatialInputSystem instance.\n *\n * The instance is created with default settings and registers global helpers\n * on the window object.  The caller should then add sources, load a profile,\n * and call `enable()`.\n *\n * @param {SpatialInputOptions} [options={}]\n * @returns {SpatialInputSystem}\n *\n * @example\n * import { createSpatialInputSystem } from './SpatialInputSystem.js';\n *\n * const spatial = createSpatialInputSystem({\n *     onParameterUpdate: (name, value) => engine.setParameter(name, value)\n * });\n * spatial.addSource('mouse', 'mousePosition');\n * spatial.loadProfile('uiElement');\n * spatial.enable();\n */\nexport function createSpatialInputSystem(options = {}) {\n    return new SpatialInputSystem(options);\n}\n\nexport default SpatialInputSystem;\n","/**\n * VitalitySystem.js\n * Manages the \"breath of life\" for the VIB3+ Engine.\n * Generates a global rhythmic breath cycle (Exhale/Evoke) that modulates\n * all visualization systems for a unified, organic feel.\n */\nexport class VitalitySystem {\n    constructor() {\n        this.time = 0;\n        this.breath = 0;\n        this.cycleDuration = 6000; // 6 seconds per breath\n        this.isRunning = false;\n    }\n\n    start() {\n        this.isRunning = true;\n        this.startTime = Date.now();\n    }\n\n    stop() {\n        this.isRunning = false;\n    }\n\n    /**\n     * Update the breath cycle.\n     * Returns a normalized 0-1 value representing the breath phase.\n     * 0 = Empty, 1 = Full\n     * Uses a sine wave for smooth organic motion.\n     */\n    update(deltaTime) {\n        if (!this.isRunning) return 0;\n\n        const now = Date.now();\n        const elapsed = now - this.startTime;\n\n        // 0 to 2PI over cycleDuration\n        const phase = (elapsed % this.cycleDuration) / this.cycleDuration;\n        const angle = phase * Math.PI * 2;\n\n        // Smooth sine wave: -1 to 1 -> 0 to 1\n        // We use -cos to start at 0 (empty), go to 1 (full), back to 0\n        this.breath = (1.0 - Math.cos(angle)) * 0.5;\n\n        // Add a small \"pause\" at the top and bottom for realism?\n        // For now, pure sine is hypnotic enough.\n\n        return this.breath;\n    }\n\n    getBreath() {\n        return this.breath;\n    }\n}\n","/**\n * VIB3+ Engine - Unified Visualization System\n * Coordinates Quantum, Faceted, and Holographic systems\n * Supports 24 geometries per system with full 6D rotation\n *\n * Backend selection: Faceted supports WebGL/WebGPU via UnifiedRenderBridge.\n * Quantum and Holographic use direct WebGL (5-layer canvas architecture).\n */\n\nimport { ParameterManager } from './Parameters.js';\nimport { CanvasManager } from './CanvasManager.js';\nimport { QuantumEngine } from '../quantum/QuantumEngine.js';\nimport { FacetedSystem } from '../faceted/FacetedSystem.js';\nimport { RealHolographicSystem } from '../holograms/RealHolographicSystem.js';\nimport { ReactivityManager } from '../reactivity/ReactivityManager.js';\nimport { ReactivityConfig } from '../reactivity/ReactivityConfig.js';\nimport { SpatialInputSystem } from '../reactivity/SpatialInputSystem.js';\nimport { VitalitySystem } from './VitalitySystem.js';\n\nexport class VIB3Engine {\n    /**\n     * @param {object} [options]\n     * @param {boolean} [options.preferWebGPU=true] - Prefer WebGPU with WebGL fallback\n     * @param {boolean} [options.debug=false] - Enable debug logging\n     * @param {object|ReactivityConfig} [options.reactivityConfig] - Initial reactivity config\n     */\n    constructor(options = {}) {\n        this.activeSystem = null; // Only one system active at a time\n        this.currentSystemName = options.system || 'quantum';\n        this.parameters = new ParameterManager();\n        this.initialized = false;\n        this.canvasManager = null;\n\n        /** @type {boolean} Whether to prefer WebGPU (default: true, falls back to WebGL) */\n        this.preferWebGPU = options.preferWebGPU !== false;\n\n        /** @type {boolean} Debug mode */\n        this.debug = options.debug || false;\n\n        /** @type {VitalitySystem} Global breathing rhythm */\n        this.vitality = new VitalitySystem();\n\n        /** @type {ReactivityManager} Reactivity system for audio/tilt/interaction */\n        this.reactivity = new ReactivityManager((name, value) => {\n            this.parameters.setParameter(name, value);\n            this.updateCurrentSystemParameters();\n        });\n\n        /** @type {SpatialInputSystem} Universal spatial input (evolved tilt/perspective/gamepad) */\n        this.spatialInput = new SpatialInputSystem({\n            sensitivity: options.spatialSensitivity || 1.0,\n            smoothing: options.spatialSmoothing || 0.15,\n            onParameterUpdate: (name, value) => {\n                this.parameters.setParameter(name, value);\n                this.updateCurrentSystemParameters();\n            }\n        });\n\n        // Load initial reactivity config if provided\n        if (options.reactivityConfig) {\n            this.reactivity.loadConfig(options.reactivityConfig);\n        }\n\n        // Load initial spatial profile if provided\n        if (options.spatialProfile) {\n            this.spatialInput.loadProfile(options.spatialProfile);\n        }\n    }\n\n    /**\n     * Initialize the VIB3+ engine\n     */\n    async initialize(containerId = 'vib3-container') {\n        console.log('Initializing VIB3+ Engine');\n\n        // Create CanvasManager\n        try {\n            this.canvasManager = new CanvasManager(containerId);\n        } catch (error) {\n            console.error('CanvasManager initialization failed:', error);\n            return false;\n        }\n\n        // Initialize starting system\n        const systemOk = await this.switchSystem(this.currentSystemName);\n        if (!systemOk) {\n            console.error(`VIB3+ Engine: Failed to create initial system \"${this.currentSystemName}\"`);\n            return false;\n        }\n\n        // Sync base parameters to reactivity manager\n        this.reactivity.setBaseParameters(this.parameters.getAllParameters());\n\n        // Start vitality system\n        this.vitality.start();\n\n        // Start global loop to drive vitality updates\n        this._startGlobalLoop();\n\n        this.initialized = true;\n        console.log('VIB3+ Engine initialized');\n        return true;\n    }\n\n    _startGlobalLoop() {\n        this._globalLoopActive = true;\n        const loop = () => {\n            if (!this._globalLoopActive) return;\n            if (this.initialized) {\n                // Update breath cycle\n                const breath = this.vitality.update();\n\n                // Push breath to current system\n                if (this.activeSystem && this.activeSystem.updateParameters) {\n                    this.activeSystem.updateParameters({ breath });\n                }\n            }\n            this._globalRafId = requestAnimationFrame(loop);\n        };\n        this._globalRafId = requestAnimationFrame(loop);\n    }\n\n    /**\n     * Create and initialize a specific system\n     * CRITICAL: Engines find canvases by ID in DOM, not passed as parameters!\n     */\n    async createSystem(systemName) {\n        console.log(`Creating ${systemName} system...`);\n\n        // Create canvases with correct IDs in DOM\n        const canvasIds = this.canvasManager.createSystemCanvases(systemName);\n\n        let system = null;\n        try {\n            switch (systemName) {\n                case 'quantum':\n                    system = new QuantumEngine();\n                    if (this.preferWebGPU) {\n                        try {\n                            const bridgeOk = await system.initWithBridge({\n                                preferWebGPU: true,\n                                debug: this.debug\n                            });\n                            if (bridgeOk) {\n                                console.log('Quantum: WebGPU bridge active');\n                                break;\n                            }\n                        } catch (_e) { /* fall through */ }\n                        console.warn('Quantum: WebGPU bridge failed, falling back to WebGL');\n                        system = new QuantumEngine();\n                    }\n                    break;\n\n                case 'faceted':\n                    system = new FacetedSystem();\n                    if (this.preferWebGPU) {\n                        const canvas = document.getElementById('content-canvas');\n                        if (canvas) {\n                            try {\n                                const bridgeOk = await system.initWithBridge(canvas, {\n                                    preferWebGPU: true,\n                                    debug: this.debug\n                                });\n                                if (bridgeOk) {\n                                    console.log('Faceted: WebGPU bridge active');\n                                    break;\n                                }\n                            } catch (_e) { /* fall through */ }\n                            console.warn('Faceted: WebGPU bridge failed, falling back to WebGL');\n                            system = new FacetedSystem();\n                        }\n                    }\n\n                    const facetedSuccess = await system.initialize();\n                    if (!facetedSuccess) {\n                        throw new Error('Faceted system initialization failed');\n                    }\n                    break;\n\n                case 'holographic':\n                    system = new RealHolographicSystem();\n                    if (this.preferWebGPU) {\n                        try {\n                            const bridgeOk = await system.initWithBridge({\n                                preferWebGPU: true,\n                                debug: this.debug\n                            });\n                            if (bridgeOk) {\n                                console.log('Holographic: WebGPU bridge active');\n                                break;\n                            }\n                        } catch (_e) { /* fall through */ }\n                        console.warn('Holographic: WebGPU bridge failed, falling back to WebGL');\n                        system = new RealHolographicSystem();\n                    }\n                    break;\n\n                default:\n                    throw new Error(`Unknown system: ${systemName}`);\n            }\n\n            // Register WebGL contexts with CanvasManager for cleanup\n            canvasIds.forEach(canvasId => {\n                const canvas = document.getElementById(canvasId);\n                if (canvas) {\n                    const gl = canvas.getContext('webgl') || canvas.getContext('webgl2');\n                    if (gl) {\n                        this.canvasManager.registerContext(canvasId, gl);\n                    }\n                }\n            });\n\n            // Apply current parameters\n            system.updateParameters(this.parameters.getAllParameters());\n            system.setActive(true);\n\n            console.log(`${systemName} system created and activated`);\n            return system;\n\n        } catch (error) {\n            console.error(`${systemName} system creation failed:`, error);\n            throw error;\n        }\n    }\n\n    /**\n     * Switch between visualization systems\n     * DESTROYS old system and CREATES new system (proper WebGL cleanup)\n     */\n    async switchSystem(systemName) {\n        if (!['quantum', 'faceted', 'holographic'].includes(systemName)) {\n            console.error('Unknown system:', systemName);\n            return false;\n        }\n\n        console.log(`Switching from ${this.currentSystemName} to ${systemName}`);\n\n        // Destroy active system if exists\n        if (this.activeSystem) {\n            if (this.activeSystem.setActive) {\n                this.activeSystem.setActive(false);\n            }\n            if (this.activeSystem.destroy) {\n                this.activeSystem.destroy();\n            }\n            this.activeSystem = null;\n        }\n\n        // Create and initialize new system\n        try {\n            this.activeSystem = await this.createSystem(systemName);\n            this.currentSystemName = systemName;\n            console.log(`Switched to ${systemName} system`);\n            return true;\n        } catch (error) {\n            console.error(`Failed to switch to ${systemName}:`, error);\n            return false;\n        }\n    }\n\n    /**\n     * Get the active backend type for the current system\n     * @returns {'webgl'|'webgpu'|'direct-webgl'|null}\n     */\n    getActiveBackendType() {\n        if (this.activeSystem && this.activeSystem.getBackendType) {\n            return this.activeSystem.getBackendType();\n        }\n        return null;\n    }\n\n    /**\n     * Update parameters for active system\n     */\n    updateCurrentSystemParameters() {\n        const params = this.parameters.getAllParameters();\n\n        if (this.activeSystem && this.activeSystem.updateParameters) {\n            this.activeSystem.updateParameters(params);\n        } else if (this.debug && this.activeSystem && !this.activeSystem.updateParameters) {\n            console.warn('VIB3+ Engine [debug]: activeSystem missing updateParameters() method');\n        } else if (this.debug && !this.activeSystem) {\n            console.warn('VIB3+ Engine [debug]: updateCurrentSystemParameters() called with no activeSystem');\n        }\n\n        // Notify parameter change listeners\n        if (this._parameterListeners && this._parameterListeners.size > 0) {\n            for (const listener of this._parameterListeners) {\n                try { listener(params); } catch (_) { /* listener error */ }\n            }\n        }\n    }\n\n    /**\n     * Update a single parameter\n     */\n    setParameter(name, value) {\n        this.parameters.setParameter(name, value);\n        this.reactivity.setBaseParameter(name, value);\n        this.updateCurrentSystemParameters();\n    }\n\n    /**\n     * Update multiple parameters\n     */\n    setParameters(params) {\n        this.parameters.setParameters(params);\n        this.reactivity.setBaseParameters(params);\n        this.updateCurrentSystemParameters();\n    }\n\n    /**\n     * Get current parameter value\n     */\n    getParameter(name) {\n        return this.parameters.getParameter(name);\n    }\n\n    /**\n     * Get all parameters\n     */\n    getAllParameters() {\n        return this.parameters.getAllParameters();\n    }\n\n    /**\n     * Randomize all parameters\n     */\n    randomizeAll() {\n        this.parameters.randomizeAll();\n        this.updateCurrentSystemParameters();\n    }\n\n    /**\n     * Reset to defaults\n     */\n    resetAll() {\n        this.parameters.resetToDefaults();\n        this.updateCurrentSystemParameters();\n    }\n\n    /**\n     * Get current system name\n     */\n    getCurrentSystem() {\n        return this.currentSystemName;\n    }\n\n    /**\n     * Get active system instance\n     */\n    getActiveSystemInstance() {\n        return this.activeSystem;\n    }\n\n    // ========================================================================\n    // Reactivity\n    // ========================================================================\n\n    /**\n     * Get the ReactivityManager instance\n     * @returns {ReactivityManager}\n     */\n    getReactivityManager() {\n        return this.reactivity;\n    }\n\n    /**\n     * Load a reactivity configuration\n     * @param {object|ReactivityConfig} config\n     * @returns {{ valid: boolean, errors: string[] }}\n     */\n    loadReactivityConfig(config) {\n        return this.reactivity.loadConfig(config);\n    }\n\n    /**\n     * Get current reactivity configuration\n     * @returns {object}\n     */\n    getReactivityConfig() {\n        return this.reactivity.getConfig();\n    }\n\n    /**\n     * Start reactivity processing (audio/tilt/interaction)\n     */\n    startReactivity() {\n        this.reactivity.setBaseParameters(this.parameters.getAllParameters());\n        this.reactivity.start();\n    }\n\n    /**\n     * Stop reactivity processing\n     */\n    stopReactivity() {\n        this.reactivity.stop();\n    }\n\n    /**\n     * Check if reactivity is active\n     * @returns {boolean}\n     */\n    isReactivityActive() {\n        return this.reactivity.isActive;\n    }\n\n    /**\n     * Feed audio data into the reactivity system\n     * @param {number} bass - Bass level 0-1\n     * @param {number} mid - Mid level 0-1\n     * @param {number} high - High level 0-1\n     * @param {number} [energy] - Overall energy (computed if omitted)\n     */\n    setAudioInput(bass, mid, high, energy) {\n        this.reactivity.setAudioInput(bass, mid, high, energy);\n    }\n\n    /**\n     * Feed device tilt data into the reactivity system\n     * @param {number} alpha - Z-axis rotation (0-360)\n     * @param {number} beta - X-axis rotation (-180 to 180)\n     * @param {number} gamma - Y-axis rotation (-90 to 90)\n     */\n    setTiltInput(alpha, beta, gamma) {\n        this.reactivity.setTiltInput(alpha, beta, gamma);\n    }\n\n    /**\n     * Feed mouse position into the reactivity system\n     * @param {number} x - Normalized X (0-1)\n     * @param {number} y - Normalized Y (0-1)\n     * @param {number} [velocityX=0]\n     * @param {number} [velocityY=0]\n     */\n    setMouseInput(x, y, velocityX = 0, velocityY = 0) {\n        this.reactivity.setMouseInput(x, y, velocityX, velocityY);\n    }\n\n    /**\n     * Trigger a click event in the reactivity system\n     * @param {number} [intensity=1.0]\n     */\n    triggerClick(intensity = 1.0) {\n        this.reactivity.triggerClick(intensity);\n    }\n\n    /**\n     * Feed scroll delta into the reactivity system\n     * @param {number} delta\n     */\n    setScrollDelta(delta) {\n        this.reactivity.setScrollDelta(delta);\n    }\n\n    /**\n     * Feed touch data into the reactivity system\n     * @param {Touch[]} touches\n     * @param {number} [pinchScale=1]\n     * @param {number} [rotation=0]\n     */\n    setTouchInput(touches, pinchScale = 1, rotation = 0) {\n        this.reactivity.setTouchInput(touches, pinchScale, rotation);\n    }\n\n    // ========================================================================\n    // Spatial Input System\n    // ========================================================================\n\n    /**\n     * Get the SpatialInputSystem instance\n     * @returns {SpatialInputSystem}\n     */\n    getSpatialInputSystem() {\n        return this.spatialInput;\n    }\n\n    /**\n     * Enable spatial input with a named profile\n     * @param {string} [profile='cardTilt'] - Profile name\n     * @returns {boolean}\n     */\n    enableSpatialInput(profile = 'cardTilt') {\n        this.spatialInput.loadProfile(profile);\n        this.spatialInput.enable();\n        return true;\n    }\n\n    /**\n     * Disable spatial input\n     */\n    disableSpatialInput() {\n        this.spatialInput.disable();\n    }\n\n    /**\n     * Switch spatial input profile\n     * @param {string} profile - Profile name\n     */\n    setSpatialProfile(profile) {\n        this.spatialInput.loadProfile(profile);\n    }\n\n    /**\n     * Feed external spatial data (for programmatic/API use)\n     * @param {object} data - Spatial state data {pitch, yaw, roll, x, y, z}\n     */\n    feedSpatialInput(data) {\n        this.spatialInput.feedInput('programmatic', data);\n    }\n\n    /**\n     * Set spatial input sensitivity\n     * @param {number} value - 0.1 to 5.0\n     */\n    setSpatialSensitivity(value) {\n        this.spatialInput.setSensitivity(value);\n    }\n\n    /**\n     * Toggle dramatic spatial mode (8x amplification)\n     * @param {boolean} enabled\n     */\n    setSpatialDramaticMode(enabled) {\n        this.spatialInput.setDramaticMode(enabled);\n    }\n\n    // ========================================================================\n    // Geometry\n    // ========================================================================\n\n    /**\n     * Get geometry names for current system\n     */\n    getGeometryNames() {\n        return [\n            // Base geometries (0-7)\n            'Tetrahedron',\n            'Hypercube',\n            'Sphere',\n            'Torus',\n            'Klein Bottle',\n            'Fractal',\n            'Wave',\n            'Crystal',\n            // Hypersphere Core (8-15)\n            'Hypersphere Core (Tetrahedron)',\n            'Hypersphere Core (Hypercube)',\n            'Hypersphere Core (Sphere)',\n            'Hypersphere Core (Torus)',\n            'Hypersphere Core (Klein)',\n            'Hypersphere Core (Fractal)',\n            'Hypersphere Core (Wave)',\n            'Hypersphere Core (Crystal)',\n            // Hypertetrahedron Core (16-23)\n            'Hypertetrahedron Core (Tetrahedron)',\n            'Hypertetrahedron Core (Hypercube)',\n            'Hypertetrahedron Core (Sphere)',\n            'Hypertetrahedron Core (Torus)',\n            'Hypertetrahedron Core (Klein)',\n            'Hypertetrahedron Core (Fractal)',\n            'Hypertetrahedron Core (Wave)',\n            'Hypertetrahedron Core (Crystal)'\n        ];\n    }\n\n    /**\n     * Export current state\n     */\n    exportState() {\n        return {\n            system: this.currentSystemName,\n            parameters: this.parameters.getAllParameters(),\n            reactivity: this.reactivity.getConfig(),\n            reactivityActive: this.reactivity.isActive,\n            spatialInput: this.spatialInput.exportConfig(),\n            spatialActive: this.spatialInput.enabled,\n            backend: this.getActiveBackendType(),\n            timestamp: new Date().toISOString(),\n            version: '2.0.3'\n        };\n    }\n\n    /**\n     * Import state\n     */\n    async importState(state) {\n        if (!state || typeof state !== 'object') {\n            console.warn('VIB3Engine: importState received invalid state');\n            return;\n        }\n\n        // Size guard: reject excessively large state objects (> 256 KB serialized)\n        try {\n            const serialized = JSON.stringify(state);\n            if (serialized.length > 256 * 1024) {\n                console.warn('VIB3Engine: importState rejected — state exceeds 256 KB');\n                return;\n            }\n        } catch {\n            console.warn('VIB3Engine: importState received non-serializable state');\n            return;\n        }\n\n        // Depth guard: reject deeply nested objects (max depth 6)\n        const maxDepth = (obj, depth = 0) => {\n            if (depth > 6) return depth;\n            if (!obj || typeof obj !== 'object') return depth;\n            let max = depth;\n            for (const v of Object.values(obj)) {\n                max = Math.max(max, maxDepth(v, depth + 1));\n                if (max > 6) return max;\n            }\n            return max;\n        };\n        if (maxDepth(state) > 6) {\n            console.warn('VIB3Engine: importState rejected — state nesting exceeds depth 6');\n            return;\n        }\n\n        if (state.system && typeof state.system === 'string') {\n            await this.switchSystem(state.system);\n        }\n        if (state.parameters && typeof state.parameters === 'object' && !Array.isArray(state.parameters)) {\n            // Only allow known parameter keys through\n            const safeParams = {};\n            for (const [key, value] of Object.entries(state.parameters)) {\n                if (typeof value === 'number' && Number.isFinite(value)) {\n                    safeParams[key] = value;\n                }\n            }\n            this.parameters.setParameters(safeParams);\n            this.reactivity.setBaseParameters(safeParams);\n            this.updateCurrentSystemParameters();\n        }\n        if (state.reactivity && typeof state.reactivity === 'object' && !Array.isArray(state.reactivity)) {\n            this.reactivity.loadConfig(state.reactivity);\n        }\n        if (state.reactivityActive) {\n            this.startReactivity();\n        }\n        if (state.spatialInput && typeof state.spatialInput === 'object') {\n            this.spatialInput.importConfig(state.spatialInput);\n        }\n        if (state.spatialActive) {\n            this.spatialInput.enable();\n        }\n    }\n\n    // ========================================================================\n    // Convenience Methods (dogfood feedback)\n    // ========================================================================\n\n    /**\n     * Create a parameter update callback for use with creative modules.\n     * Returns (name, value) => void that calls setParameter internally.\n     * Eliminates boilerplate: `(name, value) => engine.setParameter(name, value)`.\n     * @returns {(name: string, value: number) => void}\n     */\n    createParameterCallback() {\n        return (name, value) => this.setParameter(name, value);\n    }\n\n    /**\n     * Get current breath value from VitalitySystem (0-1).\n     * Avoids reaching into engine.vitality.getBreath() directly.\n     * @returns {number}\n     */\n    getBreath() {\n        return this.vitality.getBreath();\n    }\n\n    /**\n     * Register a listener for parameter changes.\n     * Callback receives the full parameter object after each change.\n     * @param {(params: object) => void} callback\n     * @returns {() => void} Unsubscribe function\n     */\n    onParameterChange(callback) {\n        if (!this._parameterListeners) {\n            this._parameterListeners = new Set();\n        }\n        this._parameterListeners.add(callback);\n        return () => this._parameterListeners.delete(callback);\n    }\n\n    /**\n     * Destroy engine and clean up\n     */\n    destroy() {\n        // Cancel global breath loop\n        this._globalLoopActive = false;\n        if (this._globalRafId) {\n            cancelAnimationFrame(this._globalRafId);\n            this._globalRafId = null;\n        }\n\n        this.vitality.stop();\n\n        // Stop and destroy spatial input\n        if (this.spatialInput) {\n            this.spatialInput.destroy();\n        }\n\n        // Stop and destroy reactivity\n        if (this.reactivity) {\n            this.reactivity.destroy();\n        }\n\n        // Destroy active system\n        if (this.activeSystem && this.activeSystem.destroy) {\n            this.activeSystem.destroy();\n        }\n        this.activeSystem = null;\n\n        // Destroy canvas manager\n        if (this.canvasManager) {\n            this.canvasManager.destroy();\n        }\n        this.canvasManager = null;\n\n        this.initialized = false;\n        console.log('VIB3+ Engine destroyed');\n    }\n}\n","/**\n * VIB3Universe - High-Level Entry Point for VIB3+ Ultra\n * \n * Combines Orchestrator (Logic) and Compositor (Visuals) into a single API.\n * Manages the \"World\" where multiple VIB3+ instances coexist.\n *\n * @experimental\n */\nimport { VIB3Orchestrator } from './VIB3Orchestrator.js';\nimport { VIB3Compositor } from './VIB3Compositor.js';\nimport { VIB3Actor } from './VIB3Actor.js';\nimport { VIB3Engine } from '../core/VIB3Engine.js';\n\nexport class VIB3Universe {\n    /**\n     * @param {string} containerId - DOM ID for the universe container\n     */\n    constructor(containerId = 'vib3-universe') {\n        this.orchestrator = new VIB3Orchestrator();\n        this.compositor = new VIB3Compositor(containerId);\n        this.actors = new Map(); // id -> VIB3Actor\n    }\n\n    /**\n     * Start the universe simulation.\n     */\n    start() {\n        this.orchestrator.start();\n    }\n\n    /**\n     * Stop the universe simulation.\n     */\n    stop() {\n        this.orchestrator.stop();\n    }\n\n    /**\n     * Spawn a new actor into the universe.\n     * @param {object} config\n     * @param {string} config.personality - Actor personality profile\n     * @param {string} config.system - Visualization system ('quantum', 'faceted', 'holographic')\n     * @param {number} config.geometry - Initial geometry index\n     * @param {object} config.layer - Layer options { zIndex, blendMode, opacity, position }\n     * @returns {Promise<VIB3Actor>} The spawned actor\n     */\n    async spawnActor(config = {}) {\n        const actorId = `actor_${Date.now()}_${Math.floor(Math.random() * 1000)}`;\n        \n        // 1. Create a container for this actor's engine\n        const container = document.createElement('div');\n        container.id = `container_${actorId}`;\n        container.style.width = '100%';\n        container.style.height = '100%';\n        container.style.pointerEvents = 'none'; // Default to pass-through events\n        \n        // 2. Add to compositor (visual layer)\n        this.compositor.addInstance(actorId, container, config.layer || {});\n\n        // 3. Initialize VIB3 Engine\n        const engine = new VIB3Engine({ \n            system: config.system || 'holographic',\n            preferWebGPU: true // Ultra tier defaults to high perf\n        });\n\n        // Initialize engine within the container\n        // Note: VIB3Engine.initialize expects a container ID\n        await engine.initialize(container.id);\n        \n        // Set initial state\n        if (config.geometry !== undefined) {\n            engine.setParameter('geometry', config.geometry);\n        }\n\n        // 4. Wrap in Actor (logic layer)\n        const actor = new VIB3Actor(engine, config.personality || 'neutral');\n        actor.id = actorId;\n\n        // 5. Register with Orchestrator (simulation loop)\n        this.orchestrator.entities.set(actorId, actor);\n        this.actors.set(actorId, actor);\n\n        console.log(`VIB3Universe: Spawned actor ${actorId}`);\n        return actor;\n    }\n\n    /**\n     * Remove an actor from the universe.\n     * @param {string} actorId \n     */\n    despawnActor(actorId) {\n        const actor = this.actors.get(actorId);\n        if (actor) {\n            // Remove from logic\n            this.orchestrator.kill(actorId);\n            \n            // Cleanup engine\n            if (actor.engine && actor.engine.destroy) {\n                actor.engine.destroy();\n            }\n\n            // Remove from visuals\n            this.compositor.removeInstance(actorId);\n            this.actors.delete(actorId);\n            \n            console.log(`VIB3Universe: Despawned actor ${actorId}`);\n        }\n    }\n}\n"],"names":["VIB3Orchestrator","type","config","id","entity","k","v","dt","timestamp","name","detail","event","callback","e","VIB3Compositor","containerId","instanceId","canvasElement","options","order","index","el","_nextTransitionId","TransitionAnimator","parameterUpdateFn","parameterGetFn","params","duration","easing","onComplete","onUpdate","fromValues","paramName","record","targetState","steps","seqId","seq","step","transition","seqIndex","tId","t","now","completed","elapsed","rawProgress","eased","from","to","value","idx","stepId","startStep","val","defaults","a","b","diff","result","c4","VIB3Actor","engine","profile","time","breath","emotionName","intensity","mapping","targetParams","param","baseVal","profiles","CanvasManager","systemName","canvasIds","viewWidth","viewHeight","dpr","canvasId","canvas","gl","ext","baseIds","TARGETABLE_PARAMETERS","AUDIO_BANDS","BLEND_MODES","INTERACTION_MODES","DEFAULT_REACTIVITY_CONFIG","ReactivityConfig","obj","partialConfig","target","source","key","errors","audio","band","bandConfig","tilt","axis","interaction","enabled","weight","mode","sensitivity","scale","clamp","json","parsed","minimal","current","subResult","ReactivityManager","fn","validation","cfg","audioConfig","globalSens","bandName","scaledValue","tiltConfig","mappings","sens","axisValue","delta","interactionConfig","mouseConfig","mouse","targets","x","y","velocity","clickConfig","click","scrollConfig","scroll","direction","touchConfig","touch","baseValue","newValue","bass","mid","high","energy","alpha","beta","gamma","velocityX","velocityY","touches","pinchScale","rotation","callbacks","data","SOURCE_TYPES","SPATIAL_AXES","DRAMATIC_MULTIPLIER","MAX_SOURCES","MAX_MAPPINGS","lo","hi","lerp","createSpatialState","SpatialInputSystem","entry","list","sourceAxis","targetParam","clampRange","blendMode","removed","profileName","m","meta","p","sourceType","s","err","ts","deltaTime","rawIntensity","lerpFactor","velocitySum","accumulator","existing","handler","permission","element","frequency","sensor","gamepads","gamepad","width","height","w","h","normX","normY","gx","gy","gz","decay","deadzone","axes","buttons","applyDeadzone","lt","rt","channel","cc","norm","axisIndex","arr","VitalitySystem","angle","VIB3Engine","ParameterManager","error","loop","system","QuantumEngine","FacetedSystem","RealHolographicSystem","listener","state","maxDepth","depth","max","safeParams","VIB3Universe","actorId","container","actor"],"mappings":"qEASO,MAAMA,CAAiB,CAC1B,aAAc,CACV,KAAK,SAAW,IAAI,IACpB,KAAK,aAAe,EAGpB,KAAK,KAAO,EACZ,KAAK,cAAgB,EACrB,KAAK,OAAS,GAGd,KAAK,SAAW,IAAI,YAGpB,KAAK,KAAO,KAAK,KAAK,KAAK,IAAI,CACnC,CAKA,OAAQ,CACA,KAAK,UACT,KAAK,QAAU,GACf,KAAK,cAAgB,YAAY,IAAG,EACpC,sBAAsB,KAAK,IAAI,EAC/B,QAAQ,IAAI,qCAAqC,EACrD,CAKA,MAAO,CACH,KAAK,QAAU,GACf,QAAQ,IAAI,qCAAqC,CACrD,CAQA,MAAMC,EAAMC,EAAS,GAAI,CACrB,MAAMC,EAAK,eAAe,KAAK,cAAc,GAIvCC,EAAS,CACX,GAAAD,EACA,KAAAF,EACA,OAAAC,EACA,SAAUA,EAAO,UAAY,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,CAAC,EAC/C,SAAUA,EAAO,UAAY,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,CAAC,EACrD,OAAQ,GAGR,OAAQ,CACJ,aAAc,CAACG,EAAGC,IAAM,QAAQ,IAAI,IAAIH,CAAE,SAASE,CAAC,IAAIC,CAAC,EAAE,EAC3D,aAAeD,GAAM,CACrC,EAEY,OAASE,GAAO,CAGhB,CACZ,EAEQ,YAAK,SAAS,IAAIJ,EAAIC,CAAM,EAC5B,KAAK,KAAK,gBAAiB,CAAE,GAAAD,EAAI,KAAAF,CAAI,CAAE,EACvC,QAAQ,IAAI,6BAA6BA,CAAI,KAAKE,CAAE,GAAG,EAEhDA,CACX,CAMA,KAAKA,EAAI,CACL,GAAI,KAAK,SAAS,IAAIA,CAAE,EAAG,CACvB,MAAMC,EAAS,KAAK,SAAS,IAAID,CAAE,EAE/BC,EAAO,SAASA,EAAO,QAAO,EAElC,KAAK,SAAS,OAAOD,CAAE,EACvB,KAAK,KAAK,kBAAmB,CAAE,GAAAA,CAAE,CAAE,EACnC,QAAQ,IAAI,mCAAmCA,CAAE,EAAE,CACvD,CACJ,CAOA,KAAKK,EAAW,CACZ,GAAI,CAAC,KAAK,QAAS,OAEnB,MAAMD,GAAMC,EAAY,KAAK,eAAiB,IAC9C,KAAK,cAAgBA,EACrB,KAAK,MAAQD,EAGb,KAAK,SAAS,QAAQH,GAAU,CACxBA,EAAO,QAAUA,EAAO,QACxBA,EAAO,OAAO,KAAK,KAAMG,CAAE,CAEnC,CAAC,EAQD,sBAAsB,KAAK,IAAI,CACnC,CAOA,KAAKE,EAAMC,EAAQ,CACf,MAAMC,EAAQ,IAAI,YAAYF,EAAM,CAAE,OAAAC,CAAM,CAAE,EAC9C,KAAK,SAAS,cAAcC,CAAK,CACrC,CAOA,GAAGF,EAAMG,EAAU,CACf,KAAK,SAAS,iBAAiBH,EAAOI,GAAMD,EAASC,EAAE,MAAM,CAAC,CAClE,CACJ,CCzIO,MAAMC,CAAe,CACxB,YAAYC,EAAc,gBAAiB,CACvC,KAAK,YAAcA,EACnB,KAAK,OAAS,GACd,KAAK,gBAAkB,IAAI,IAGvB,OAAO,SAAa,MACpB,KAAK,UAAY,SAAS,eAAeA,CAAW,EAC/C,KAAK,YACN,KAAK,UAAY,SAAS,cAAc,KAAK,EAC7C,KAAK,UAAU,GAAKA,EACpB,KAAK,UAAU,MAAM,SAAW,WAChC,KAAK,UAAU,MAAM,MAAQ,QAC7B,KAAK,UAAU,MAAM,OAAS,QAC9B,KAAK,UAAU,MAAM,SAAW,SAChC,SAAS,KAAK,YAAY,KAAK,SAAS,GAGpD,CAQA,YAAYC,EAAYC,EAAeC,EAAU,CAAA,EAAI,CACjD,GAAI,KAAK,gBAAgB,IAAIF,CAAU,EAAG,CACtC,QAAQ,KAAK,4BAA4BA,CAAU,sBAAsB,EACzE,MACJ,CAGAC,EAAc,MAAM,SAAW,WAC/BA,EAAc,MAAM,IAAM,IAC1BA,EAAc,MAAM,KAAO,IAC3BA,EAAc,MAAM,MAAQ,OAC5BA,EAAc,MAAM,OAAS,OAG7B,KAAK,YAAYD,EAAYE,CAAO,EAEpC,KAAK,UAAU,YAAYD,CAAa,EACxC,KAAK,gBAAgB,IAAID,EAAYC,CAAa,EAClD,KAAK,OAAO,KAAKD,CAAU,EAE3B,QAAQ,IAAI,kCAAkCA,CAAU,EAAE,CAC9D,CAMA,eAAeA,EAAY,CACvB,GAAI,KAAK,gBAAgB,IAAIA,CAAU,EAAG,CACtC,MAAMC,EAAgB,KAAK,gBAAgB,IAAID,CAAU,EACrDC,EAAc,YACdA,EAAc,WAAW,YAAYA,CAAa,EAEtD,KAAK,gBAAgB,OAAOD,CAAU,EACtC,KAAK,OAAS,KAAK,OAAO,OAAOb,GAAMA,IAAOa,CAAU,EACxD,QAAQ,IAAI,oCAAoCA,CAAU,EAAE,CAChE,CACJ,CAOA,YAAYA,EAAYE,EAAS,CAC7B,MAAMD,EAAgB,KAAK,gBAAgB,IAAID,CAAU,EACpDC,IAEDC,EAAQ,SAAW,SAAWD,EAAc,MAAM,OAASC,EAAQ,QACnEA,EAAQ,YAAc,SAAWD,EAAc,MAAM,aAAeC,EAAQ,WAC5EA,EAAQ,UAAY,SAAWD,EAAc,MAAM,QAAUC,EAAQ,SACrEA,EAAQ,UAAY,SAAWD,EAAc,MAAM,QAAUC,EAAQ,QAAU,QAAU,QAGzFA,EAAQ,YACRD,EAAc,MAAM,gBAAkB,OAAOC,EAAQ,SAAS,IAC9DD,EAAc,MAAM,UAAY,OAAOC,EAAQ,SAAS,KAEhE,CAMA,cAAcC,EAAO,CACjBA,EAAM,QAAQ,CAAChB,EAAIiB,IAAU,CACzB,KAAK,YAAYjB,EAAI,CAAE,OAAQiB,CAAK,CAAE,CAC1C,CAAC,EACD,KAAK,OAASD,CAClB,CAKA,OAAQ,CACJ,KAAK,gBAAgB,QAAQ,CAACE,EAAIlB,IAAO,CACjCkB,EAAG,YAAYA,EAAG,WAAW,YAAYA,CAAE,CACnD,CAAC,EACD,KAAK,gBAAgB,MAAK,EAC1B,KAAK,OAAS,CAAA,CAClB,CACJ,CCxEA,IAAIC,EAAoB,EAyBjB,MAAMC,CAAmB,CAW5B,YAAYC,EAAmBC,EAAiB,KAAM,CAClD,GAAI,OAAOD,GAAsB,WAC7B,MAAM,IAAI,MAAM,0DAA0D,EAI9E,KAAK,gBAAkBA,EAGvB,KAAK,aAAe,OAAOC,GAAmB,WAAaA,EAAiB,KAG5E,KAAK,kBAAoB,IAAI,IAG7B,KAAK,UAAY,CAAA,EAGjB,KAAK,SAAW,KAGhB,KAAK,aAAe,CAAA,EAMpB,KAAK,gBAAkB,KAAK,sBAAqB,CACrD,CAgBA,WAAWC,EAAQC,EAAW,IAAMC,EAAS,YAAaC,EAAa,KAAMC,EAAW,KAAM,CAC1F,GAAI,CAACJ,GAAU,OAAOA,GAAW,SAC7B,eAAQ,KAAK,8CAA8C,EACpD,KAGX,MAAMvB,EAAK,cAAc,EAAEmB,CAAiB,GACtCS,EAAa,CAAA,EAGnB,UAAWC,KAAa,OAAO,KAAKN,CAAM,EACtCK,EAAWC,CAAS,EAAI,KAAK,iBAAiBA,CAAS,EAI3D,MAAMC,EAAS,CACX,GAAA9B,EACA,WAAA4B,EACA,SAAU,CAAE,GAAGL,CAAM,EACrB,UAAW,YAAY,IAAG,EAC1B,SAAU,KAAK,IAAI,EAAGC,CAAQ,EAC9B,OAAQ,KAAK,gBAAgBC,CAAM,EAAIA,EAAS,YAChD,WAAY,OAAOC,GAAe,WAAaA,EAAa,KAC5D,SAAU,OAAOC,GAAa,WAAaA,EAAW,KACtD,UAAW,EACvB,EAEQ,YAAK,kBAAkB,IAAI3B,EAAI8B,CAAM,EACrC,KAAK,iBAAgB,EAEd9B,CACX,CAWA,aAAa+B,EAAaP,EAAW,IAAMC,EAAS,YAAaC,EAAa,KAAM,CAChF,OAAO,KAAK,WAAWK,EAAaP,EAAUC,EAAQC,CAAU,CACpE,CASA,SAASM,EAAON,EAAa,KAAM,CAC/B,GAAI,CAAC,MAAM,QAAQM,CAAK,GAAKA,EAAM,SAAW,EAC1C,eAAQ,KAAK,kEAAkE,EACxE,KAGX,MAAMC,EAAQ,YAAY,EAAEd,CAAiB,GAEvCe,EAAM,CACR,GAAID,EACJ,MAAOD,EAAM,IAAIG,IAAS,CACtB,OAAQ,CAAE,GAAGA,EAAK,MAAM,EACxB,SAAUA,EAAK,UAAY,KAAOA,EAAK,SAAW,IAClD,OAAQA,EAAK,QAAU,YACvB,MAAOA,EAAK,OAAS,CACrC,EAAc,EACF,aAAc,EACd,WAAY,OAAOT,GAAe,WAAaA,EAAa,IACxE,EAEQ,YAAK,UAAU,KAAKQ,CAAG,EACvB,KAAK,qBAAqBA,CAAG,EAEtBD,CACX,CAYA,OAAOjC,EAAI,CAEP,MAAMoC,EAAa,KAAK,kBAAkB,IAAIpC,CAAE,EAChD,GAAIoC,EACA,OAAAA,EAAW,UAAY,GACvB,KAAK,kBAAkB,OAAOpC,CAAE,EACzB,GAIX,MAAMqC,EAAW,KAAK,UAAU,UAAU,GAAK,EAAE,KAAOrC,CAAE,EAC1D,GAAIqC,GAAY,EAAG,CACH,KAAK,UAAUA,CAAQ,EAEnC,SAAW,CAACC,EAAKC,CAAC,IAAK,KAAK,kBACpBD,EAAI,WAAWtC,EAAK,QAAQ,IAC5BuC,EAAE,UAAY,GACd,KAAK,kBAAkB,OAAOD,CAAG,GAGzC,YAAK,UAAU,OAAOD,EAAU,CAAC,EAC1B,EACX,CAEA,MAAO,EACX,CAKA,WAAY,CACR,SAAW,CAAA,CAAGD,CAAU,IAAK,KAAK,kBAC9BA,EAAW,UAAY,GAE3B,KAAK,kBAAkB,MAAK,EAC5B,KAAK,UAAU,OAAS,EAEpB,KAAK,WAAa,OAClB,qBAAqB,KAAK,QAAQ,EAClC,KAAK,SAAW,KAExB,CAWA,aAAc,CACV,OAAO,KAAK,kBAAkB,KAAO,GAAK,KAAK,UAAU,OAAS,CACtE,CAOA,gBAAiB,CACb,OAAO,KAAK,kBAAkB,IAClC,CAOA,gBAAiB,CACb,OAAO,OAAO,KAAK,KAAK,eAAe,CAC3C,CASA,SAAU,CACN,KAAK,UAAS,EACd,KAAK,aAAe,CAAA,CACxB,CAUA,kBAAmB,CACX,KAAK,WAAa,OAClB,KAAK,SAAW,sBAAsB,IAAM,KAAK,MAAK,CAAE,EAEhE,CAMA,OAAQ,CACJ,KAAK,SAAW,KAChB,MAAMI,EAAM,YAAY,IAAG,EACrBC,EAAY,CAAA,EAElB,SAAW,CAACzC,EAAIuC,CAAC,IAAK,KAAK,kBAAmB,CAC1C,GAAIA,EAAE,UAAW,CACbE,EAAU,KAAKzC,CAAE,EACjB,QACJ,CAEA,MAAM0C,EAAUF,EAAMD,EAAE,UAClBI,EAAcJ,EAAE,SAAW,EAAI,KAAK,IAAIG,EAAUH,EAAE,SAAU,CAAC,EAAI,EAEnEK,GADS,KAAK,gBAAgBL,EAAE,MAAM,GAAK,KAAK,gBAAgB,QACjDI,CAAW,EAGhC,UAAWd,KAAa,OAAO,KAAKU,EAAE,QAAQ,EAAG,CAC7C,MAAMM,EAAON,EAAE,WAAWV,CAAS,EAC7BiB,EAAKP,EAAE,SAASV,CAAS,EAG/B,IAAIkB,EACAlB,IAAc,MACdkB,EAAQ,KAAK,SAASF,EAAMC,EAAIF,CAAK,EAErCG,EAAQF,GAAQC,EAAKD,GAAQD,EAGjC,KAAK,gBAAgBf,EAAWkB,CAAK,EACrC,KAAK,aAAalB,CAAS,EAAIkB,CACnC,CAGIR,EAAE,UACFA,EAAE,SAASI,CAAW,EAItBA,GAAe,GACfF,EAAU,KAAKzC,CAAE,CAEzB,CAGA,UAAWA,KAAMyC,EAAW,CACxB,MAAMF,EAAI,KAAK,kBAAkB,IAAIvC,CAAE,EACvC,KAAK,kBAAkB,OAAOA,CAAE,EAC5BuC,GAAK,CAACA,EAAE,WAAaA,EAAE,YACvBA,EAAE,WAAU,CAEpB,CAGI,KAAK,kBAAkB,KAAO,IAC9B,KAAK,SAAW,sBAAsB,IAAM,KAAK,MAAK,CAAE,EAEhE,CAYA,qBAAqBL,EAAK,CACtB,GAAIA,EAAI,cAAgBA,EAAI,MAAM,OAAQ,CAEtC,MAAMc,EAAM,KAAK,UAAU,QAAQd,CAAG,EAClCc,GAAO,GACP,KAAK,UAAU,OAAOA,EAAK,CAAC,EAE5Bd,EAAI,YACJA,EAAI,WAAU,EAElB,MACJ,CAEA,MAAMC,EAAOD,EAAI,MAAMA,EAAI,YAAY,EACjCe,EAAS,GAAGf,EAAI,EAAE,SAASA,EAAI,YAAY,GAE3CgB,EAAY,IAAM,CACpB,MAAMtB,EAAa,CAAA,EACnB,UAAWC,KAAa,OAAO,KAAKM,EAAK,MAAM,EAC3CP,EAAWC,CAAS,EAAI,KAAK,iBAAiBA,CAAS,EAG3D,MAAMC,EAAS,CACX,GAAImB,EACJ,WAAArB,EACA,SAAU,CAAE,GAAGO,EAAK,MAAM,EAC1B,UAAW,YAAY,IAAG,EAC1B,SAAU,KAAK,IAAI,EAAGA,EAAK,QAAQ,EACnC,OAAQ,KAAK,gBAAgBA,EAAK,MAAM,EAAIA,EAAK,OAAS,YAC1D,WAAY,IAAM,CACdD,EAAI,eACJ,KAAK,qBAAqBA,CAAG,CACjC,EACA,SAAU,KACV,UAAW,EAC3B,EAEY,KAAK,kBAAkB,IAAIe,EAAQnB,CAAM,EACzC,KAAK,iBAAgB,CACzB,EAEIK,EAAK,MAAQ,EACb,WAAWe,EAAWf,EAAK,KAAK,EAEhCe,EAAS,CAEjB,CAkBA,iBAAiBrB,EAAW,CAExB,GAAI,KAAK,aAAc,CACnB,MAAMsB,EAAM,KAAK,aAAatB,CAAS,EACvC,GAAI,OAAOsB,GAAQ,UAAY,OAAO,SAASA,CAAG,EAC9C,OAAOA,CAEf,CAGA,GAAItB,KAAa,KAAK,aAClB,OAAO,KAAK,aAAaA,CAAS,EAItC,SAAW,CAAA,CAAG,CAAC,IAAK,KAAK,kBACrB,GAAIA,KAAa,EAAE,SACf,OAAO,EAAE,SAASA,CAAS,EAKnC,OAAO,KAAK,iBAAiBA,CAAS,CAC1C,CASA,iBAAiBA,EAAW,CACxB,MAAMuB,EAAW,CACb,IAAK,IACL,WAAY,GACZ,UAAW,GACX,MAAO,EACP,MAAO,GACP,YAAa,EACb,YAAa,GACb,UAAW,IACX,SAAU,EACV,QAAS,EACT,QAAS,EACT,QAAS,EACT,QAAS,EACT,QAAS,EACT,QAAS,CACrB,EACQ,OAAOA,EAASvB,CAAS,IAAM,OAAYuB,EAASvB,CAAS,EAAI,CACrE,CAeA,SAASwB,EAAGC,EAAGf,EAAG,CACd,IAAIgB,EAAOD,EAAID,EACXE,EAAO,MAAKA,GAAQ,KACpBA,EAAO,OAAMA,GAAQ,KACzB,IAAIC,EAASH,EAAIE,EAAOhB,EACxB,OAAIiB,EAAS,IAAGA,GAAU,KACtBA,GAAU,MAAKA,GAAU,KACtBA,CACX,CAQA,uBAAwB,CACpB,MAAO,CAMH,OAAOjB,EAAG,CACN,OAAOA,CACX,EAOA,OAAOA,EAAG,CACN,OAAOA,EAAIA,EAAIA,CACnB,EAOA,QAAQA,EAAG,CACP,MAAO,GAAI,KAAK,IAAI,EAAIA,EAAG,CAAC,CAChC,EAOA,UAAUA,EAAG,CACT,OAAOA,EAAI,GACL,EAAIA,EAAIA,EAAIA,EACZ,EAAI,KAAK,IAAI,GAAKA,EAAI,EAAG,CAAC,EAAI,CACxC,EAOA,WAAWA,EAAG,CACV,OAAOA,EAAIA,CACf,EAOA,YAAYA,EAAG,CACX,MAAO,IAAK,EAAIA,IAAM,EAAIA,EAC9B,EAOA,OAAOA,EAAG,CAIN,OAAIA,EAAI,EAAI,KACD,OAAKA,EAAIA,EACTA,EAAI,EAAI,KACR,QAAMA,GAAK,IAAM,MAAMA,EAAI,IAC3BA,EAAI,IAAM,KACV,QAAMA,GAAK,KAAO,MAAMA,EAAI,MAE5B,QAAMA,GAAK,MAAQ,MAAMA,EAAI,OAE5C,EAOA,QAAQA,EAAG,CACP,GAAIA,IAAM,GAAKA,IAAM,EAAG,OAAOA,EAC/B,MAAMkB,EAAM,EAAI,KAAK,GAAM,EAC3B,OAAO,KAAK,IAAI,EAAG,IAAMlB,CAAC,EAAI,KAAK,KAAKA,EAAI,GAAK,KAAQkB,CAAE,EAAI,CACnE,EAOA,MAAMlB,EAAG,CACL,OAAOA,EAAI,GACL,EAAIA,EAAIA,EAAIA,EACZ,EAAI,KAAK,IAAI,GAAKA,EAAI,EAAG,CAAC,EAAI,CACxC,EAOA,QAAQA,EAAG,CAGP,MAAO,GAAI,QAAK,KAAK,IAAIA,EAAI,EAAG,CAAC,EAAI,QAAK,KAAK,IAAIA,EAAI,EAAG,CAAC,CAC/D,EAOA,OAAOA,EAAG,CAGN,MAAO,SAAKA,EAAIA,EAAIA,EAAI,QAAKA,EAAIA,CACrC,EAOA,QAAQA,EAAG,CACP,OAAOA,IAAM,EAAI,EAAI,EAAI,KAAK,IAAI,EAAG,IAAMA,CAAC,CAChD,EAOA,OAAOA,EAAG,CACN,OAAOA,IAAM,EAAI,EAAI,KAAK,IAAI,EAAG,GAAKA,EAAI,EAAE,CAChD,EAOA,UAAUA,EAAG,CACT,MAAO,EAAE,KAAK,IAAI,KAAK,GAAKA,CAAC,EAAI,GAAK,CAC1C,CACZ,CACI,CACJ,CC/pBO,MAAMmB,CAAU,CAKnB,YAAYC,EAAQC,EAAU,UAAW,CACrC,KAAK,OAASD,EACd,KAAK,GAAK,SAAS,KAAK,OAAM,EAAG,SAAS,EAAE,EAAE,OAAO,EAAG,CAAC,CAAC,GAC1D,KAAK,OAAS,GAGd,KAAK,QAAU,CACX,QAAS,EACT,QAAS,CACrB,EAGQ,KAAK,SAAW,IAAIvC,EAChB,CAAClB,EAAGC,IAAM,KAAK,OAAO,aAAaD,EAAGC,CAAC,EACtCD,GAAM,KAAK,OAAO,aAAaA,CAAC,CAC7C,EAGQ,KAAK,QAAU,OAAO0D,GAAY,SAAW,KAAK,YAAYA,CAAO,EAAIA,EAGzE,KAAK,MAAK,CACd,CAOA,OAAOC,EAAMzD,EAAI,CACb,GAAI,CAAC,KAAK,OAAQ,OAIlB,MAAM0D,EAAS,KAAK,IAAID,EAAO,CAAG,EAAI,GAKjB,KAAK,OAAO,aAAa,aAAa,EAEtD,KAAK,SAAS,eAEd,KAAK,OAAO,aAAa,cAAe,EAAMC,CAAM,CAE7D,CAQA,MAAMC,EAAaC,EAAY,EAAKxC,EAAW,IAAM,CACjD,MAAMyC,EAAU,KAAK,QAAQ,SAASF,CAAW,EACjD,GAAI,CAACE,EAAS,CACV,QAAQ,KAAK,+BAA+BF,CAAW,kBAAkB,KAAK,QAAQ,IAAI,GAAG,EAC7F,MACJ,CAEA,MAAMG,EAAe,CAAA,EACrB,SAAW,CAACC,EAAOC,CAAO,IAAK,OAAO,QAAQH,CAAO,EAIjDC,EAAaC,CAAK,EAAIC,EAItBF,EAAa,YAAWA,EAAa,WAAaF,GAClDE,EAAa,QAAOA,EAAa,OAASF,GAE9C,KAAK,SAAS,WAAWE,EAAc1C,EAAU,SAAS,EAG1D,KAAK,QAAQ,UAAYuC,CAC7B,CAKA,MAAMvC,EAAW,IAAM,CACnB,KAAK,SAAS,WAAW,KAAK,QAAQ,KAAMA,EAAU,WAAW,CACrE,CAMA,YAAYlB,EAAM,CACd,MAAM+D,EAAW,CACb,QAAS,CACL,KAAM,UACN,KAAM,CAAE,IAAK,IAAK,WAAY,GAAK,UAAW,GAAK,MAAO,EAAG,MAAO,EAAK,YAAa,EAAE,EACxF,SAAU,CACN,IAAK,CAAE,IAAK,GAAI,WAAY,EAAK,UAAW,GAAK,MAAO,EAAK,MAAO,EAAG,EACvE,MAAO,CAAE,IAAK,EAAG,WAAY,EAAK,UAAW,GAAK,MAAO,EAAK,MAAO,EAAG,EACxE,QAAS,CAAE,IAAK,IAAK,WAAY,GAAK,UAAW,GAAK,MAAO,GAAK,MAAO,CAAC,EAC1E,KAAM,CAAE,IAAK,IAAK,WAAY,GAAK,UAAW,GAAK,MAAO,IAAK,MAAO,GAAK,YAAa,EAAE,CAC9G,CACA,EACY,OAAQ,CACJ,KAAM,SACN,KAAM,CAAE,IAAK,IAAK,WAAY,GAAK,UAAW,GAAK,MAAO,GAAK,MAAO,EAAK,YAAa,EAAE,EAC1F,SAAU,CACN,IAAK,CAAE,IAAK,GAAI,WAAY,EAAK,UAAW,EAAK,MAAO,IAAK,YAAa,GAAG,EAC7E,MAAO,CAAE,IAAK,GAAI,WAAY,EAAK,UAAW,EAAK,MAAO,IAAK,MAAO,EAAG,EACzE,cAAe,CAAE,IAAK,IAAK,WAAY,GAAK,UAAW,GAAK,MAAO,IAAK,YAAa,EAAE,CAC3G,CACA,EACY,OAAQ,CACJ,KAAM,SACN,KAAM,CAAE,IAAK,IAAK,WAAY,EAAK,UAAW,GAAK,MAAO,GAAK,MAAO,EAAK,YAAa,EAAE,EAC1F,SAAU,CACN,MAAO,CAAE,IAAK,EAAG,WAAY,EAAG,UAAW,GAAK,MAAO,EAAK,MAAO,EAAK,QAAS,GAAG,EACpF,KAAM,CAAE,IAAK,IAAK,WAAY,GAAK,UAAW,GAAK,MAAO,GAAK,MAAO,EAAG,CAC7F,CACA,CACA,EACQ,OAAOA,EAAS/D,CAAI,GAAK+D,EAAS,OACtC,CACJ,CC/HO,MAAMC,CAAc,CACvB,YAAY1D,EAAc,iBAAkB,CACxC,KAAK,YAAcA,EACnB,KAAK,UAAa,OAAO,SAAa,IAChC,SAAS,eAAeA,CAAW,EACnC,KACN,KAAK,cAAgB,KACrB,KAAK,gBAAkB,CAAA,EACvB,KAAK,mBAAqB,IAAI,GAClC,CAMA,qBAAqB2D,EAAY,CAE7B,KAAK,uBAAsB,EAE3B,MAAMC,EAAY,KAAK,uBAAuBD,CAAU,EAExD,GAAI,KAAK,UAAW,CAChB,MAAME,EAAY,KAAK,UAAU,cAAgB,OAAO,OAAW,IAAc,OAAO,WAAa,KAC/FC,EAAa,KAAK,UAAU,eAAiB,OAAO,OAAW,IAAc,OAAO,YAAc,KAClGC,EAAO,OAAO,OAAW,IAAe,KAAK,IAAI,OAAO,kBAAoB,EAAG,CAAC,EAAI,EAE1FH,EAAU,QAAQ,CAACI,EAAU3D,IAAU,CACnC,MAAM4D,EAAS,SAAS,cAAc,QAAQ,EAC9CA,EAAO,GAAKD,EACZC,EAAO,UAAY,uBACnBA,EAAO,MAAM,SAAW,WACxBA,EAAO,MAAM,IAAM,IACnBA,EAAO,MAAM,KAAO,IACpBA,EAAO,MAAM,MAAQ,OACrBA,EAAO,MAAM,OAAS,OACtBA,EAAO,MAAM,OAAS,OAAO5D,EAAQ,CAAC,EACtC4D,EAAO,MAAQJ,EAAYE,EAC3BE,EAAO,OAASH,EAAaC,EAC7B,KAAK,UAAU,YAAYE,CAAM,EACjC,KAAK,gBAAgB,KAAKA,CAAM,CACpC,CAAC,CACL,CAEA,YAAK,cAAgBN,EACdC,CACX,CAKA,gBAAgBI,EAAUE,EAAI,CAC1B,KAAK,mBAAmB,IAAIF,EAAUE,CAAE,CAC5C,CAKA,SAAU,CAEN,SAAW,CAAA,CAAGA,CAAE,IAAK,KAAK,mBACtB,GAAI,CACA,MAAMC,EAAMD,EAAG,aAAa,oBAAoB,EAC5CC,GAAKA,EAAI,YAAW,CAC5B,MAAY,CAAoC,CAEpD,KAAK,mBAAmB,MAAK,EAE7B,KAAK,uBAAsB,EAC3B,KAAK,cAAgB,IACzB,CAIA,wBAAyB,CACrB,UAAWF,KAAU,KAAK,gBACtBA,EAAO,OAAM,EAEjB,KAAK,gBAAkB,CAAA,CAC3B,CAEA,uBAAuBN,EAAY,CAC/B,MAAMS,EAAU,CACZ,oBAAqB,gBAAiB,iBACtC,mBAAoB,eAChC,EAEQ,OAAQT,EAAU,CACd,IAAK,UACD,OAAOS,EACX,IAAK,UACD,OAAOA,EAAQ,IAAIhF,GAAM,WAAWA,CAAE,EAAE,EAC5C,IAAK,cACD,OAAOgF,EAAQ,IAAIhF,GAAM,QAAQA,CAAE,EAAE,EACzC,IAAK,YACD,OAAOgF,EAAQ,IAAIhF,GAAM,aAAaA,CAAE,EAAE,EAC9C,QACI,OAAOgF,CACvB,CACI,CACJ,CC/FO,MAAMC,EAAwB,CACjC,UAAW,UAAW,UACtB,UAAW,UAAW,UACtB,cAAe,cAAe,QAAS,QACvC,MAAO,YAAa,aAAc,YAClC,UACJ,EAKaC,EAAc,CAAC,OAAQ,MAAO,MAAM,EAKpCC,EAAc,CAAC,MAAO,WAAY,UAAW,MAAO,KAAK,EAKzDC,EAAoB,CAC7B,MAAO,CAAC,WAAY,WAAY,UAAW,UAAW,QAAS,MAAM,EACrE,MAAO,CAAC,QAAS,QAAS,SAAU,QAAS,MAAM,EACnD,OAAQ,CAAC,QAAS,OAAQ,QAAS,OAAQ,QAAS,MAAM,CAC9D,EAKaC,EAA4B,CACrC,QAAS,MAET,MAAO,CACH,QAAS,GACT,kBAAmB,EACnB,UAAW,GACX,MAAO,CACH,KAAM,CACF,QAAS,GACT,YAAa,IACb,eAAgB,CAAC,GAAI,GAAG,EACxB,QAAS,CACL,CAAE,MAAO,cAAe,OAAQ,GAAK,KAAM,KAAK,EAChD,CAAE,MAAO,YAAa,OAAQ,GAAK,KAAM,UAAU,CACvE,CACA,EACY,IAAK,CACD,QAAS,GACT,YAAa,EACb,eAAgB,CAAC,IAAK,GAAI,EAC1B,QAAS,CACL,CAAE,MAAO,QAAS,OAAQ,GAAK,KAAM,KAAK,CAC9D,CACA,EACY,KAAM,CACF,QAAS,GACT,YAAa,GACb,eAAgB,CAAC,IAAM,GAAK,EAC5B,QAAS,CACL,CAAE,MAAO,QAAS,OAAQ,GAAK,KAAM,KAAK,EAC1C,CAAE,MAAO,MAAO,OAAQ,GAAI,KAAM,KAAK,CAC3D,CACA,CACA,CACA,EAEI,KAAM,CACF,QAAS,GACT,YAAa,EACb,UAAW,GACX,aAAc,GACd,WAAY,GACZ,kBAAmB,CAAE,MAAO,EAAG,KAAM,EAAG,MAAO,CAAC,EAChD,SAAU,CAEN,MAAO,CAAE,OAAQ,UAAW,MAAO,KAAO,MAAO,CAAC,MAAO,IAAI,CAAC,EAC9D,KAAM,CAAE,OAAQ,UAAW,MAAO,IAAM,MAAO,CAAC,KAAM,GAAG,CAAC,EAC1D,MAAO,CAAE,OAAQ,UAAW,MAAO,KAAO,MAAO,CAAC,KAAM,GAAG,CAAC,CACxE,EACQ,iBAAkB,CAEd,MAAO,CAAE,OAAQ,UAAW,MAAO,KAAO,MAAO,CAAC,MAAO,IAAI,CAAC,EAC9D,KAAM,CAAE,OAAQ,UAAW,MAAO,IAAM,MAAO,CAAC,GAAM,CAAG,CAAC,EAC1D,MAAO,CAAE,OAAQ,UAAW,MAAO,IAAM,MAAO,CAAC,GAAM,CAAG,CAAC,CACvE,CACA,EAEI,YAAa,CACT,QAAS,GAET,MAAO,CACH,QAAS,GACT,KAAM,WACN,YAAa,EACb,UAAW,IACX,QAAS,CAAC,UAAW,SAAS,EAC9B,QAAS,GACT,QAAS,EACrB,EAEQ,MAAO,CACH,QAAS,GACT,KAAM,QACN,UAAW,EACX,MAAO,IACP,OAAQ,cACR,SAAU,CACtB,EAEQ,OAAQ,CACJ,QAAS,GACT,KAAM,QACN,YAAa,EACb,OAAQ,WACR,KAAM,GACN,KAAM,CAClB,EAEQ,MAAO,CACH,QAAS,GACT,kBAAmB,GACnB,UAAW,CAAE,QAAS,GAAM,OAAQ,YAAa,YAAa,GAAI,EAClE,gBAAiB,CAAE,QAAS,GAAM,OAAQ,UAAW,YAAa,GAAI,EACtE,cAAe,EAC3B,CACA,CACA,EAMO,MAAMC,CAAiB,CAC1B,YAAYvF,EAAS,KAAM,CACvB,KAAK,OAAS,KAAK,UAAUsF,CAAyB,EAElDtF,GACA,KAAK,MAAMA,CAAM,CAEzB,CAKA,UAAUwF,EAAK,CACX,OAAO,KAAK,MAAM,KAAK,UAAUA,CAAG,CAAC,CACzC,CAKA,MAAMC,EAAe,CACjB,YAAK,UAAU,KAAK,OAAQA,CAAa,EAClC,IACX,CAKA,UAAUC,EAAQC,EAAQ,CACtB,UAAWC,KAAOD,EACVA,EAAOC,CAAG,GAAK,OAAOD,EAAOC,CAAG,GAAM,UAAY,CAAC,MAAM,QAAQD,EAAOC,CAAG,CAAC,GACvEF,EAAOE,CAAG,IAAGF,EAAOE,CAAG,EAAI,CAAA,GAChC,KAAK,UAAUF,EAAOE,CAAG,EAAGD,EAAOC,CAAG,CAAC,GAEvCF,EAAOE,CAAG,EAAID,EAAOC,CAAG,CAGpC,CAMA,UAAW,CACP,MAAMC,EAAS,CAAA,EAGf,GAAI,KAAK,OAAO,MAAO,CACnB,MAAMC,EAAQ,KAAK,OAAO,OAEtB,OAAOA,EAAM,mBAAsB,UACnCA,EAAM,kBAAoB,GAAKA,EAAM,kBAAoB,KACzDD,EAAO,KAAK,2DAA2D,EAG3E,UAAWE,KAAQZ,EACf,GAAIW,EAAM,OAASA,EAAM,MAAMC,CAAI,EAAG,CAClC,MAAMC,EAAaF,EAAM,MAAMC,CAAI,EAEnC,GAAIC,EAAW,QACX,UAAWN,KAAUM,EAAW,QACvBd,EAAsB,SAASQ,EAAO,KAAK,GAC5CG,EAAO,KAAK,eAAeE,CAAI,gCAAgCL,EAAO,KAAK,GAAG,EAE7EN,EAAY,SAASM,EAAO,IAAI,GACjCG,EAAO,KAAK,eAAeE,CAAI,2BAA2BL,EAAO,IAAI,GAAG,CAIxF,CAER,CAGA,GAAI,KAAK,OAAO,KAAM,CAClB,MAAMO,EAAO,KAAK,OAAO,KAOzB,IALI,OAAOA,EAAK,aAAgB,UAC5BA,EAAK,YAAc,IAAOA,EAAK,YAAc,KAC7CJ,EAAO,KAAK,sDAAsD,EAGlEI,EAAK,SACL,UAAWC,IAAQ,CAAC,QAAS,OAAQ,OAAO,EACpCD,EAAK,SAASC,CAAI,GAAKD,EAAK,SAASC,CAAI,EAAE,SACtChB,EAAsB,SAASe,EAAK,SAASC,CAAI,EAAE,MAAM,GAC1DL,EAAO,KAAK,iBAAiBK,CAAI,4BAA4B,EAKjF,CAGA,GAAI,KAAK,OAAO,YAAa,CACzB,MAAMC,EAAc,KAAK,OAAO,YAE5BA,EAAY,OAASA,EAAY,MAAM,OAClCd,EAAkB,MAAM,SAASc,EAAY,MAAM,IAAI,GACxDN,EAAO,KAAK,yCAAyCM,EAAY,MAAM,IAAI,GAAG,GAIlFA,EAAY,OAASA,EAAY,MAAM,OAClCd,EAAkB,MAAM,SAASc,EAAY,MAAM,IAAI,GACxDN,EAAO,KAAK,yCAAyCM,EAAY,MAAM,IAAI,GAAG,GAIlFA,EAAY,QAAUA,EAAY,OAAO,OACpCd,EAAkB,OAAO,SAASc,EAAY,OAAO,IAAI,GAC1DN,EAAO,KAAK,0CAA0CM,EAAY,OAAO,IAAI,GAAG,EAG5F,CAEA,MAAO,CACH,MAAON,EAAO,SAAW,EACzB,OAAAA,CACZ,CACI,CAOA,WAAY,CACR,OAAO,KAAK,UAAU,KAAK,MAAM,CACrC,CAKA,gBAAiB,CACb,OAAO,KAAK,UAAU,KAAK,OAAO,KAAK,CAC3C,CAKA,eAAgB,CACZ,OAAO,KAAK,UAAU,KAAK,OAAO,IAAI,CAC1C,CAKA,sBAAuB,CACnB,OAAO,KAAK,UAAU,KAAK,OAAO,WAAW,CACjD,CAOA,gBAAgBO,EAAS,CACrB,YAAK,OAAO,MAAM,QAAU,CAAC,CAACA,EACvB,IACX,CAKA,aAAaL,EAAM/F,EAAQ,CACvB,GAAI,CAACmF,EAAY,SAASY,CAAI,EAC1B,MAAM,IAAI,MAAM,uBAAuBA,CAAI,EAAE,EAEjD,YAAK,UAAU,KAAK,OAAO,MAAM,MAAMA,CAAI,EAAG/F,CAAM,EAC7C,IACX,CAKA,eAAe+F,EAAM3B,EAAOiC,EAAS,EAAKC,EAAO,MAAO,CACpD,GAAI,CAACnB,EAAY,SAASY,CAAI,EAC1B,MAAM,IAAI,MAAM,uBAAuBA,CAAI,EAAE,EAEjD,GAAI,CAACb,EAAsB,SAASd,CAAK,EACrC,MAAM,IAAI,MAAM,sBAAsBA,CAAK,EAAE,EAEjD,GAAI,CAACgB,EAAY,SAASkB,CAAI,EAC1B,MAAM,IAAI,MAAM,uBAAuBA,CAAI,EAAE,EAGjD,YAAK,OAAO,MAAM,MAAMP,CAAI,EAAE,QAAQ,KAAK,CAAE,MAAA3B,EAAO,OAAAiC,EAAQ,KAAAC,CAAI,CAAE,EAC3D,IACX,CAKA,kBAAkBP,EAAM,CACpB,GAAI,CAACZ,EAAY,SAASY,CAAI,EAC1B,MAAM,IAAI,MAAM,uBAAuBA,CAAI,EAAE,EAEjD,YAAK,OAAO,MAAM,MAAMA,CAAI,EAAE,QAAU,CAAA,EACjC,IACX,CAKA,eAAeK,EAAS,CACpB,YAAK,OAAO,KAAK,QAAU,CAAC,CAACA,EACtB,IACX,CAKA,oBAAoBA,EAAS,CACzB,YAAK,OAAO,KAAK,aAAe,CAAC,CAACA,EAC3B,IACX,CAKA,mBAAmBG,EAAa,CAC5B,YAAK,OAAO,KAAK,YAAc,KAAK,IAAI,GAAK,KAAK,IAAI,GAAIA,CAAW,CAAC,EAC/D,IACX,CAKA,eAAeL,EAAMR,EAAQc,EAAOC,EAAQ,KAAM,CAC9C,GAAI,CAAC,CAAC,QAAS,OAAQ,OAAO,EAAE,SAASP,CAAI,EACzC,MAAM,IAAI,MAAM,iBAAiBA,CAAI,EAAE,EAE3C,GAAI,CAAChB,EAAsB,SAASQ,CAAM,EACtC,MAAM,IAAI,MAAM,sBAAsBA,CAAM,EAAE,EAGlD,YAAK,OAAO,KAAK,SAASQ,CAAI,EAAI,CAC9B,OAAAR,EACA,MAAAc,EACA,MAAOC,GAAS,CAAC,MAAO,IAAI,CACxC,EACe,IACX,CAKA,sBAAsBL,EAAS,CAC3B,YAAK,OAAO,YAAY,QAAU,CAAC,CAACA,EAC7B,IACX,CAKA,aAAaE,EAAMtF,EAAU,GAAI,CAC7B,GAAI,CAACqE,EAAkB,MAAM,SAASiB,CAAI,EACtC,MAAM,IAAI,MAAM,uBAAuBA,CAAI,EAAE,EAEjD,YAAK,OAAO,YAAY,MAAM,KAAOA,EACrC,KAAK,UAAU,KAAK,OAAO,YAAY,MAAOtF,CAAO,EAC9C,IACX,CAKA,aAAasF,EAAMtF,EAAU,GAAI,CAC7B,GAAI,CAACqE,EAAkB,MAAM,SAASiB,CAAI,EACtC,MAAM,IAAI,MAAM,uBAAuBA,CAAI,EAAE,EAEjD,YAAK,OAAO,YAAY,MAAM,KAAOA,EACrC,KAAK,UAAU,KAAK,OAAO,YAAY,MAAOtF,CAAO,EAC9C,IACX,CAKA,cAAcsF,EAAMtF,EAAU,GAAI,CAC9B,GAAI,CAACqE,EAAkB,OAAO,SAASiB,CAAI,EACvC,MAAM,IAAI,MAAM,wBAAwBA,CAAI,EAAE,EAElD,YAAK,OAAO,YAAY,OAAO,KAAOA,EACtC,KAAK,UAAU,KAAK,OAAO,YAAY,OAAQtF,CAAO,EAC/C,IACX,CAOA,QAAS,CACL,OAAO,KAAK,UAAU,KAAK,OAAQ,KAAM,CAAC,CAC9C,CAKA,OAAO,SAAS0F,EAAM,CAClB,MAAMC,EAAS,OAAOD,GAAS,SAAW,KAAK,MAAMA,CAAI,EAAIA,EAC7D,OAAO,IAAInB,EAAiBoB,CAAM,CACtC,CAKA,eAAgB,CACZ,MAAMC,EAAU,CAAA,EACVvD,EAAWiC,EAGjB,YAAK,mBAAmB,KAAK,OAAQjC,EAAUuD,CAAO,EAE/C,KAAK,UAAUA,EAAS,KAAM,CAAC,CAC1C,CAKA,mBAAmBC,EAASxD,EAAUI,EAAQ,CAC1C,UAAWmC,KAAOiB,EACd,GAAI,OAAOA,EAAQjB,CAAG,GAAM,UAAY,CAAC,MAAM,QAAQiB,EAAQjB,CAAG,CAAC,EAAG,CAClE,MAAMkB,EAAY,CAAA,EAClB,KAAK,mBAAmBD,EAAQjB,CAAG,EAAGvC,EAASuC,CAAG,GAAK,CAAA,EAAIkB,CAAS,EAChE,OAAO,KAAKA,CAAS,EAAE,OAAS,IAChCrD,EAAOmC,CAAG,EAAIkB,EAEtB,MAAW,KAAK,UAAUD,EAAQjB,CAAG,CAAC,IAAM,KAAK,UAAUvC,EAASuC,CAAG,CAAC,IACpEnC,EAAOmC,CAAG,EAAIiB,EAAQjB,CAAG,EAGrC,CAKA,OAAQ,CACJ,OAAO,IAAIL,EAAiB,KAAK,MAAM,CAC3C,CAKA,OAAQ,CACJ,YAAK,OAAS,KAAK,UAAUD,CAAyB,EAC/C,IACX,CACJ,CC/dO,MAAMyB,CAAkB,CAC3B,YAAYzF,EAAoB,KAAM,CAElC,KAAK,gBAAkBA,GAAqB,OAAO,iBAAmB,KAAK,uBAAuB,KAAK,IAAI,EAG3G,KAAK,OAAS,IAAIiE,EAGlB,KAAK,WAAa,CACd,MAAO,CAAE,KAAM,EAAG,IAAK,EAAG,KAAM,EAAG,OAAQ,CAAC,EAC5C,KAAM,CAAE,MAAO,EAAG,KAAM,EAAG,MAAO,CAAC,EACnC,MAAO,CAAE,EAAG,GAAK,EAAG,GAAK,UAAW,EAAG,UAAW,CAAC,EACnD,MAAO,CAAE,UAAW,EAAG,SAAU,CAAC,EAClC,OAAQ,CAAE,MAAO,EAAG,YAAa,CAAC,EAClC,MAAO,CAAE,QAAS,CAAA,EAAI,WAAY,EAAG,SAAU,CAAC,CAC5D,EAGQ,KAAK,eAAiB,CAAA,EAGtB,KAAK,iBAAmB,CAAA,EAGxB,KAAK,SAAW,GAChB,KAAK,QAAU,KAGf,KAAK,UAAY,IAAI,IAErB,QAAQ,IAAI,oCAAoC,CACpD,CAKA,uBAAuBhF,EAAMyC,EAAO,CAChC,QAAQ,IAAI,sCAAsCzC,CAAI,KAAKyC,CAAK,GAAG,EAEnE,KAAK,eAAezC,CAAI,EAAIyC,CAChC,CAKA,2BAA2BgE,EAAI,CAC3B,KAAK,gBAAkBA,CAC3B,CAKA,WAAWhH,EAAQ,CACXA,aAAkBuF,EAClB,KAAK,OAASvF,EAEd,KAAK,OAAS,IAAIuF,EAAiBvF,CAAM,EAG7C,MAAMiH,EAAa,KAAK,OAAO,SAAQ,EACvC,OAAKA,EAAW,OACZ,QAAQ,KAAK,+CAAgDA,EAAW,MAAM,EAGlF,KAAK,KAAK,gBAAiB,KAAK,OAAO,UAAS,CAAE,EAClD,QAAQ,IAAI,sCAAsC,EAC3CA,CACX,CAKA,WAAY,CACR,OAAO,KAAK,OAAO,UAAS,CAChC,CAKA,OAAQ,CACA,KAAK,WAET,KAAK,SAAW,GAChB,KAAK,aAAY,EACjB,QAAQ,IAAI,gCAAgC,EAC5C,KAAK,KAAK,SAAS,EACvB,CAKA,MAAO,CACH,KAAK,SAAW,GACZ,KAAK,UACL,qBAAqB,KAAK,OAAO,EACjC,KAAK,QAAU,MAEnB,QAAQ,IAAI,gCAAgC,EAC5C,KAAK,KAAK,SAAS,CACvB,CAKA,cAAe,CACN,KAAK,WAGV,KAAK,wBAAuB,EAG5B,KAAK,YAAW,EAGhB,KAAK,QAAU,sBAAsB,IAAM,KAAK,aAAY,CAAE,EAClE,CAKA,yBAA0B,CAEtB,KAAK,iBAAmB,CAAA,EAExB,MAAMC,EAAM,KAAK,OAAO,UAAS,EAG7BA,EAAI,MAAM,SACV,KAAK,uBAAuBA,EAAI,KAAK,EAIrCA,EAAI,KAAK,SACT,KAAK,sBAAsBA,EAAI,IAAI,EAInCA,EAAI,YAAY,SAChB,KAAK,6BAA6BA,EAAI,WAAW,CAEzD,CAKA,uBAAuBC,EAAa,CAChC,MAAMrB,EAAQ,KAAK,WAAW,MACxBsB,EAAaD,EAAY,kBAE/B,SAAW,CAACE,EAAUrB,CAAU,IAAK,OAAO,QAAQmB,EAAY,KAAK,EAAG,CACpE,GAAI,CAACnB,EAAW,QAAS,SAGzB,MAAMsB,GADYxB,EAAMuB,CAAQ,GAAK,GACLrB,EAAW,YAAcoB,EAEzD,UAAW1B,KAAUM,EAAW,QAC5B,KAAK,SAASN,EAAO,MAAO4B,EAAc5B,EAAO,OAAQA,EAAO,IAAI,CAE5E,CACJ,CAKA,sBAAsB6B,EAAY,CAC9B,MAAMtB,EAAO,KAAK,WAAW,KACvBuB,EAAWD,EAAW,aAAeA,EAAW,iBAAmBA,EAAW,SAC9EE,EAAOF,EAAW,YAExB,SAAW,CAACrB,EAAMhC,CAAO,IAAK,OAAO,QAAQsD,CAAQ,EAAG,CACpD,GAAI,CAACtD,GAAW,CAACA,EAAQ,OAAQ,SAGjC,IAAIwD,EAAYzB,EAAKC,CAAI,GAAK,EAC1BqB,EAAW,YAAcA,EAAW,oBACpCG,GAAaH,EAAW,kBAAkBrB,CAAI,GAAK,GAIvD,IAAIyB,EAAQD,EAAYxD,EAAQ,MAAQuD,EACpCvD,EAAQ,QACRyD,EAAQ,KAAK,IAAIzD,EAAQ,MAAM,CAAC,EAAG,KAAK,IAAIA,EAAQ,MAAM,CAAC,EAAGyD,CAAK,CAAC,GAGxE,KAAK,SAASzD,EAAQ,OAAQyD,EAAO,SAAS,CAClD,CACJ,CAKA,6BAA6BC,EAAmB,CAExCA,EAAkB,MAAM,SACxB,KAAK,uBAAuBA,EAAkB,KAAK,EAInDA,EAAkB,MAAM,SACxB,KAAK,uBAAuBA,EAAkB,KAAK,EAInDA,EAAkB,OAAO,SACzB,KAAK,wBAAwBA,EAAkB,MAAM,EAIrDA,EAAkB,MAAM,SACxB,KAAK,uBAAuBA,EAAkB,KAAK,CAE3D,CAKA,uBAAuBC,EAAa,CAChC,MAAMC,EAAQ,KAAK,WAAW,MACxBL,EAAOI,EAAY,YACnBvB,EAAOuB,EAAY,KAEzB,GAAIvB,IAAS,OAAQ,OAErB,MAAMyB,EAAUF,EAAY,SAAW,CAAC,UAAW,SAAS,EACtDG,EAAIH,EAAY,QAAW,EAAIC,EAAM,EAAKA,EAAM,EAChDG,EAAIJ,EAAY,QAAW,EAAIC,EAAM,EAAKA,EAAM,EAEtD,OAAQxB,EAAI,CACR,IAAK,WAEGyB,EAAQ,CAAC,GAAG,KAAK,SAASA,EAAQ,CAAC,GAAIC,EAAI,IAAO,EAAIP,EAAM,SAAS,EACrEM,EAAQ,CAAC,GAAG,KAAK,SAASA,EAAQ,CAAC,GAAIE,EAAI,IAAO,EAAIR,EAAM,SAAS,EACzE,MAEJ,IAAK,WAEGM,EAAQ,CAAC,GAAG,KAAK,SAASA,EAAQ,CAAC,EAAGD,EAAM,UAAYL,EAAO,GAAK,KAAK,EACzEM,EAAQ,CAAC,GAAG,KAAK,SAASA,EAAQ,CAAC,EAAGD,EAAM,UAAYL,EAAO,GAAK,KAAK,EAC7E,MAEJ,IAAK,UAED,MAAMS,EAAW,KAAK,KAAKJ,EAAM,WAAa,EAAIA,EAAM,WAAa,CAAC,EACtE,KAAK,SAAS,QAASI,EAAWT,EAAO,IAAM,KAAK,EACpD,MAEJ,IAAK,UAED,KAAK,SAAS,eAAgB,EAAI,KAAK,IAAIO,EAAI,EAAG,EAAI,GAAKP,EAAM,UAAU,EAC3E,MAEJ,IAAK,QAED,KAAK,SAAS,cAAe,KAAK,IAAIO,EAAI,EAAG,EAAI,EAAIP,EAAM,UAAU,EACrE,KAChB,CACI,CAKA,uBAAuBU,EAAa,CAChC,MAAMC,EAAQ,KAAK,WAAW,MAK9B,GAFAA,EAAM,WAAaD,EAAY,MAE3BC,EAAM,UAAY,KAAO,CACzBA,EAAM,UAAY,EAClB,MACJ,CAEA,MAAM9B,EAAO6B,EAAY,KACnBzC,EAASyC,EAAY,OACrBlE,EAAYmE,EAAM,UAAYD,EAAY,UAEhD,OAAQ7B,EAAI,CACR,IAAK,QACD,KAAK,SAASZ,EAAQzB,EAAW,KAAK,EACtC,MAEJ,IAAK,QACD,KAAK,SAASyB,EAAQzB,EAAY,EAAG,KAAK,EAC1C,KAAK,SAAS,QAASA,EAAY,GAAK,KAAK,EAC7C,MAEJ,IAAK,SACD,KAAK,SAASyB,EAAQ,KAAK,IAAI,KAAK,MAAQ,GAAI,EAAIzB,EAAW,KAAK,EACpE,MAEJ,IAAK,QACD,KAAK,SAAS,YAAaA,EAAY,GAAK,KAAK,EACjD,KAAK,SAAS,QAASA,EAAW,KAAK,EACvC,KAChB,CACI,CAKA,wBAAwBoE,EAAc,CAClC,MAAMC,EAAS,KAAK,WAAW,OAE/B,GAAI,KAAK,IAAIA,EAAO,KAAK,EAAI,KAAO,OAEpC,MAAMhC,EAAO+B,EAAa,KACpB3C,EAAS2C,EAAa,OACtBZ,EAAOY,EAAa,YAE1B,OAAQ/B,EAAI,CACR,IAAK,QAGD,GADAgC,EAAO,aAAeA,EAAO,MAAQb,EAAOY,EAAa,KACrD,KAAK,IAAIC,EAAO,WAAW,GAAK,EAAG,CACnC,MAAMrG,EAAQ,KAAK,MAAM,KAAK,IAAIqG,EAAO,WAAW,CAAC,EAC/CC,EAAYD,EAAO,YAAc,EAAI,EAAI,GAC/C,KAAK,SAAS5C,EAAQzD,EAAQsG,EAAW,KAAK,EAC9CD,EAAO,aAAerG,EAAQsG,CAClC,CACA,MAEJ,IAAK,OACD,KAAK,SAAS7C,EAAQ4C,EAAO,MAAQb,EAAO,GAAK,KAAK,EACtD,MAEJ,IAAK,QACD,KAAK,SAAS,MAAOa,EAAO,MAAQb,EAAO,GAAI,KAAK,EACpD,MAEJ,IAAK,OACD,KAAK,SAAS,YAAaa,EAAO,MAAQb,EAAO,IAAM,KAAK,EAC5D,MAEJ,IAAK,QACD,KAAK,SAAS,cAAea,EAAO,MAAQb,EAAO,GAAK,KAAK,EAC7D,KAChB,CAGQa,EAAO,OAAS,EACpB,CAKA,uBAAuBE,EAAa,CAChC,MAAMC,EAAQ,KAAK,WAAW,MAE9B,GAAID,EAAY,UAAU,SAAWC,EAAM,aAAe,EAAG,CACzD,MAAMd,GAASc,EAAM,WAAa,GAAKD,EAAY,UAAU,YAC7D,KAAK,SAASA,EAAY,UAAU,OAAQb,EAAO,KAAK,EACxDc,EAAM,WAAa,GAAKA,EAAM,WAAa,GAAK,EACpD,CAEA,GAAID,EAAY,gBAAgB,SAAWC,EAAM,WAAa,EAAG,CAC7D,MAAMd,EAAQc,EAAM,SAAWD,EAAY,gBAAgB,YAC3D,KAAK,SAASA,EAAY,gBAAgB,OAAQb,EAAO,KAAK,EAC9Dc,EAAM,UAAY,EACtB,CACJ,CAKA,SAASrE,EAAOpB,EAAOsD,EAAO,MAAO,CACjC,GAAI,CAACpB,EAAsB,SAASd,CAAK,EAAG,CACxC,QAAQ,KAAK,yCAAyCA,CAAK,GAAG,EAC9D,MACJ,CAEK,KAAK,iBAAiBA,CAAK,IAC5B,KAAK,iBAAiBA,CAAK,EAAI,CAAE,MAAO,EAAG,KAAM,KAAK,GAG1D,MAAMuD,EAAQ,KAAK,iBAAiBvD,CAAK,EAEzC,OAAQkC,EAAI,CACR,IAAK,MACDqB,EAAM,OAAS3E,EACf2E,EAAM,KAAO,MACb,MAEJ,IAAK,WACDA,EAAM,OAASA,EAAM,OAAS,GAAK3E,EACnC2E,EAAM,KAAO,WACb,MAEJ,IAAK,UACDA,EAAM,MAAQ3E,EACd2E,EAAM,KAAO,UACb,MAEJ,IAAK,MACDA,EAAM,MAAQ,KAAK,IAAIA,EAAM,MAAO3E,CAAK,EACzC2E,EAAM,KAAO,MACb,MAEJ,IAAK,MACDA,EAAM,MAAQ,KAAK,IAAIA,EAAM,MAAO3E,CAAK,EACzC2E,EAAM,KAAO,MACb,KAChB,CACI,CAKA,aAAc,CACV,SAAW,CAACvD,EAAOuD,CAAK,IAAK,OAAO,QAAQ,KAAK,gBAAgB,EAAG,CAChE,GAAI,KAAK,IAAIA,EAAM,KAAK,EAAI,MAAUA,EAAM,OAAS,UAAW,SAEhE,MAAMe,EAAY,KAAK,eAAetE,CAAK,GAAK,EAChD,IAAIuE,EAEJ,OAAQhB,EAAM,KAAI,CACd,IAAK,MACDgB,EAAWD,EAAYf,EAAM,MAC7B,MACJ,IAAK,WACDgB,EAAWD,EAAYf,EAAM,MAC7B,MACJ,IAAK,UACDgB,EAAWhB,EAAM,MACjB,MACJ,IAAK,MACDgB,EAAW,KAAK,IAAID,EAAWf,EAAM,KAAK,EAC1C,MACJ,IAAK,MACDgB,EAAW,KAAK,IAAID,EAAWf,EAAM,KAAK,EAC1C,MACJ,QACIgB,EAAWD,EAAYf,EAAM,KACjD,CAGiB,OAAO,SAASgB,CAAQ,GAG7B,KAAK,gBAAgBvE,EAAOuE,CAAQ,CACxC,CACJ,CAOA,cAAcC,EAAMC,EAAKC,EAAMC,EAAS,KAAM,CAC1C,KAAK,WAAW,MAAM,KAAO,OAAO,SAASH,CAAI,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,CAAI,CAAC,EAAI,EACtF,KAAK,WAAW,MAAM,IAAM,OAAO,SAASC,CAAG,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,CAAG,CAAC,EAAI,EACnF,KAAK,WAAW,MAAM,KAAO,OAAO,SAASC,CAAI,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,CAAI,CAAC,EAAI,EACtF,KAAK,WAAW,MAAM,OAAUC,IAAW,MAAQ,OAAO,SAASA,CAAM,EACnEA,GACC,KAAK,WAAW,MAAM,KAAO,KAAK,WAAW,MAAM,IAAM,KAAK,WAAW,MAAM,MAAQ,CAClG,CAKA,aAAaC,EAAOC,EAAMC,EAAO,CAC7B,KAAK,WAAW,KAAK,MAAQF,EAC7B,KAAK,WAAW,KAAK,KAAOC,EAC5B,KAAK,WAAW,KAAK,MAAQC,CACjC,CAKA,cAAclB,EAAGC,EAAGkB,EAAY,EAAGC,EAAY,EAAG,CAC9C,KAAK,WAAW,MAAM,EAAI,OAAO,SAASpB,CAAC,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,CAAC,CAAC,EAAI,GAC7E,KAAK,WAAW,MAAM,EAAI,OAAO,SAASC,CAAC,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,CAAC,CAAC,EAAI,GAC7E,KAAK,WAAW,MAAM,UAAY,OAAO,SAASkB,CAAS,EAAIA,EAAY,EAC3E,KAAK,WAAW,MAAM,UAAY,OAAO,SAASC,CAAS,EAAIA,EAAY,CAC/E,CAKA,aAAanF,EAAY,EAAK,CAC1B,KAAK,WAAW,MAAM,UAAY,OAAO,SAASA,CAAS,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,CAAS,CAAC,EAAI,EACrG,KAAK,WAAW,MAAM,SAAW,KAAK,IAAG,CAC7C,CAKA,eAAe0D,EAAO,CACd,OAAO,SAASA,CAAK,IACrB,KAAK,WAAW,OAAO,OAASA,EAExC,CAKA,cAAc0B,EAASC,EAAa,EAAGC,EAAW,EAAG,CACjD,KAAK,WAAW,MAAM,QAAUF,EAChC,KAAK,WAAW,MAAM,WAAaC,EACnC,KAAK,WAAW,MAAM,SAAWC,CACrC,CAKA,iBAAiBnF,EAAOpB,EAAO,CAC3B,KAAK,eAAeoB,CAAK,EAAIpB,CACjC,CAKA,kBAAkBxB,EAAQ,CACtB,KAAK,eAAiB,CAAE,GAAG,KAAK,eAAgB,GAAGA,CAAM,CAC7D,CAOA,GAAGf,EAAOC,EAAU,CACX,KAAK,UAAU,IAAID,CAAK,GACzB,KAAK,UAAU,IAAIA,EAAO,CAAA,CAAE,EAEhC,KAAK,UAAU,IAAIA,CAAK,EAAE,KAAKC,CAAQ,CAC3C,CAKA,IAAID,EAAOC,EAAU,CACjB,GAAI,KAAK,UAAU,IAAID,CAAK,EAAG,CAC3B,MAAM+I,EAAY,KAAK,UAAU,IAAI/I,CAAK,EACpCS,EAAQsI,EAAU,QAAQ9I,CAAQ,EACpCQ,EAAQ,IACRsI,EAAU,OAAOtI,EAAO,CAAC,CAEjC,CACJ,CAKA,KAAKT,EAAOgJ,EAAM,CACd,GAAI,KAAK,UAAU,IAAIhJ,CAAK,EACxB,UAAWC,KAAY,KAAK,UAAU,IAAID,CAAK,EAC3C,GAAI,CACAC,EAAS+I,CAAI,CACjB,OAAS9I,EAAG,CACR,QAAQ,MAAM,yCAA0CA,CAAC,CAC7D,CAGZ,CAOA,SAAU,CACN,KAAK,KAAI,EACT,KAAK,UAAU,MAAK,EACpB,QAAQ,IAAI,kCAAkC,CAClD,CACJ,CC7iBO,MAAM+I,EAAe,OAAO,OAAO,CACtC,YAAa,aACb,eAAgB,gBAChB,UAAW,YACX,QAAS,UACT,YAAa,cACb,aAAc,eACd,MAAO,QACP,KAAM,MACV,CAAC,EASYC,EAAe,OAAO,OAAO,CACtC,QAAS,MAAO,OAChB,IAAK,IAAK,IACV,YAAa,UACjB,CAAC,EAMKC,EAAsB,EAMtBC,EAAc,GAMdC,EAAe,IAarB,SAASrD,EAAMrG,EAAG2J,EAAIC,EAAI,CACtB,OAAO5J,EAAI2J,EAAKA,EAAK3J,EAAI4J,EAAKA,EAAK5J,CACvC,CASA,SAAS6J,EAAK3G,EAAGC,EAAG,EAAG,CACnB,OAAOD,GAAKC,EAAID,GAAK,CACzB,CAMA,SAAS4G,GAAqB,CAC1B,MAAO,CACH,MAAO,EACP,IAAK,EACL,KAAM,EACN,EAAG,EACH,EAAG,EACH,EAAG,EACH,UAAW,EACX,SAAU,CAClB,CACA,CA2EO,MAAMC,CAAmB,CAU5B,YAAYnJ,EAAU,GAAI,CAEtB,KAAK,QAAU,IAAI,IAGnB,KAAK,SAAW,IAAI,IAGpB,KAAK,SAAW,IAAI,IAGpB,KAAK,UAAY,IAAI,IAGrB,KAAK,QAAU,GAGf,KAAK,YAAcyF,EAAM,OAAOzF,EAAQ,WAAW,GAAK,EAAK,GAAK,EAAE,EAGpE,KAAK,gBAAkByF,EAAM,OAAOzF,EAAQ,SAAS,GAAK,IAAM,EAAG,CAAC,EAGpE,KAAK,aAAe,GAOpB,KAAK,kBAAoB,OAAOA,EAAQ,mBAAsB,WACxDA,EAAQ,kBACR,KAGN,KAAK,eAAiB,IAAI,IAI1B,KAAK,aAAekJ,EAAkB,EAItC,KAAK,cAAgBA,EAAkB,EAIvC,KAAK,mBAAqBA,EAAkB,EAI5C,KAAK,SAAW,KAEhB,KAAK,eAAiB,EAItB,KAAK,WAAa,IAAI,IAItB,KAAK,wBAA0B,KAE/B,KAAK,gBAAkB,KAEvB,KAAK,kBAAoB,KAEzB,KAAK,iBAAmB,KAGxB,KAAK,qBAAoB,EAGzB,KAAK,cAAgB,KAGjBlJ,EAAQ,sBAAwB,IAAS,OAAO,OAAW,KAC3D,KAAK,iBAAgB,EAGzB,QAAQ,IAAI,iCAAiC,CACjD,CAUA,kBAAmB,CACX,OAAO,OAAW,MAEtB,OAAO,mBAAqB,KAM5B,OAAO,mBAAsB6C,GAAY,CACjCA,GAAS,KAAK,YAAYA,CAAO,EACrC,KAAK,OAAM,CACf,EAKA,OAAO,oBAAsB,IAAM,CAC/B,KAAK,QAAO,CAChB,EAMA,OAAO,kBAAqBtD,GAAS,CACjC,KAAK,YAAYA,CAAI,CACzB,EAMA,OAAO,iBAAoBkJ,GAAS,CAChC,KAAK,UAAUC,EAAa,aAAcD,CAAI,CAClD,EAMA,OAAO,gBAAkB,IACd,KAAK,SAAQ,EAE5B,CAUA,sBAAuB,CAGnB,KAAK,SAAS,IAAI,WAAY,CAC1B,KAAM,YACN,YAAa,gDACb,SAAU,CACN,CAAE,KAAM,QAAS,OAAQ,UAAW,MAAO,IAAM,MAAO,CAAC,KAAM,GAAG,EAAG,UAAW,SAAS,EACzF,CAAE,KAAM,OAAQ,OAAQ,UAAW,MAAO,KAAO,MAAO,CAAC,KAAM,GAAG,EAAG,UAAW,SAAS,EACzF,CAAE,KAAM,MAAO,OAAQ,UAAW,MAAO,KAAO,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,EACxF,CAAE,KAAM,YAAa,OAAQ,QAAS,MAAO,GAAK,MAAO,CAAC,EAAG,CAAC,EAAG,UAAW,SAAS,CACrG,EACY,QAAS,CAACC,EAAa,YAAaA,EAAa,cAAc,EAC/D,UAAW,GACvB,CAAS,EAGD,KAAK,SAAS,IAAI,sBAAuB,CACrC,KAAM,uBACN,YAAa,mGACb,SAAU,CACN,CAAE,KAAM,QAAS,OAAQ,UAAW,MAAO,KAAO,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,EAC1F,CAAE,KAAM,MAAO,OAAQ,UAAW,MAAO,IAAM,MAAO,CAAC,MAAO,IAAI,EAAG,UAAW,SAAS,EACzF,CAAE,KAAM,OAAQ,OAAQ,UAAW,MAAO,IAAM,MAAO,CAAC,IAAM,EAAG,EAAG,UAAW,SAAS,EACxF,CAAE,KAAM,IAAK,OAAQ,YAAa,MAAO,GAAK,MAAO,CAAC,EAAK,GAAG,EAAG,UAAW,SAAS,EACrF,CAAE,KAAM,YAAa,OAAQ,YAAa,MAAO,GAAK,MAAO,CAAC,GAAK,CAAG,EAAG,UAAW,SAAS,CAC7G,EACY,QAAS,CAACA,EAAa,YAAaA,EAAa,WAAW,EAC5D,UAAW,EACvB,CAAS,EAGD,KAAK,SAAS,IAAI,YAAa,CAC3B,KAAM,aACN,YAAa,uEACb,SAAU,CACN,CAAE,KAAM,QAAS,OAAQ,UAAW,MAAO,EAAK,MAAO,CAAC,MAAO,IAAI,EAAG,UAAW,SAAS,EAC1F,CAAE,KAAM,MAAO,OAAQ,UAAW,MAAO,EAAK,MAAO,CAAC,MAAO,IAAI,EAAG,UAAW,SAAS,EACxF,CAAE,KAAM,OAAQ,OAAQ,UAAW,MAAO,EAAK,MAAO,CAAC,MAAO,IAAI,EAAG,UAAW,SAAS,EACzF,CAAE,KAAM,IAAK,OAAQ,UAAW,MAAO,GAAK,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,EACpF,CAAE,KAAM,IAAK,OAAQ,UAAW,MAAO,GAAK,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,EACpF,CAAE,KAAM,IAAK,OAAQ,UAAW,MAAO,GAAK,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,CACpG,EACY,QAAS,CAACA,EAAa,aAAcA,EAAa,OAAO,EACzD,UAAW,GACvB,CAAS,EAGD,KAAK,SAAS,IAAI,iBAAkB,CAChC,KAAM,mBACN,YAAa,gEACb,SAAU,CACN,CAAE,KAAM,QAAS,OAAQ,UAAW,MAAO,GAAK,MAAO,CAAC,KAAM,GAAG,EAAG,UAAW,KAAK,EACpF,CAAE,KAAM,MAAO,OAAQ,UAAW,MAAO,GAAK,MAAO,CAAC,KAAM,GAAG,EAAG,UAAW,KAAK,EAClF,CAAE,KAAM,OAAQ,OAAQ,UAAW,MAAO,GAAK,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,KAAK,EACnF,CAAE,KAAM,YAAa,OAAQ,cAAe,MAAO,IAAK,MAAO,CAAC,EAAG,CAAC,EAAG,UAAW,SAAS,EAC3F,CAAE,KAAM,WAAY,OAAQ,QAAS,MAAO,GAAK,MAAO,CAAC,EAAG,CAAC,EAAG,UAAW,SAAS,EACpF,CAAE,KAAM,IAAK,OAAQ,MAAO,MAAO,IAAK,MAAO,CAAC,EAAG,GAAG,EAAG,UAAW,KAAK,EACzE,CAAE,KAAM,IAAK,OAAQ,QAAS,MAAO,EAAK,MAAO,CAAC,GAAK,CAAG,EAAG,UAAW,SAAS,CACjG,EACY,QAAS,CAACA,EAAa,MAAOA,EAAa,IAAI,EAC/C,UAAW,GACvB,CAAS,EAGD,KAAK,SAAS,IAAI,YAAa,CAC3B,KAAM,aACN,YAAa,sEACb,SAAU,CACN,CAAE,KAAM,QAAS,OAAQ,UAAW,MAAO,GAAK,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,EACxF,CAAE,KAAM,OAAQ,OAAQ,UAAW,MAAO,GAAK,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,EACvF,CAAE,KAAM,MAAO,OAAQ,UAAW,MAAO,GAAK,MAAO,CAAC,KAAM,GAAG,EAAG,UAAW,SAAS,EACtF,CAAE,KAAM,IAAK,OAAQ,YAAa,MAAO,GAAK,MAAO,CAAC,EAAK,GAAG,EAAG,UAAW,KAAK,EACjF,CAAE,KAAM,YAAa,OAAQ,YAAa,MAAO,GAAK,MAAO,CAAC,GAAK,CAAG,EAAG,UAAW,SAAS,CAC7G,EACY,QAAS,CAACA,EAAa,cAAc,EACrC,UAAW,GACvB,CAAS,EAGD,KAAK,SAAS,IAAI,cAAe,CAC7B,KAAM,eACN,YAAa,uDACb,SAAU,CAEN,CAAE,KAAM,QAAS,OAAQ,UAAW,MAAO,EAAK,MAAO,CAAC,MAAO,IAAI,EAAG,UAAW,SAAS,EAC1F,CAAE,KAAM,MAAO,OAAQ,UAAW,MAAO,EAAK,MAAO,CAAC,MAAO,IAAI,EAAG,UAAW,SAAS,EACxF,CAAE,KAAM,OAAQ,OAAQ,UAAW,MAAO,EAAK,MAAO,CAAC,MAAO,IAAI,EAAG,UAAW,SAAS,EAEzF,CAAE,KAAM,IAAK,OAAQ,UAAW,MAAO,EAAK,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,EACpF,CAAE,KAAM,IAAK,OAAQ,UAAW,MAAO,EAAK,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,EACpF,CAAE,KAAM,IAAK,OAAQ,UAAW,MAAO,EAAK,MAAO,CAAC,GAAM,CAAG,EAAG,UAAW,SAAS,EAEpF,CAAE,KAAM,YAAa,OAAQ,YAAa,MAAO,GAAK,MAAO,CAAC,GAAK,CAAG,EAAG,UAAW,SAAS,EAC7F,CAAE,KAAM,WAAY,OAAQ,QAAS,MAAO,EAAK,MAAO,CAAC,GAAK,CAAG,EAAG,UAAW,SAAS,CACxG,EACY,QAAS,CAACA,EAAa,YAAaA,EAAa,UAAWA,EAAa,OAAO,EAChF,UAAW,GACvB,CAAS,CACL,CAmBA,UAAUnJ,EAAMR,EAAMC,EAAS,CAAA,EAAI,CAC/B,GAAI,CAACO,GAAQ,OAAOA,GAAS,SACzB,eAAQ,KAAK,+DAA+D,EACrE,GAEX,GAAI,CAAC,OAAO,OAAOmJ,CAAY,EAAE,SAAS3J,CAAI,EAC1C,eAAQ,KAAK,sDAAsDA,CAAI,GAAG,EACnE,GAEX,GAAI,KAAK,QAAQ,MAAQ8J,EACrB,eAAQ,KAAK,4DAA4D,EAClE,GAIP,KAAK,QAAQ,IAAItJ,CAAI,GACrB,KAAK,aAAaA,CAAI,EAI1B,MAAM6J,EAAQ,CACV,KAAA7J,EACA,KAAAR,EACA,OAAQ,CAAE,GAAGC,CAAM,EACnB,OAAQ,GACR,SAAU,IACtB,EAEQ,YAAK,QAAQ,IAAIO,EAAM6J,CAAK,EAGxB,KAAK,SACL,KAAK,uBAAuBA,CAAK,EAGrC,KAAK,MAAM,cAAe,CAAE,KAAA7J,EAAM,KAAAR,CAAI,CAAE,EACxC,QAAQ,IAAI,qCAAqCQ,CAAI,MAAMR,CAAI,GAAG,EAC3D,EACX,CAOA,aAAaQ,EAAM,CACf,MAAM6J,EAAQ,KAAK,QAAQ,IAAI7J,CAAI,EACnC,OAAK6J,GAEL,KAAK,uBAAuBA,CAAK,EACjC,KAAK,QAAQ,OAAO7J,CAAI,EAExB,KAAK,MAAM,gBAAiB,CAAE,KAAAA,EAAM,KAAM6J,EAAM,KAAM,EACtD,QAAQ,IAAI,uCAAuC7J,CAAI,GAAG,EACnD,IAPY,EAQvB,CAOA,UAAUA,EAAM,CACZ,OAAO,KAAK,QAAQ,IAAIA,CAAI,CAChC,CAMA,aAAc,CACV,MAAM8J,EAAO,CAAA,EACb,SAAW,CAAC9J,EAAM6J,CAAK,IAAK,KAAK,QAC7BC,EAAK,KAAK,CAAE,KAAA9J,EAAM,KAAM6J,EAAM,KAAM,OAAQA,EAAM,OAAQ,EAE9D,OAAOC,CACX,CAgBA,WAAWC,EAAYC,EAAa/D,EAAQ,EAAKgE,EAAa,KAAMC,EAAY,UAAW,CACvF,GAAI,CAACd,EAAa,SAASW,CAAU,EACjC,eAAQ,KAAK,gDAAgDA,CAAU,GAAG,EACnE,GAEX,GAAI,CAAC,KAAK,eAAeC,CAAW,EAChC,eAAQ,KAAK,kDAAkDA,CAAW,GAAG,EACtE,GAMX,GAJKnF,EAAY,SAASqF,CAAS,IAC/B,QAAQ,KAAK,sDAAsDA,CAAS,4BAA4B,EACxGA,EAAY,WAEZ,KAAK,SAAS,MAAQX,EACtB,eAAQ,KAAK,8DAA8D,EACpE,GAGX,MAAMlE,EAAM,GAAG0E,CAAU,KAAKC,CAAW,GAGnCH,EAAQ,CACV,KAAME,EACN,OAAQC,EACR,MAAO,OAAO,SAAS/D,CAAK,EAAIA,EAAQ,EACxC,MAAO,MAAM,QAAQgE,CAAU,GAAKA,EAAW,SAAW,EAAIA,EAAa,KAC3E,UAAAC,CACZ,EAEQ,YAAK,SAAS,IAAI7E,EAAKwE,CAAK,EAC5B,KAAK,MAAM,iBAAkBA,CAAK,EAC3B,EACX,CAQA,cAAcE,EAAYC,EAAa,CACnC,MAAM3E,EAAM,GAAG0E,CAAU,KAAKC,CAAW,GACnCG,EAAU,KAAK,SAAS,OAAO9E,CAAG,EACxC,OAAI8E,GACA,KAAK,MAAM,iBAAkB,CAAE,KAAMJ,EAAY,OAAQC,EAAa,EAEnEG,CACX,CAKA,eAAgB,CACZ,KAAK,SAAS,MAAK,EACnB,KAAK,MAAM,iBAAiB,CAChC,CAMA,cAAe,CACX,OAAO,MAAM,KAAK,KAAK,SAAS,OAAM,CAAE,CAC5C,CAeA,YAAYC,EAAa,CACrB,MAAM9G,EAAU,KAAK,SAAS,IAAI8G,CAAW,EAC7C,GAAI,CAAC9G,EACD,eAAQ,KAAK,oDAAoD8G,CAAW,GAAG,EACxE,GAIX,KAAK,cAAa,EAGd,OAAO9G,EAAQ,WAAc,WAC7B,KAAK,gBAAkB4C,EAAM5C,EAAQ,UAAW,EAAG,CAAC,GAIxD,UAAW+G,KAAK/G,EAAQ,SACpB,KAAK,WAAW+G,EAAE,KAAMA,EAAE,OAAQA,EAAE,MAAOA,EAAE,OAAS,KAAMA,EAAE,WAAa,SAAS,EAGxF,YAAK,cAAgBD,EACrB,KAAK,MAAM,gBAAiB,CAAE,KAAMA,EAAa,QAAA9G,EAAS,EAC1D,QAAQ,IAAI,uCAAuC8G,CAAW,GAAG,EAC1D,EACX,CAaA,cAAcpK,EAAMiH,EAAUqD,EAAO,CAAA,EAAI,CACrC,GAAI,CAACtK,GAAQ,OAAOA,GAAS,SACzB,eAAQ,KAAK,mEAAmE,EACzE,GAEX,GAAI,CAAC,MAAM,QAAQiH,CAAQ,GAAKA,EAAS,SAAW,EAChD,eAAQ,KAAK,sEAAsE,EAC5E,GAIX,MAAM3D,EAAU,CACZ,KAAMgH,EAAK,MAAQtK,EACnB,YAAasK,EAAK,aAAe,mBAAmBtK,CAAI,GACxD,SAAUiH,EAAS,IAAIoD,IAAM,CACzB,KAAMA,EAAE,KACR,OAAQA,EAAE,OACV,MAAO,OAAO,SAASA,EAAE,KAAK,EAAIA,EAAE,MAAQ,EAC5C,MAAO,MAAM,QAAQA,EAAE,KAAK,EAAIA,EAAE,MAAQ,KAC1C,UAAWA,EAAE,WAAa,SAC1C,EAAc,EACF,QAAS,MAAM,QAAQC,EAAK,OAAO,EAAIA,EAAK,QAAU,CAAA,EACtD,UAAW,OAAOA,EAAK,WAAc,SAAWpE,EAAMoE,EAAK,UAAW,EAAG,CAAC,EAAI,KAAK,eAC/F,EAEQ,YAAK,SAAS,IAAItK,EAAMsD,CAAO,EAC/B,KAAK,MAAM,iBAAkB,CAAE,KAAAtD,EAAM,QAAAsD,CAAO,CAAE,EAC9C,QAAQ,IAAI,wCAAwCtD,CAAI,GAAG,EACpD,EACX,CAOA,cAAcA,EAAM,CAEhB,MADgB,CAAC,WAAY,sBAAuB,YAAa,iBAAkB,YAAa,aAAa,EACjG,SAASA,CAAI,GACrB,QAAQ,KAAK,qEAAqEA,CAAI,GAAG,EAClF,IAEJ,KAAK,SAAS,OAAOA,CAAI,CACpC,CAMA,cAAe,CACX,OAAO,MAAM,KAAK,KAAK,SAAS,KAAI,CAAE,CAC1C,CAOA,WAAWA,EAAM,CACb,MAAMuK,EAAI,KAAK,SAAS,IAAIvK,CAAI,EAChC,OAAOuK,EAAI,CAAE,GAAGA,EAAG,SAAUA,EAAE,SAAS,IAAIF,IAAM,CAAE,GAAGA,CAAC,EAAG,CAAC,EAAK,IACrE,CAUA,gBAAgBrK,EAAM,CACd,OAAOA,GAAS,UAAYA,EAAK,OAAS,GAC1C,KAAK,eAAe,IAAIA,CAAI,CAEpC,CAMA,mBAAmBA,EAAM,CACrB,KAAK,eAAe,OAAOA,CAAI,CACnC,CAQA,eAAeA,EAAM,CACjB,OAAO2E,EAAsB,SAAS3E,CAAI,GAAK,KAAK,eAAe,IAAIA,CAAI,CAC/E,CASA,QAAS,CACL,GAAI,MAAK,QAET,MAAK,QAAU,GACf,KAAK,eAAiB,YAAY,IAAG,EAGrC,UAAW6J,KAAS,KAAK,QAAQ,OAAM,EACnC,KAAK,uBAAuBA,CAAK,EAIrC,KAAK,eAAc,EAEnB,KAAK,MAAM,SAAS,EACpB,QAAQ,IAAI,6BAA6B,EAC7C,CAKA,SAAU,CACN,GAAK,KAAK,QAEV,MAAK,QAAU,GAGX,KAAK,WAAa,OAClB,qBAAqB,KAAK,QAAQ,EAClC,KAAK,SAAW,MAIpB,UAAWA,KAAS,KAAK,QAAQ,OAAM,EACnC,KAAK,uBAAuBA,CAAK,EAGrC,KAAK,MAAM,UAAU,EACrB,QAAQ,IAAI,8BAA8B,EAC9C,CAMA,WAAY,CACR,OAAO,KAAK,OAChB,CAUA,eAAepH,EAAO,CAClB,KAAK,YAAcyD,EAAM,OAAOzD,CAAK,GAAK,EAAK,GAAK,EAAE,CAC1D,CAMA,aAAaA,EAAO,CAChB,KAAK,gBAAkByD,EAAM,OAAOzD,CAAK,GAAK,IAAM,EAAG,CAAC,CAC5D,CAOA,iBAAiBkD,EAAMlD,EAAO,CACtB2G,EAAa,SAASzD,CAAI,GAC1B,KAAK,UAAU,IAAIA,EAAMO,EAAM,OAAOzD,CAAK,GAAK,EAAG,EAAG,CAAC,CAAC,CAEhE,CAMA,gBAAgBoD,EAAS,CACrB,KAAK,aAAe,CAAC,CAACA,EACtB,KAAK,MAAM,sBAAuB,KAAK,YAAY,EACnD,QAAQ,IAAI,qCAAqC,KAAK,aAAe,KAAO,KAAK,EAAE,CACvF,CAMA,qBAAqBY,EAAI,CACrB,KAAK,kBAAoB,OAAOA,GAAO,WAAaA,EAAK,IAC7D,CAsBA,UAAU+D,EAAYtB,EAAM,CACxB,GAAI,GAACA,GAAQ,OAAOA,GAAS,UAE7B,OAAQsB,EAAU,CACd,KAAKrB,EAAa,aACd,KAAK,qBAAqBD,CAAI,EAC9B,MACJ,KAAKC,EAAa,YACd,KAAK,mBAAmBD,CAAI,EAC5B,MACJ,KAAKC,EAAa,eACd,KAAK,sBACD,OAAOD,EAAK,CAAC,GAAK,EAClB,OAAOA,EAAK,CAAC,GAAK,EAClBA,EAAK,QAAU,OAAO,OAAW,IAAc,OAAO,WAAa,MACnEA,EAAK,SAAW,OAAO,OAAW,IAAc,OAAO,YAAc,KACzF,EACgB,MACJ,KAAKC,EAAa,UACd,KAAK,kBAAkBD,CAAI,EAC3B,MACJ,KAAKC,EAAa,QACd,KAAK,gBAAgBD,CAAI,EACzB,MACJ,KAAKC,EAAa,YACd,KAAK,oBAAoBD,CAAI,EAC7B,MACJ,KAAKC,EAAa,MACd,KAAK,qBACD,OAAOD,EAAK,IAAI,GAAK,EACrB,OAAOA,EAAK,GAAG,GAAK,EACpB,OAAOA,EAAK,IAAI,GAAK,CACzC,EACgB,MACJ,KAAKC,EAAa,KACd,KAAK,aACD,OAAOD,EAAK,OAAO,GAAK,EACxB,OAAOA,EAAK,EAAE,GAAK,EACnB,OAAOA,EAAK,KAAK,GAAK,CAC1C,EACgB,MACJ,QACI,QAAQ,KAAK,sDAAsDsB,CAAU,GAAG,CAChG,CACI,CAUA,UAAW,CACP,MAAO,CAAE,GAAG,KAAK,aAAa,CAClC,CAMA,aAAc,CACV,MAAO,CAAE,GAAG,KAAK,YAAY,CACjC,CAUA,cAAe,CACX,MAAO,CACH,QAAS,MACT,YAAa,KAAK,YAClB,gBAAiB,KAAK,gBACtB,aAAc,KAAK,aACnB,cAAe,KAAK,cACpB,QAAS,KAAK,YAAW,EACzB,SAAU,KAAK,aAAY,EAC3B,cAAe,MAAM,KAAK,KAAK,cAAc,EAC7C,cAAe,OAAO,YAAY,KAAK,SAAS,CAC5D,CACI,CAQA,aAAa/K,EAAQ,CACjB,GAAI,CAACA,GAAU,OAAOA,GAAW,SAC7B,eAAQ,KAAK,iDAAiD,EACvD,GAGX,GAAI,CAaA,GAXI,OAAO,SAASA,EAAO,WAAW,GAClC,KAAK,eAAeA,EAAO,WAAW,EAEtC,OAAO,SAASA,EAAO,eAAe,GACtC,KAAK,aAAaA,EAAO,eAAe,EAExC,OAAOA,EAAO,cAAiB,WAC/B,KAAK,gBAAgBA,EAAO,YAAY,EAIxC,MAAM,QAAQA,EAAO,aAAa,EAAG,CACrC,KAAK,eAAe,MAAK,EACzB,UAAW,KAAKA,EAAO,cACnB,KAAK,gBAAgB,CAAC,CAE9B,CAGA,GAAIA,EAAO,eAAiB,OAAOA,EAAO,eAAkB,SAAU,CAClE,KAAK,UAAU,MAAK,EACpB,SAAW,CAACkG,EAAM9C,CAAG,IAAK,OAAO,QAAQpD,EAAO,aAAa,EACzD,KAAK,iBAAiBkG,EAAM9C,CAAG,CAEvC,CAGA,GAAI,MAAM,QAAQpD,EAAO,OAAO,EAAG,CAE/B,UAAWO,KAAQ,MAAM,KAAK,KAAK,QAAQ,KAAI,CAAE,EAC7C,KAAK,aAAaA,CAAI,EAE1B,UAAWyK,KAAKhL,EAAO,QACfgL,EAAE,MAAQA,EAAE,MACZ,KAAK,UAAUA,EAAE,KAAMA,EAAE,KAAMA,EAAE,QAAU,EAAE,CAGzD,CAGA,GAAI,MAAM,QAAQhL,EAAO,QAAQ,EAAG,CAChC,KAAK,cAAa,EAClB,UAAW4K,KAAK5K,EAAO,SACnB,KAAK,WAAW4K,EAAE,KAAMA,EAAE,OAAQA,EAAE,MAAOA,EAAE,MAAOA,EAAE,SAAS,CAEvE,CAIA,OAAI5K,EAAO,eAAiB,KAAK,SAAS,IAAIA,EAAO,aAAa,GAC9D,KAAK,YAAYA,EAAO,aAAa,EAGzC,KAAK,MAAM,iBAAkBA,CAAM,EACnC,QAAQ,IAAI,qCAAqC,EAC1C,EACX,OAASiL,EAAK,CACV,eAAQ,MAAM,uDAAwDA,CAAG,EAClE,EACX,CACJ,CAUA,gBAAiB,CACR,KAAK,UACV,KAAK,SAAW,sBAAuBC,GAAO,KAAK,SAASA,CAAE,CAAC,EACnE,CAOA,SAAS5K,EAAW,CAChB,GAAI,CAAC,KAAK,QAAS,OAEnB,MAAM6K,EAAY,KAAK,KAAK7K,EAAY,KAAK,gBAAkB,IAAM,EAAG,EACxE,KAAK,eAAiBA,EAGtB,KAAK,aAAY,EAGjB,KAAK,aAAa6K,CAAS,EAG3B,KAAK,eAAc,CACvB,CAcA,aAAaA,EAAW,CACpB,MAAM9K,EAAK,OAAO,SAAS8K,CAAS,GAAKA,EAAY,EAAIA,EAAY,oBAK/DC,EAAe,KAAK,KACtB,KAAK,aAAa,MAAQ,KAAK,aAAa,MAC5C,KAAK,aAAa,IAAM,KAAK,aAAa,IAC1C,KAAK,aAAa,KAAO,KAAK,aAAa,KAC3C,KAAK,aAAa,EAAI,KAAK,aAAa,EACxC,KAAK,aAAa,EAAI,KAAK,aAAa,EACxC,KAAK,aAAa,EAAI,KAAK,aAAa,CACpD,EACQ,KAAK,aAAa,UAAY3E,EAAM2E,EAAe,KAAK,MAAO,EAAG,CAAC,EAGnE,UAAWlF,KAAQyD,EAAc,CAM7B,MAAM0B,EAAa,GALJ,KAAK,UAAU,IAAInF,CAAI,EAChC,KAAK,UAAU,IAAIA,CAAI,EACvB,KAAK,iBAKX,KAAK,cAAcA,CAAI,EAAI+D,EACvB,KAAK,cAAc/D,CAAI,EACvB,KAAK,aAAaA,CAAI,EACtBO,EAAM4E,EAAY,EAAG,CAAC,CACtC,CACQ,CAGA,IAAIC,EAAc,EAClB,UAAWpF,IAAQ,CAAC,QAAS,MAAO,OAAQ,IAAK,IAAK,GAAG,EAAG,CACxD,MAAMyB,EAAQ,KAAK,cAAczB,CAAI,EAAI,KAAK,mBAAmBA,CAAI,EACrEoF,GAAe3D,EAAQA,CAC3B,CACA,KAAK,cAAc,SAAWlB,EAAM,KAAK,KAAK6E,CAAW,GAAKjL,EAAK,IAAK,EAAG,CAAC,EAG5E,OAAO,OAAO,KAAK,mBAAoB,KAAK,aAAa,EAGzD,KAAK,eAAc,CACvB,CAOA,gBAAiB,CACb,GAAI,CAAC,KAAK,kBAAmB,OAI7B,MAAMkL,EAAc,IAAI,IAExB,UAAWrH,KAAW,KAAK,SAAS,OAAM,EAAI,CAI1C,IAAIlB,GAHa,KAAK,cAAckB,EAAQ,IAAI,GAAK,GAG9BA,EAAQ,MAAQ,KAAK,YAa5C,GAVI,KAAK,eACLlB,GAAS4G,GAIT1F,EAAQ,QACRlB,EAAQyD,EAAMzD,EAAOkB,EAAQ,MAAM,CAAC,EAAGA,EAAQ,MAAM,CAAC,CAAC,GAIvD,CAAC,OAAO,SAASlB,CAAK,EAAG,SAE7B,MAAMsD,EAAOpC,EAAQ,WAAa,UAC5BsH,EAAWD,EAAY,IAAIrH,EAAQ,MAAM,EAE/C,GAAI,CAACsH,EACDD,EAAY,IAAIrH,EAAQ,OAAQ,CAAE,MAAAlB,EAAO,KAAAsD,EAAM,MAG/C,QAAQA,EAAI,CACR,IAAK,MACDkF,EAAS,OAASxI,EAClB,MACJ,IAAK,WACDwI,EAAS,OAASxI,EAClB,MACJ,IAAK,MACDwI,EAAS,MAAQ,KAAK,IAAIA,EAAS,MAAOxI,CAAK,EAC/C,MACJ,IAAK,MACDwI,EAAS,MAAQ,KAAK,IAAIA,EAAS,MAAOxI,CAAK,EAC/C,MACJ,IAAK,UACL,QACIwI,EAAS,MAAQxI,EACjB,KACxB,CAEQ,CAGA,SAAW,CAACoB,EAAO,CAAE,MAAApB,CAAK,CAAE,IAAKuI,EAC7B,GAAI,CACA,KAAK,kBAAkBnH,EAAOpB,CAAK,CACvC,OAASiI,EAAK,CACV,QAAQ,MAAM,iDAAiD7G,CAAK,IAAK6G,CAAG,CAChF,CAER,CAWA,uBAAuBb,EAAO,CAC1B,GAAI,SAAO,OAAW,KAEtB,OAAQA,EAAM,KAAI,CACd,KAAKV,EAAa,YACd,KAAK,kBAAkBU,CAAK,EAC5B,MACJ,KAAKV,EAAa,eACd,KAAK,qBAAqBU,CAAK,EAC/B,MACJ,KAAKV,EAAa,UACd,KAAK,iBAAiBU,CAAK,EAC3B,MACJ,KAAKV,EAAa,QAEdU,EAAM,SAAW,KACjB,MACJ,KAAKV,EAAa,YAClB,KAAKA,EAAa,aAClB,KAAKA,EAAa,MAClB,KAAKA,EAAa,KAEdU,EAAM,SAAW,KACjB,KAChB,CACI,CAOA,uBAAuBA,EAAO,CACtB,OAAOA,EAAM,UAAa,aAC1BA,EAAM,SAAQ,EACdA,EAAM,SAAW,KAEzB,CAOA,kBAAkBA,EAAO,CACrB,GAAI,OAAO,OAAW,IAAa,OAEnC,MAAMqB,EAAWhL,GAAU,CAClB2J,EAAM,QACX,KAAK,mBAAmB3J,CAAK,CACjC,EAGI,OAAO,uBAA2B,KAClC,OAAO,uBAAuB,mBAAsB,WACpD,uBAAuB,kBAAiB,EACnC,KAAMiL,GAAe,CACdA,IAAe,UACf,OAAO,iBAAiB,oBAAqBD,CAAO,EAEpD,QAAQ,KAAK,0DAA0D,CAE/E,CAAC,EACA,MAAOR,GAAQ,CACZ,QAAQ,KAAK,0DAA2DA,CAAG,CAC/E,CAAC,EAEL,OAAO,iBAAiB,oBAAqBQ,CAAO,EAGxDrB,EAAM,SAAW,IAAM,CACnB,OAAO,oBAAoB,oBAAqBqB,CAAO,CAC3D,CACJ,CAOA,qBAAqBrB,EAAO,CACxB,GAAI,OAAO,OAAW,IAAa,OAEnC,MAAMuB,EAAUvB,EAAM,OAAO,SAAW,OAClCqB,EAAWhL,GAAU,CAClB2J,EAAM,QACX,KAAK,sBACD3J,EAAM,QACNA,EAAM,QACN,OAAO,WACP,OAAO,WACvB,CACQ,EAEAkL,EAAQ,iBAAiB,YAAaF,CAAO,EAC7CrB,EAAM,SAAW,IAAM,CACnBuB,EAAQ,oBAAoB,YAAaF,CAAO,CACpD,CACJ,CAOA,iBAAiBrB,EAAO,CACpB,GAAI,OAAO,OAAW,KAAe,OAAO,OAAO,UAAc,IAAa,CAC1E,QAAQ,KAAK,iDAAiD,EAC9D,MACJ,CAEA,GAAI,CACA,MAAMwB,EAAYxB,EAAM,OAAO,WAAa,GACtCyB,EAAS,IAAI,OAAO,UAAU,CAAE,UAAAD,CAAS,CAAE,EAEjDC,EAAO,iBAAiB,UAAW,IAAM,CAChCzB,EAAM,QACX,KAAK,kBAAkB,CACnB,EAAGyB,EAAO,EACV,EAAGA,EAAO,EACV,EAAGA,EAAO,CAC9B,CAAiB,CACL,CAAC,EAEDA,EAAO,iBAAiB,QAAUpL,GAAU,CACxC,QAAQ,KAAK,sCAAuCA,EAAM,KAAK,CACnE,CAAC,EAEDoL,EAAO,MAAK,EACZ,KAAK,iBAAmBA,EAExBzB,EAAM,SAAW,IAAM,CACnByB,EAAO,KAAI,EACX,KAAK,iBAAmB,IAC5B,CACJ,OAASZ,EAAK,CACV,QAAQ,KAAK,qDAAsDA,CAAG,CAC1E,CACJ,CAMA,cAAe,CACX,UAAWb,KAAS,KAAK,QAAQ,OAAM,EACnC,GAAKA,EAAM,OAEX,OAAQA,EAAM,KAAI,CACd,KAAKV,EAAa,QACd,KAAK,aAAaU,CAAK,EACvB,KAEpB,CAEI,CAOA,aAAaA,EAAO,CAChB,GAAI,OAAO,UAAc,KAAe,OAAO,UAAU,aAAgB,WAAY,OAErF,MAAM0B,EAAW,UAAU,YAAW,EAChC5K,EAAQkJ,EAAM,OAAO,OAAS,EAC9B2B,EAAUD,EAAS5K,CAAK,EAE1B,CAAC6K,GAAW,CAACA,EAAQ,WAEzB,KAAK,gBAAgBA,EAAS3B,EAAM,MAAM,CAC9C,CAiBA,mBAAmB3J,EAAO,CACtB,MAAMuI,EAAQ,OAAOvI,EAAM,KAAK,GAAK,EAC/BwI,EAAO,OAAOxI,EAAM,IAAI,GAAK,EAC7ByI,EAAQ,OAAOzI,EAAM,KAAK,GAAK,EAGrC,KAAK,aAAa,MAAQgG,EAAMwC,EAAO,GAAI,GAAI,CAAC,EAChD,KAAK,aAAa,KAAOxC,EAAMyC,EAAQ,GAAI,GAAI,CAAC,EAChD,KAAK,aAAa,IAAMzC,GAAOuC,EAAQ,KAAO,IAAK,GAAI,CAAC,CAC5D,CAcA,sBAAsBhB,EAAGC,EAAG+D,EAAOC,EAAQ,CACvC,MAAMC,EAAI,OAAOF,CAAK,IAAM,OAAO,OAAW,IAAc,OAAO,WAAa,MAC1EG,EAAI,OAAOF,CAAM,IAAM,OAAO,OAAW,IAAc,OAAO,YAAc,MAElF,GAAIC,IAAM,GAAKC,IAAM,EAAG,OAGxB,MAAMC,EAAQ3F,GAAQuB,EAAIkE,EAAK,IAAO,EAAG,GAAI,CAAC,EACxCG,EAAQ5F,GAAQwB,EAAIkE,EAAK,IAAO,EAAG,GAAI,CAAC,EAE9C,KAAK,aAAa,KAAOC,EACzB,KAAK,aAAa,MAAQ,CAACC,CAE/B,CAeA,kBAAkB5L,EAAO,CACrB,MAAM6L,EAAK,OAAO7L,EAAM,CAAC,GAAK,EACxB8L,EAAK,OAAO9L,EAAM,CAAC,GAAK,EACxB+L,EAAK,OAAO/L,EAAM,CAAC,GAAK,EAGxB+F,EAAQ,GAERiG,EAAQ,IAEd,KAAK,aAAa,MAAQhG,EAAM,KAAK,aAAa,MAAQgG,EAAQH,EAAK9F,EAAO,GAAI,CAAC,EACnF,KAAK,aAAa,KAAOC,EAAM,KAAK,aAAa,KAAOgG,EAAQF,EAAK/F,EAAO,GAAI,CAAC,EACjF,KAAK,aAAa,IAAMC,EAAM,KAAK,aAAa,IAAMgG,EAAQD,EAAKhG,EAAO,GAAI,CAAC,CACnF,CAkBA,gBAAgBuF,EAAS/L,EAAS,GAAI,CAClC,MAAM0M,EAAW,OAAO1M,EAAO,QAAQ,GAAK,GACtC2M,EAAOZ,EAAQ,MAAQ,CAAA,EACvBa,EAAUb,EAAQ,SAAW,CAAA,EAO7Bc,EAAiBzM,GACZ,KAAK,IAAIA,CAAC,EAAIsM,EAAW,EAAItM,EAgBxC,GAZIuM,EAAK,QAAU,IACf,KAAK,aAAa,KAAOlG,EAAMoG,EAAcF,EAAK,CAAC,CAAC,EAAG,GAAI,CAAC,EAC5D,KAAK,aAAa,MAAQlG,EAAMoG,EAAc,CAACF,EAAK,CAAC,CAAC,EAAG,GAAI,CAAC,GAI9DA,EAAK,QAAU,IACf,KAAK,aAAa,IAAMlG,EAAMoG,EAAcF,EAAK,CAAC,CAAC,EAAG,GAAI,CAAC,EAC3D,KAAK,aAAa,EAAIlG,EAAMoG,EAAc,CAACF,EAAK,CAAC,CAAC,EAAG,GAAI,CAAC,GAI1DC,EAAQ,QAAU,EAAG,CACrB,MAAME,EAAK,OAAOF,EAAQ,CAAC,GAAM,SAAWA,EAAQ,CAAC,EAAE,MAAQ,OAAOA,EAAQ,CAAC,CAAC,GAAK,EAC/EG,EAAK,OAAOH,EAAQ,CAAC,GAAM,SAAWA,EAAQ,CAAC,EAAE,MAAQ,OAAOA,EAAQ,CAAC,CAAC,GAAK,EACrF,KAAK,aAAa,EAAInG,EAAMsG,EAAKD,EAAI,GAAI,CAAC,CAC9C,CACJ,CAiBA,oBAAoBrD,EAAM,CAClB,OAAO,SAASA,EAAK,KAAK,IAC1B,KAAK,aAAa,MAAQhD,EAAMgD,EAAK,MAAO,GAAI,CAAC,GAEjD,OAAO,SAASA,EAAK,GAAG,IACxB,KAAK,aAAa,IAAMhD,EAAMgD,EAAK,IAAK,GAAI,CAAC,GAE7C,OAAO,SAASA,EAAK,IAAI,IACzB,KAAK,aAAa,KAAOhD,EAAMgD,EAAK,KAAM,GAAI,CAAC,GAE/C,OAAO,SAASA,EAAK,CAAC,IACtB,KAAK,aAAa,EAAIhD,EAAMgD,EAAK,EAAG,GAAI,CAAC,GAEzC,OAAO,SAASA,EAAK,CAAC,IACtB,KAAK,aAAa,EAAIhD,EAAMgD,EAAK,EAAG,GAAI,CAAC,GAEzC,OAAO,SAASA,EAAK,CAAC,IACtB,KAAK,aAAa,EAAIhD,EAAMgD,EAAK,EAAG,GAAI,CAAC,EAEjD,CAmBA,qBAAqBb,EAAMC,EAAKC,EAAM,CAClC,MAAMvF,EAAIkD,EAAMmC,EAAM,EAAG,CAAC,EACpBgC,EAAInE,EAAMoC,EAAK,EAAG,CAAC,EACnBsD,EAAI1F,EAAMqC,EAAM,EAAG,CAAC,EACpBC,GAAUxF,EAAIqH,EAAIuB,GAAK,EAIvB3J,EAAI,OAAO,YAAgB,IAAc,YAAY,IAAG,EAAK,KAAQ,KAAK,IAAG,EAAK,KAExF,KAAK,aAAa,MAAQiE,EAAM,KAAK,IAAIjE,EAAI,GAAG,EAAIe,EAAG,GAAI,CAAC,EAC5D,KAAK,aAAa,IAAMkD,EAAM,KAAK,IAAIjE,EAAI,EAAG,EAAIoI,EAAG,GAAI,CAAC,EAC1D,KAAK,aAAa,KAAOnE,EAAM,KAAK,IAAIjE,EAAI,GAAG,EAAI2J,EAAG,GAAI,CAAC,EAC3D,KAAK,aAAa,EAAI1F,EAAM,KAAK,IAAIjE,EAAI,EAAG,EAAIuG,EAAQ,GAAI,CAAC,EAC7D,KAAK,aAAa,EAAItC,EAAMsC,EAAS,EAAI,EAAG,GAAI,CAAC,CACrD,CAoBA,aAAaiE,EAASC,EAAIjK,EAAO,CAE7B,MAAMkK,EAAOzG,EAAOzD,EAAQ,KAAQ,EAAK,GAAI,CAAC,EAI9C,OAAQiK,EAAE,CACN,IAAK,GACD,KAAK,aAAa,MAAQC,EAC1B,MACJ,IAAK,GACD,KAAK,aAAa,IAAMA,EACxB,MACJ,IAAK,IACD,KAAK,aAAa,KAAOA,EACzB,MACJ,IAAK,IACD,KAAK,aAAa,EAAIA,EACtB,MACJ,IAAK,IACD,KAAK,aAAa,EAAIA,EACtB,MACJ,IAAK,GACD,KAAK,aAAa,EAAIA,EACtB,MACJ,QAAS,CAGL,MAAMC,EAAYF,EAAK,EACjBN,EAAO,CAAC,QAAS,MAAO,OAAQ,IAAK,IAAK,GAAG,EACnD,KAAK,aAAaA,EAAKQ,CAAS,CAAC,EAAID,EACrC,KACJ,CACZ,CAEQ,KAAK,MAAM,YAAa,CAAE,QAAAF,EAAS,GAAAC,EAAI,MAAAjK,EAAO,WAAYkK,EAAM,CACpE,CASA,qBAAqBzD,EAAM,CACvB,UAAWvD,KAAQyD,EACX,OAAO,SAASF,EAAKvD,CAAI,CAAC,IACtBA,IAAS,aAAeA,IAAS,WACjC,KAAK,aAAaA,CAAI,EAAIO,EAAMgD,EAAKvD,CAAI,EAAG,EAAG,CAAC,EAEhD,KAAK,aAAaA,CAAI,EAAIO,EAAMgD,EAAKvD,CAAI,EAAG,GAAI,CAAC,EAIjE,CAWA,GAAGzF,EAAOC,EAAU,CACZ,OAAOA,GAAa,aACnB,KAAK,WAAW,IAAID,CAAK,GAC1B,KAAK,WAAW,IAAIA,EAAO,CAAA,CAAE,EAEjC,KAAK,WAAW,IAAIA,CAAK,EAAE,KAAKC,CAAQ,EAC5C,CAOA,IAAID,EAAOC,EAAU,CACjB,GAAI,CAAC,KAAK,WAAW,IAAID,CAAK,EAAG,OACjC,MAAM2M,EAAM,KAAK,WAAW,IAAI3M,CAAK,EAC/BwC,EAAMmK,EAAI,QAAQ1M,CAAQ,EAC5BuC,IAAQ,IACRmK,EAAI,OAAOnK,EAAK,CAAC,CAEzB,CAQA,MAAMxC,EAAOgJ,EAAM,CACf,GAAK,KAAK,WAAW,IAAIhJ,CAAK,EAC9B,UAAWuG,KAAM,KAAK,WAAW,IAAIvG,CAAK,EACtC,GAAI,CACAuG,EAAGyC,CAAI,CACX,OAASwB,EAAK,CACV,QAAQ,MAAM,gDAAgDxK,CAAK,IAAKwK,CAAG,CAC/E,CAER,CAUA,SAAU,CACN,KAAK,QAAO,EAGZ,UAAW1K,KAAQ,MAAM,KAAK,KAAK,QAAQ,KAAI,CAAE,EAC7C,KAAK,aAAaA,CAAI,EAG1B,KAAK,SAAS,MAAK,EACnB,KAAK,WAAW,MAAK,EACrB,KAAK,eAAe,MAAK,EACzB,KAAK,UAAU,MAAK,EAGhB,OAAO,OAAW,MACd,OAAO,qBAAuB,MAC9B,OAAO,OAAO,mBAElB,OAAO,OAAO,mBACd,OAAO,OAAO,oBACd,OAAO,OAAO,kBACd,OAAO,OAAO,iBACd,OAAO,OAAO,iBAGlB,QAAQ,IAAI,+BAA+B,CAC/C,CACJ,CCltDO,MAAM8M,CAAe,CACxB,aAAc,CACV,KAAK,KAAO,EACZ,KAAK,OAAS,EACd,KAAK,cAAgB,IACrB,KAAK,UAAY,EACrB,CAEA,OAAQ,CACJ,KAAK,UAAY,GACjB,KAAK,UAAY,KAAK,IAAG,CAC7B,CAEA,MAAO,CACH,KAAK,UAAY,EACrB,CAQA,OAAOlC,EAAW,CACd,GAAI,CAAC,KAAK,UAAW,MAAO,GAO5B,MAAMmC,GALM,KAAK,IAAG,EACE,KAAK,WAGF,KAAK,cAAiB,KAAK,cAC9B,KAAK,GAAK,EAIhC,YAAK,QAAU,EAAM,KAAK,IAAIA,CAAK,GAAK,GAKjC,KAAK,MAChB,CAEA,WAAY,CACR,OAAO,KAAK,MAChB,CACJ,CCjCO,MAAMC,CAAW,CAOpB,YAAYvM,EAAU,GAAI,CACtB,KAAK,aAAe,KACpB,KAAK,kBAAoBA,EAAQ,QAAU,UAC3C,KAAK,WAAa,IAAIwM,EACtB,KAAK,YAAc,GACnB,KAAK,cAAgB,KAGrB,KAAK,aAAexM,EAAQ,eAAiB,GAG7C,KAAK,MAAQA,EAAQ,OAAS,GAG9B,KAAK,SAAW,IAAIqM,EAGpB,KAAK,WAAa,IAAItG,EAAkB,CAACxG,EAAMyC,IAAU,CACrD,KAAK,WAAW,aAAazC,EAAMyC,CAAK,EACxC,KAAK,8BAA6B,CACtC,CAAC,EAGD,KAAK,aAAe,IAAImH,EAAmB,CACvC,YAAanJ,EAAQ,oBAAsB,EAC3C,UAAWA,EAAQ,kBAAoB,IACvC,kBAAmB,CAACT,EAAMyC,IAAU,CAChC,KAAK,WAAW,aAAazC,EAAMyC,CAAK,EACxC,KAAK,8BAA6B,CACtC,CACZ,CAAS,EAGGhC,EAAQ,kBACR,KAAK,WAAW,WAAWA,EAAQ,gBAAgB,EAInDA,EAAQ,gBACR,KAAK,aAAa,YAAYA,EAAQ,cAAc,CAE5D,CAKA,MAAM,WAAWH,EAAc,iBAAkB,CAC7C,QAAQ,IAAI,2BAA2B,EAGvC,GAAI,CACA,KAAK,cAAgB,IAAI0D,EAAc1D,CAAW,CACtD,OAAS4M,EAAO,CACZ,eAAQ,MAAM,uCAAwCA,CAAK,EACpD,EACX,CAIA,OADiB,MAAM,KAAK,aAAa,KAAK,iBAAiB,GAO/D,KAAK,WAAW,kBAAkB,KAAK,WAAW,iBAAgB,CAAE,EAGpE,KAAK,SAAS,MAAK,EAGnB,KAAK,iBAAgB,EAErB,KAAK,YAAc,GACnB,QAAQ,IAAI,0BAA0B,EAC/B,KAfH,QAAQ,MAAM,kDAAkD,KAAK,iBAAiB,GAAG,EAClF,GAef,CAEA,kBAAmB,CACf,KAAK,kBAAoB,GACzB,MAAMC,EAAO,IAAM,CACf,GAAK,KAAK,kBACV,IAAI,KAAK,YAAa,CAElB,MAAM3J,EAAS,KAAK,SAAS,OAAM,EAG/B,KAAK,cAAgB,KAAK,aAAa,kBACvC,KAAK,aAAa,iBAAiB,CAAE,OAAAA,CAAM,CAAE,CAErD,CACA,KAAK,aAAe,sBAAsB2J,CAAI,EAClD,EACA,KAAK,aAAe,sBAAsBA,CAAI,CAClD,CAMA,MAAM,aAAalJ,EAAY,CAC3B,QAAQ,IAAI,YAAYA,CAAU,YAAY,EAG9C,MAAMC,EAAY,KAAK,cAAc,qBAAqBD,CAAU,EAEpE,IAAImJ,EAAS,KACb,GAAI,CACA,OAAQnJ,EAAU,CACd,IAAK,UAED,GADAmJ,EAAS,IAAIC,EACT,KAAK,aAAc,CACnB,GAAI,CAKA,GAJiB,MAAMD,EAAO,eAAe,CACzC,aAAc,GACd,MAAO,KAAK,KAC5C,CAA6B,EACa,CACV,QAAQ,IAAI,+BAA+B,EAC3C,KACJ,CACJ,MAAa,CAAqB,CAClC,QAAQ,KAAK,sDAAsD,EACnEA,EAAS,IAAIC,CACjB,CACA,MAEJ,IAAK,UAED,GADAD,EAAS,IAAIE,EACT,KAAK,aAAc,CACnB,MAAM/I,EAAS,SAAS,eAAe,gBAAgB,EACvD,GAAIA,EAAQ,CACR,GAAI,CAKA,GAJiB,MAAM6I,EAAO,eAAe7I,EAAQ,CACjD,aAAc,GACd,MAAO,KAAK,KAChD,CAAiC,EACa,CACV,QAAQ,IAAI,+BAA+B,EAC3C,KACJ,CACJ,MAAa,CAAqB,CAClC,QAAQ,KAAK,sDAAsD,EACnE6I,EAAS,IAAIE,CACjB,CACJ,CAGA,GAAI,CADmB,MAAMF,EAAO,WAAU,EAE1C,MAAM,IAAI,MAAM,sCAAsC,EAE1D,MAEJ,IAAK,cAED,GADAA,EAAS,IAAIG,EACT,KAAK,aAAc,CACnB,GAAI,CAKA,GAJiB,MAAMH,EAAO,eAAe,CACzC,aAAc,GACd,MAAO,KAAK,KAC5C,CAA6B,EACa,CACV,QAAQ,IAAI,mCAAmC,EAC/C,KACJ,CACJ,MAAa,CAAqB,CAClC,QAAQ,KAAK,0DAA0D,EACvEA,EAAS,IAAIG,CACjB,CACA,MAEJ,QACI,MAAM,IAAI,MAAM,mBAAmBtJ,CAAU,EAAE,CACnE,CAGY,OAAAC,EAAU,QAAQI,GAAY,CAC1B,MAAMC,EAAS,SAAS,eAAeD,CAAQ,EAC/C,GAAIC,EAAQ,CACR,MAAMC,EAAKD,EAAO,WAAW,OAAO,GAAKA,EAAO,WAAW,QAAQ,EAC/DC,GACA,KAAK,cAAc,gBAAgBF,EAAUE,CAAE,CAEvD,CACJ,CAAC,EAGD4I,EAAO,iBAAiB,KAAK,WAAW,iBAAgB,CAAE,EAC1DA,EAAO,UAAU,EAAI,EAErB,QAAQ,IAAI,GAAGnJ,CAAU,+BAA+B,EACjDmJ,CAEX,OAASF,EAAO,CACZ,cAAQ,MAAM,GAAGjJ,CAAU,2BAA4BiJ,CAAK,EACtDA,CACV,CACJ,CAMA,MAAM,aAAajJ,EAAY,CAC3B,GAAI,CAAC,CAAC,UAAW,UAAW,aAAa,EAAE,SAASA,CAAU,EAC1D,eAAQ,MAAM,kBAAmBA,CAAU,EACpC,GAGX,QAAQ,IAAI,kBAAkB,KAAK,iBAAiB,OAAOA,CAAU,EAAE,EAGnE,KAAK,eACD,KAAK,aAAa,WAClB,KAAK,aAAa,UAAU,EAAK,EAEjC,KAAK,aAAa,SAClB,KAAK,aAAa,QAAO,EAE7B,KAAK,aAAe,MAIxB,GAAI,CACA,YAAK,aAAe,MAAM,KAAK,aAAaA,CAAU,EACtD,KAAK,kBAAoBA,EACzB,QAAQ,IAAI,eAAeA,CAAU,SAAS,EACvC,EACX,OAASiJ,EAAO,CACZ,eAAQ,MAAM,uBAAuBjJ,CAAU,IAAKiJ,CAAK,EAClD,EACX,CACJ,CAMA,sBAAuB,CACnB,OAAI,KAAK,cAAgB,KAAK,aAAa,eAChC,KAAK,aAAa,eAAc,EAEpC,IACX,CAKA,+BAAgC,CAC5B,MAAMjM,EAAS,KAAK,WAAW,iBAAgB,EAW/C,GATI,KAAK,cAAgB,KAAK,aAAa,iBACvC,KAAK,aAAa,iBAAiBA,CAAM,EAClC,KAAK,OAAS,KAAK,cAAgB,CAAC,KAAK,aAAa,iBAC7D,QAAQ,KAAK,sEAAsE,EAC5E,KAAK,OAAS,CAAC,KAAK,cAC3B,QAAQ,KAAK,mFAAmF,EAIhG,KAAK,qBAAuB,KAAK,oBAAoB,KAAO,EAC5D,UAAWuM,KAAY,KAAK,oBACxB,GAAI,CAAEA,EAASvM,CAAM,CAAG,MAAY,CAAuB,CAGvE,CAKA,aAAajB,EAAMyC,EAAO,CACtB,KAAK,WAAW,aAAazC,EAAMyC,CAAK,EACxC,KAAK,WAAW,iBAAiBzC,EAAMyC,CAAK,EAC5C,KAAK,8BAA6B,CACtC,CAKA,cAAcxB,EAAQ,CAClB,KAAK,WAAW,cAAcA,CAAM,EACpC,KAAK,WAAW,kBAAkBA,CAAM,EACxC,KAAK,8BAA6B,CACtC,CAKA,aAAajB,EAAM,CACf,OAAO,KAAK,WAAW,aAAaA,CAAI,CAC5C,CAKA,kBAAmB,CACf,OAAO,KAAK,WAAW,iBAAgB,CAC3C,CAKA,cAAe,CACX,KAAK,WAAW,aAAY,EAC5B,KAAK,8BAA6B,CACtC,CAKA,UAAW,CACP,KAAK,WAAW,gBAAe,EAC/B,KAAK,8BAA6B,CACtC,CAKA,kBAAmB,CACf,OAAO,KAAK,iBAChB,CAKA,yBAA0B,CACtB,OAAO,KAAK,YAChB,CAUA,sBAAuB,CACnB,OAAO,KAAK,UAChB,CAOA,qBAAqBP,EAAQ,CACzB,OAAO,KAAK,WAAW,WAAWA,CAAM,CAC5C,CAMA,qBAAsB,CAClB,OAAO,KAAK,WAAW,UAAS,CACpC,CAKA,iBAAkB,CACd,KAAK,WAAW,kBAAkB,KAAK,WAAW,iBAAgB,CAAE,EACpE,KAAK,WAAW,MAAK,CACzB,CAKA,gBAAiB,CACb,KAAK,WAAW,KAAI,CACxB,CAMA,oBAAqB,CACjB,OAAO,KAAK,WAAW,QAC3B,CASA,cAAc4I,EAAMC,EAAKC,EAAMC,EAAQ,CACnC,KAAK,WAAW,cAAcH,EAAMC,EAAKC,EAAMC,CAAM,CACzD,CAQA,aAAaC,EAAOC,EAAMC,EAAO,CAC7B,KAAK,WAAW,aAAaF,EAAOC,EAAMC,CAAK,CACnD,CASA,cAAclB,EAAGC,EAAGkB,EAAY,EAAGC,EAAY,EAAG,CAC9C,KAAK,WAAW,cAAcpB,EAAGC,EAAGkB,EAAWC,CAAS,CAC5D,CAMA,aAAanF,EAAY,EAAK,CAC1B,KAAK,WAAW,aAAaA,CAAS,CAC1C,CAMA,eAAe0D,EAAO,CAClB,KAAK,WAAW,eAAeA,CAAK,CACxC,CAQA,cAAc0B,EAASC,EAAa,EAAGC,EAAW,EAAG,CACjD,KAAK,WAAW,cAAcF,EAASC,EAAYC,CAAQ,CAC/D,CAUA,uBAAwB,CACpB,OAAO,KAAK,YAChB,CAOA,mBAAmB1F,EAAU,WAAY,CACrC,YAAK,aAAa,YAAYA,CAAO,EACrC,KAAK,aAAa,OAAM,EACjB,EACX,CAKA,qBAAsB,CAClB,KAAK,aAAa,QAAO,CAC7B,CAMA,kBAAkBA,EAAS,CACvB,KAAK,aAAa,YAAYA,CAAO,CACzC,CAMA,iBAAiB4F,EAAM,CACnB,KAAK,aAAa,UAAU,eAAgBA,CAAI,CACpD,CAMA,sBAAsBzG,EAAO,CACzB,KAAK,aAAa,eAAeA,CAAK,CAC1C,CAMA,uBAAuBoD,EAAS,CAC5B,KAAK,aAAa,gBAAgBA,CAAO,CAC7C,CASA,kBAAmB,CACf,MAAO,CAEH,cACA,YACA,SACA,QACA,eACA,UACA,OACA,UAEA,iCACA,+BACA,4BACA,2BACA,2BACA,6BACA,0BACA,6BAEA,sCACA,oCACA,iCACA,gCACA,gCACA,kCACA,+BACA,iCACZ,CACI,CAKA,aAAc,CACV,MAAO,CACH,OAAQ,KAAK,kBACb,WAAY,KAAK,WAAW,iBAAgB,EAC5C,WAAY,KAAK,WAAW,UAAS,EACrC,iBAAkB,KAAK,WAAW,SAClC,aAAc,KAAK,aAAa,aAAY,EAC5C,cAAe,KAAK,aAAa,QACjC,QAAS,KAAK,qBAAoB,EAClC,UAAW,IAAI,KAAI,EAAG,YAAW,EACjC,QAAS,OACrB,CACI,CAKA,MAAM,YAAY4H,EAAO,CACrB,GAAI,CAACA,GAAS,OAAOA,GAAU,SAAU,CACrC,QAAQ,KAAK,gDAAgD,EAC7D,MACJ,CAGA,GAAI,CAEA,GADmB,KAAK,UAAUA,CAAK,EACxB,OAAS,IAAM,KAAM,CAChC,QAAQ,KAAK,yDAAyD,EACtE,MACJ,CACJ,MAAQ,CACJ,QAAQ,KAAK,yDAAyD,EACtE,MACJ,CAGA,MAAMC,EAAW,CAACzI,EAAK0I,EAAQ,IAAM,CAEjC,GADIA,EAAQ,GACR,CAAC1I,GAAO,OAAOA,GAAQ,SAAU,OAAO0I,EAC5C,IAAIC,EAAMD,EACV,UAAW9N,KAAK,OAAO,OAAOoF,CAAG,EAE7B,GADA2I,EAAM,KAAK,IAAIA,EAAKF,EAAS7N,EAAG8N,EAAQ,CAAC,CAAC,EACtCC,EAAM,EAAG,OAAOA,EAExB,OAAOA,CACX,EACA,GAAIF,EAASD,CAAK,EAAI,EAAG,CACrB,QAAQ,KAAK,kEAAkE,EAC/E,MACJ,CAKA,GAHIA,EAAM,QAAU,OAAOA,EAAM,QAAW,UACxC,MAAM,KAAK,aAAaA,EAAM,MAAM,EAEpCA,EAAM,YAAc,OAAOA,EAAM,YAAe,UAAY,CAAC,MAAM,QAAQA,EAAM,UAAU,EAAG,CAE9F,MAAMI,EAAa,CAAA,EACnB,SAAW,CAACxI,EAAK5C,CAAK,IAAK,OAAO,QAAQgL,EAAM,UAAU,EAClD,OAAOhL,GAAU,UAAY,OAAO,SAASA,CAAK,IAClDoL,EAAWxI,CAAG,EAAI5C,GAG1B,KAAK,WAAW,cAAcoL,CAAU,EACxC,KAAK,WAAW,kBAAkBA,CAAU,EAC5C,KAAK,8BAA6B,CACtC,CACIJ,EAAM,YAAc,OAAOA,EAAM,YAAe,UAAY,CAAC,MAAM,QAAQA,EAAM,UAAU,GAC3F,KAAK,WAAW,WAAWA,EAAM,UAAU,EAE3CA,EAAM,kBACN,KAAK,gBAAe,EAEpBA,EAAM,cAAgB,OAAOA,EAAM,cAAiB,UACpD,KAAK,aAAa,aAAaA,EAAM,YAAY,EAEjDA,EAAM,eACN,KAAK,aAAa,OAAM,CAEhC,CAYA,yBAA0B,CACtB,MAAO,CAACzN,EAAMyC,IAAU,KAAK,aAAazC,EAAMyC,CAAK,CACzD,CAOA,WAAY,CACR,OAAO,KAAK,SAAS,UAAS,CAClC,CAQA,kBAAkBtC,EAAU,CACxB,OAAK,KAAK,sBACN,KAAK,oBAAsB,IAAI,KAEnC,KAAK,oBAAoB,IAAIA,CAAQ,EAC9B,IAAM,KAAK,oBAAoB,OAAOA,CAAQ,CACzD,CAKA,SAAU,CAEN,KAAK,kBAAoB,GACrB,KAAK,eACL,qBAAqB,KAAK,YAAY,EACtC,KAAK,aAAe,MAGxB,KAAK,SAAS,KAAI,EAGd,KAAK,cACL,KAAK,aAAa,QAAO,EAIzB,KAAK,YACL,KAAK,WAAW,QAAO,EAIvB,KAAK,cAAgB,KAAK,aAAa,SACvC,KAAK,aAAa,QAAO,EAE7B,KAAK,aAAe,KAGhB,KAAK,eACL,KAAK,cAAc,QAAO,EAE9B,KAAK,cAAgB,KAErB,KAAK,YAAc,GACnB,QAAQ,IAAI,wBAAwB,CACxC,CACJ,CCvsBO,MAAM2N,CAAa,CAItB,YAAYxN,EAAc,gBAAiB,CACvC,KAAK,aAAe,IAAIf,EACxB,KAAK,WAAa,IAAIc,EAAeC,CAAW,EAChD,KAAK,OAAS,IAAI,GACtB,CAKA,OAAQ,CACJ,KAAK,aAAa,MAAK,CAC3B,CAKA,MAAO,CACH,KAAK,aAAa,KAAI,CAC1B,CAWA,MAAM,WAAWb,EAAS,GAAI,CAC1B,MAAMsO,EAAU,SAAS,KAAK,IAAG,CAAE,IAAI,KAAK,MAAM,KAAK,OAAM,EAAK,GAAI,CAAC,GAGjEC,EAAY,SAAS,cAAc,KAAK,EAC9CA,EAAU,GAAK,aAAaD,CAAO,GACnCC,EAAU,MAAM,MAAQ,OACxBA,EAAU,MAAM,OAAS,OACzBA,EAAU,MAAM,cAAgB,OAGhC,KAAK,WAAW,YAAYD,EAASC,EAAWvO,EAAO,OAAS,EAAE,EAGlE,MAAM4D,EAAS,IAAI2J,EAAW,CAC1B,OAAQvN,EAAO,QAAU,cACzB,aAAc,EAC1B,CAAS,EAID,MAAM4D,EAAO,WAAW2K,EAAU,EAAE,EAGhCvO,EAAO,WAAa,QACpB4D,EAAO,aAAa,WAAY5D,EAAO,QAAQ,EAInD,MAAMwO,EAAQ,IAAI7K,EAAUC,EAAQ5D,EAAO,aAAe,SAAS,EACnE,OAAAwO,EAAM,GAAKF,EAGX,KAAK,aAAa,SAAS,IAAIA,EAASE,CAAK,EAC7C,KAAK,OAAO,IAAIF,EAASE,CAAK,EAE9B,QAAQ,IAAI,+BAA+BF,CAAO,EAAE,EAC7CE,CACX,CAMA,aAAaF,EAAS,CAClB,MAAME,EAAQ,KAAK,OAAO,IAAIF,CAAO,EACjCE,IAEA,KAAK,aAAa,KAAKF,CAAO,EAG1BE,EAAM,QAAUA,EAAM,OAAO,SAC7BA,EAAM,OAAO,QAAO,EAIxB,KAAK,WAAW,eAAeF,CAAO,EACtC,KAAK,OAAO,OAAOA,CAAO,EAE1B,QAAQ,IAAI,iCAAiCA,CAAO,EAAE,EAE9D,CACJ"}